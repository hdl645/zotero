<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=Big5">


<meta name="wpd_version" content="0.2">
<meta name="wpd_baseurl" content="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00078.html">
<meta name="wpd_url" content="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00078.html">
<meta name="wpd_date" content="2008-06-03T02:57Z">
<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: ipsec NAT pass through rule(s)? -->
<!--X-From-R13: "enooghk enooghk" <enooghkNtznvy.pbz> -->
<!--X-Date: 11 Dec 2006 12:51:10 &#45;0500 -->
<!--X-Message-Id: 5cc9c8f90612110950x3ec0dbd0g6497c87182edc866@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 5cc9c8f90612091547r4dd21922i8bf63d84b9c59c8@mail.gmail.com -->
<!--X-Reference: 1165747742.5125.15.camel@anduril.intranet.cartel&#45;securite.net -->
<!--X-Reference: 5cc9c8f90612102233g68f9b03o88e68614d0082445@mail.gmail.com -->
<!--X-Reference: 1165830405.28768.38.camel@anduril.intranet.cartel&#45;securite.net -->
<!--X-Head-End-->



<title>Re: ipsec NAT pass through rule(s)?</title>

<link rev="made" href="mailto:rabbtux@gmail.com">
<link rel="start" href="http://www.securepoint.com/lists/html/NetFilter/">
<link rel="contents" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/threads.html#00078">
<link rel="index" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/index.html#00078">
<link rel="prev" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">
<link rel="next" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00086.html">

<link rel="stylesheet" type="text/css" href="msg00078.css" media="all">
</head>
<body>
<center>
<div class="msgTitle">
<span class="listTitle"><strong>NetFilter</strong></span>
</div>
<div class="metaIdxNav">
<nobr>[<a href="http://www.securepoint.com/lists/html/NetFilter/">Top</a>]</nobr>
<nobr>[<a href="http://www.securepoint.com/lists/html">All&nbsp;Lists</a>]</nobr>
</div>
</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<center>
<div class="topLinks">
<table class="mainNav" width="100%">
<tbody><tr>
<td width="33%" align="left"><span class="topDateNav"><nobr><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00077.html">&lt;prev</a>&nbsp;<strong>[<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/index.html#00078">Date</a>]</strong>&nbsp;<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00079.html">next&gt;</a></nobr></span></td>
<td width="34%" align="center"><form method="get" action="http://www.securepoint.com/lists/cgi-bin/namazu.cgi"><nobr><input name="query" size="20" type="text"><input name="submit" value="Search" type="submit"></nobr><input name="idxname" value="NetFilter" type="hidden">
<small><nobr>[<a href="http://www.securepoint.com/lists/cgi-bin/namazu.cgi?idxname=NetFilter">Advanced</a>]</nobr></small></form>
</td>
<td width="33%" align="right"><span class="topThreadNav"><nobr><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">&lt;prev</a>&nbsp;<strong>[<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/threads.html#00078">Thread</a>]</strong>&nbsp;<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00086.html">next&gt;</a></nobr></span></td>
</tr>
</tbody></table>
</div>
</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<div class="msgSubject">
<h2>Re: ipsec NAT pass through rule(s)?</h2>
<div class="msgLinks">
<table width="100%">
<tbody><tr valign="baseline">
<td align="left"><span class="authorLink">from
[<a href="http://www.securepoint.com/lists/cgi-bin/namazu.cgi?query=%2Bfrom%3Arabbtux%40gmail.com&idxname=NetFilter&sort=date%3Alate"><em>rabbtux rabbtux</em></a>]</span></td>
<td align="right"><span class="bookmarkLink">[<a href="http://www.securepoint.com/lists/cgi-bin/mesg.cgi?a=NetFilter&i=5cc9c8f90612110950x3ec0dbd0g6497c87182edc866%40mail.gmail.com">Permanent&nbsp;Link</a>]</span><span class="orgLink">[<a href="http://www.securepoint.com/lists/cgi-bin/extract-mesg.cgi?a=NetFilter&m=2006-12&i=5cc9c8f90612110950x3ec0dbd0g6497c87182edc866%40mail.gmail.com">Original</a>]</span></td>
</tr></tbody></table>
</div>
</div>
<div class="msgHead">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table>
<tbody><tr valign="baseline">
<th align="right">
<strong>To</strong>: </th>
<td align="left">

"Cedric Blancher" &lt;<a href="mailto:blancher%40cartel-securite.fr">blancher@cartel-securite.fr</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Subject</strong>: </th>
<td align="left">

Re: ipsec NAT pass through rule(s)?</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>From</strong>: </th>
<td align="left">

"rabbtux rabbtux" &lt;<a href="mailto:rabbtux%40gmail.com">rabbtux@gmail.com</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Date</strong>: </th>
<td align="left">

Mon, 11 Dec 2006 09:50:41 -0800</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Cc</strong>: </th>
<td align="left">
<a href="mailto:netfilter%40lists.netfilter.org">netfilter@lists.netfilter.org</a></td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Delivered-to</strong>: </th>
<td align="left">
<a href="mailto:sp-com-lists%40consult.net">sp-com-lists@consult.net</a></td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Delivered-to</strong>: </th>
<td align="left">
<a href="mailto:netfilter-list1%40securepoint.com">netfilter-list1@securepoint.com</a></td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Domainkey-signature</strong>: </th>
<td align="left">

a=rsa-sha1; q=dns; c=nofws; s=beta; d=gmail.com;	h=received:message-id:date:from:to:subject:cc:in-reply-to:mime-version:content-type:content-transfer-encoding:content-disposition:references;	b=HVIkYDhl80S8PPDlszbH1GbShgkQd9sPYlTHQhtm9+IGY9X9z+Q/3haBTXFGSsNzrl28XZKnXipzrF9bVwqR8yEeqxW0LlvqxrzNdHZ0vLc2vU2Da1OFH0eRRXSX1dO8sqpgtDuMq7XPbu1Mt97dn54TxTczH9+ZJkrDEa+o4lg=</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>In-reply-to</strong>: </th>
<td align="left">

&lt;<a href="mailto:1165830405.28768.38.camel%40anduril.intranet.cartel-securite.net"></a><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">1165830405.28768.38.camel@anduril.intranet.cartel-securite.net</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-archive</strong>: </th>
<td align="left">

&lt;/pipermail/netfilter&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-help</strong>: </th>
<td align="left">

&lt;<a href="mailto:netfilter-request@lists.netfilter.org?subject=help">mailto:netfilter-request@lists.netfilter.org?subject=help</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-id</strong>: </th>
<td align="left">

General discussion and user questions &lt;netfilter.lists.netfilter.org&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-post</strong>: </th>
<td align="left">

&lt;<a href="mailto:netfilter@lists.netfilter.org">mailto:netfilter@lists.netfilter.org</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-subscribe</strong>: </th>
<td align="left">

&lt;<a href="https://lists.netfilter.org/mailman/listinfo/netfilter">https://lists.netfilter.org/mailman/listinfo/netfilter</a>&gt;,	&lt;<a href="mailto:netfilter-request@lists.netfilter.org?subject=subscribe">mailto:netfilter-request@lists.netfilter.org?subject=subscribe</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>List-unsubscribe</strong>: </th>
<td align="left">

&lt;<a href="https://lists.netfilter.org/mailman/listinfo/netfilter">https://lists.netfilter.org/mailman/listinfo/netfilter</a>&gt;,	&lt;<a href="mailto:netfilter-request@lists.netfilter.org?subject=unsubscribe">mailto:netfilter-request@lists.netfilter.org?subject=unsubscribe</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>References</strong>: </th>
<td align="left">

&lt;<a href="mailto:5cc9c8f90612091547r4dd21922i8bf63d84b9c59c8%40mail.gmail.com"></a><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00056.html">5cc9c8f90612091547r4dd21922i8bf63d84b9c59c8@mail.gmail.com</a>&gt;	&lt;<a href="mailto:1165747742.5125.15.camel%40anduril.intranet.cartel-securite.net"></a><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00057.html">1165747742.5125.15.camel@anduril.intranet.cartel-securite.net</a>&gt;	&lt;<a href="mailto:5cc9c8f90612102233g68f9b03o88e68614d0082445%40mail.gmail.com"></a><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00068.html">5cc9c8f90612102233g68f9b03o88e68614d0082445@mail.gmail.com</a>&gt;	&lt;<a href="mailto:1165830405.28768.38.camel%40anduril.intranet.cartel-securite.net"></a><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">1165830405.28768.38.camel@anduril.intranet.cartel-securite.net</a>&gt;</td>
</tr>

<tr valign="baseline">
<th align="right">
<strong>Sender</strong>: </th>
<td align="left">
<a href="mailto:netfilter-bounces%40lists.netfilter.org">netfilter-bounces@lists.netfilter.org</a></td>
</tr>

</tbody></table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="msgBody">
<table width="100%" cellspacing="1"><tbody><tr><td>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Thanks for your patience with me :-)
I am ISP for a few customers and all customers are on a private
network behind my iptables firewall.  Some customer residential
routers have a 'feature' checkbox for IPSEC pass through that I don't
understand but want to be sure my firewall can do the same thing.

Customer's IT people ask, "is your ipsec, or vpn pass-thru box
checked?" so I need to know what iptables rules that linksys/dlink
have behind this 'feature'.

Thank you kindly,
marshall

On 12/11/06, Cedric Blancher &lt;blancher@cartel-securite.fr&gt; wrote:
</pre><blockquote style="border-left: 0.2em solid rgb(85, 85, 238); margin: 0em; padding-left: 0.85em;"><pre style="margin: 0em;">Le dimanche 10 d&eacute;cembre 2006 &agrave; 22:33 -0800, rabbtux rabbtux a &eacute;crit :
&gt; Cedric,  I understand how to do nat to IPSEC ports and all others.  My
&gt; question is about any special rules required so that the encrypted
&gt; ipsec TCP headers don't get mangled?

TCP headers can't get mangled as they're protected by ESP. That's the
whole point of IPSEC ;) BTW, your question seems more about "how to NAT
IPSEC" than Netfilter related. Basicly, there are two situations in
which you'll break things NATing IPSEC:

        1. AH. As AH protects whole IPSEC packet including IP header,
           NATing such packets will break AH verification. Therefore, AH
           does not cope with NAT at all.

        2. TCP in ESP transport mode. As transport mode only
           encapsulates IP payload (e.g. TCP, UDP, ICMP layers) and
           TCP checksum is computed with IP addresses, crossing NAT will
           break TCP checksum verification as it is protected by ESP (so
           you can't mangle it to reflect your NAT). Therefore, ESP
           transport mode does not cope with NAT, unless you disable TCP
           checksum verification, which is a pretty bad idea to me.

So, at the end of the day, if you want IPSEC to cross NAT, your only
option is ESP tunnel mode only[1]. And it won't affect Netfilter ruleset
in any way as most packet is encrypted. The only thing Netfilter could
do about IPSEC is looking at SPI to ensure there's no SPI collision
between two concurrent IPSEC tunnels with the same external gateway, but
it won't help much in the end if it happens...


[1] NAT-T being ESP tunnel mode over UDP for gateways refusing other IP
    protocols than TCP/UDP/ICMP.

--
<a rel="nofollow" href="http://sid.rstack.org/">http://sid.rstack.org/</a>
PGP KeyID: 157E98EE FingerPrint: FA62226DA9E72FA8AECAA240008B480E157E98EE
&gt;&gt; Hi! I'm your friendly neighbourhood signature virus.
&gt;&gt; Copy me to your signature file and help me spread!

</pre></blockquote><pre style="margin: 0em;">

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</td></tr></tbody></table>
</div>
<div class="msgLinks">
<table width="100%">
<tbody><tr valign="baseline">
<td align="center"><span class="subjectLink">[<a href="http://www.securepoint.com/lists/cgi-bin/namazu.cgi?query=%2Bsubject:%2F%5E%28%3F:%5E%5Cs%2A%28re%7Csv%7Cfwd%7Cfw%29%5B%5C%5B%5C%5D%5Cd%5D%2A%5B:%3E-%5D%2B%5Cs%2A%29%2Aipsec%5Cs%2BNAT%5Cs%2Bpass%5Cs%2Bthrough%5Cs%2Brule%5C%28s%5C%29%5C%3F%5Cs%2A%24%2F&idxname=NetFilter&sort=date%3Alate">More&nbsp;with&nbsp;this&nbsp;subject...</a>]</span></td>
</tr></tbody></table>
</div>
<div class="tSlice">
<table width="100%" cellpadding="4" cellspacing="1">
<tbody><tr valign="baseline">
<td align="left"><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html"><strong>&lt;Prev&nbsp;in&nbsp;Thread</strong></a>]</td>
<th width="100%" align="center"><strong>Current&nbsp;Thread</strong></th>
<td align="right">[<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00086.html"><strong>Next&nbsp;in&nbsp;Thread&gt;</strong></a>
</td></tr>
<tr class="tSliceList"><td colspan="3">
<ul>
<li><b><a name="00056" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00056.html">ipsec NAT pass through rule(s)?</a></b>, <i>rabbtux rabbtux</i>
<ul>
<li><b><a name="00057" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00057.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>Cedric Blancher</i>
<ul>
<li><b><a name="00068" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00068.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>rabbtux rabbtux</i>
<ul>
<li><b><a name="00070" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>Cedric Blancher</i>
</li><li><span class="sliceCur"><strong>Re: ipsec NAT pass through rule(s)?</strong>,
<em>rabbtux rabbtux</em>&nbsp;<b></b></span><b>&lt;=</b>
</li><li><b><a name="00086" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00086.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>Cedric Blancher</i>
</li><li><b><a name="00095" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00095.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>rabbtux rabbtux</i>
</li><li><b><a name="00097" href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00097.html">Re: ipsec NAT pass through rule(s)?</a></b>, <i>Cedric Blancher</i>
</li>




</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</td></tr>
</tbody></table></div>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="botLinks">
<table width="100%">
<tbody><tr valign="baseline">
<th align="right">Previous&nbsp;by&nbsp;Date:&nbsp;</th>
<td width="100%"><strong><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00077.html">Re: Problem with re-directing from 2 sources to one server</a></strong>, <em>Richmond Dyes</em></td>
</tr>
<tr valign="baseline">
<th align="right">Next&nbsp;by&nbsp;Date:&nbsp;</th>
<td width="100%"><strong><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00079.html">Re: Problem with re-directing from 2 sources to one server</a></strong>, <em>Richmond Dyes</em></td>
</tr>
<tr valign="baseline">
<th align="right">Previous&nbsp;by&nbsp;Thread:&nbsp;</th>
<td width="100%"><strong><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00070.html">Re: ipsec NAT pass through rule(s)?</a></strong>, <em>Cedric Blancher</em></td>
</tr>
<tr valign="baseline">
<th align="right">Next&nbsp;by&nbsp;Thread:&nbsp;</th>
<td width="100%"><strong><a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/msg00086.html">Re: ipsec NAT pass through rule(s)?</a></strong>, <em>Cedric Blancher</em></td>
</tr>
<tr valign="baseline">
<th align="right">Indexes:&nbsp;</th>
<td>[<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/index.html#00078"><strong>Date</strong></a>]
[<a href="http://www.securepoint.com/lists/html/NetFilter/2006-12/threads.html#00078"><strong>Thread</strong></a>]
[<a href="http://www.securepoint.com/lists/html/NetFilter/"><strong>Top</strong></a>]
[<a href="http://www.securepoint.com/lists/html"><strong>All&nbsp;Lists</strong></a>]</td>
</tr>
</tbody></table>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
