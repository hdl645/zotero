<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>

<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">


<meta name="wpd_version" content="0.2">
<meta name="wpd_baseurl" content="http://www.jacco2.dds.nl/networking/freeswan-l2tp.html">
<meta name="wpd_url" content="http://www.jacco2.dds.nl/networking/freeswan-l2tp.html">
<meta name="wpd_date" content="2008-06-03T02:00Z">



  
  <title>Using a Linux L2TP/IPsec VPN server</title>
  <meta name="keywords" content="Linux, Openswan, strongSwan, FreeS/WAN, freeswan, L2TP, l2tpd, rp-l2tp, IPsec, VPN, Road Warrior, Windows, Panther, Tiger, RPM">
</head>
<body>
<h2>Using a Linux L2TP/IPsec VPN server<br>
</h2>
<table width="100%" border="0" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top"><a href="http://www.openswan.org/"><img src="openswan.logo.jpg" title="The Openswan logo by Nana Manojlovic" alt="" width="87" border="0" height="76"></a></td>
      <td valign="top" align="center">
      <div align="right"><i>I heartily endorse&nbsp; <br>
this gigantic book! &nbsp;</i> </div>
      </td>
      <td valign="top" align="left"><a href="http://www.packtpub.com/book/openswan/mid/061205jqdnh2"><img src="1904811256.png" title="Order your copy from Packt Publishing" alt="" width="100" align="top" border="0" height="123"></a></td>
      <td valign="top" align="right"><a href="http://www.strongswan.org/"><img title="The strongSwan logo" alt="" src="strongswan_100.png" width="100" align="top" border="0" height="66"></a></td>
    </tr>
  </tbody>
</table>
<hr size="2" width="100%">
<a href="http://t.extreme-dm.com/?login=l2tp" target="_top"><img src="i.gif" name="EXim" alt="eXTReMe Tracker" width="41" align="left" border="0" height="38"></a>
<script type="text/javascript" language="javascript1.2"><!--
	EXs=screen;EXw=EXs.width;navigator.appName!="Netscape"?
	EXb=EXs.colorDepth:EXb=EXs.pixelDepth;//-->
	</script>
<script type="text/javascript"><!--
	var EXlogin='l2tp' // Login
	var EXvsrv='s9' // VServer
	navigator.javaEnabled()==1?EXjv="y":EXjv="n";
	EXd=document;EXw?"":EXw="na";EXb?"":EXb="na";
	EXd.write("<img src=http://e0.extreme-dm.com",
	"/"+EXvsrv+".g?login="+EXlogin+"&",
	"jv="+EXjv+"&j=y&srw="+EXw+"&srb="+EXb+"&",
	"l="+escape(EXd.referrer)+" height=1 width=1>");//-->
	</script><img src="s9.g" width="1" height="1"><noscript><img
 alt="" src="http://e0.extreme-dm.com/s9.g?login=l2tp&j=n&jv=n"
 height="1" width="1"></noscript>
<div align="right"><i>Last update: Jun 22, 2008</i><br>
</div>
<br>
<br>
<a name="Introduction"></a><b>1.1 Introduction</b>
<p>This webpage contains information on how to use L2TP/IPsec clients
from
Microsoft, Apple and other vendors in a '<a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/intro.html#road.intro">Road
Warrior</a>' setup connecting to a Linux VPN server based on FreeS/WAN
or its successors. <a href="http://www.freeswan.org/">FreeS/WAN</a> is
an IPsec
implementation for Linux 2.x kernels, released under the <a href="http://www.gnu.org/licenses/gpl.html">GNU Public Licence</a>.
FreeS/WAN has been succeeded by <a href="http://www.openswan.org/">Openswan</a>
and <a href="http://www.strongswan.org/">strongSwan</a>.
The main advantage of such a setup is cost: if you use the free clients
that are included with Windows and Mac OS X, you don't have to spend
money on third-party VPN
clients or servers. Obviously you still need OS
licences for those clients if you want to be legal.</p>
<p><a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/intro.html#ipsec.intro">IPsec</a>
is a network protocol for secure communication. It's an official
Internet standard. Clients and devices from different vendors should
interoperate (in theory), as long as they adhere to the IPsec standard.
More background information on IPsec can be found in this <a href="http://www.unixwiz.net/techtips/iguide-ipsec.html">illustrated
guide to IPsec</a>. The following L2TP/IPsec clients are supported by
the setup described
on this webpage:<br>
<br>
</p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top"><b>Windows 2000</b> and <b>Windows
XP</b></td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html">Using
a Linux L2TP/IPsec VPN server with Windows 2000/XP<br>
      </a></td>
    </tr>
    <tr>
      <td valign="top"><b>Windows Vista</b><br>
      </td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/vista-openswan.html">Using
a Linux L2TP/IPsec VPN server with Windows Vista</a></td>
    </tr>
    <tr>
      <td valign="top"><b>Windows 95 / 98 /
Me / NT4</b></td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/msl2tp.html">Using a Linux server with
the Microsoft L2TP/IPSec VPN Client</a></td>
    </tr>
    <tr>
      <td valign="top"><b>SSH
Sentinel</b>, <b>Forticlient</b> and <b>SafeNet SoftRemote</b></td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/l2tp3rdparty.html">Using
a Linux server with third-party L2TP/IPsec clients</a></td>
    </tr>
    <tr>
      <td valign="top"><b>Windows Mobile 6, Windows Mobile 5.0</b> and <b>Pocket
PC 2003</b><b><br>
      </b></td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/openswan-pocketpc.html">Using
a Linux L2TP/IPsec VPN server with Windows Mobile</a></td>
    </tr>
    <tr>
      <td valign="top"><b>Mac OS X v10.3 Panther</b> and higher<b><br>
      </b></td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html">Using
a Linux L2TP/IPsec VPN server with Mac OS X<br>
      </a></td>
    </tr>
    <tr>
      <td valign="top"><b>Linux</b><br>
      </td>
      <td valign="top"><a href="http://www.jacco2.dds.nl/networking/linux-l2tp.html">Using Linux as an
L2TP/IPsec client</a><br>
      </td>
    </tr>
  </tbody>
</table>
<p><br>
Windows 2000/XP/Vista, Pocket PC 2003, Windows Mobile and Mac OS X
v10.3+
ship with a
built-in
L2TP/IPsec client. The "Microsoft L2TP/IPSec VPN Client" for Windows 95
/ 98 /
Me / NT4 is a free download from the Microsoft website. For
brevity, I call it the "MSL2TP client" below. SSH
Sentinel, Forticlient and SafeNet SoftRemote are third-party clients
for Windows
that support both IPsec and L2TP.<br>
</p>
The information on this webpage is applicable to all L2TP/IPsec clients
mentioned above. The Linux part of the configuration is basically the
same
for all these clients. Once you have read this page, check out the
webpage for the particular client(s) that you want to
use.<br>
<br>
Nate Carlson has made an '<a href="http://www.natecarlson.com/linux/ipsec-l2tp.php">executive
summary</a>' for people who want just the facts.<br>
There are several IPsec implementation available
for Linux:<br>
<ul>
  <li><a href="http://www.freeswan.org/">FreeS/WAN</a>: this was the
first IPsec implementation available for Linux. However, FreeS/WAN is <a href="http://www.freeswan.org/ending_letter.html">no longer in active
development</a>. It forked into Openswan and strongSwan. <br>
  </li>
  <li><a href="http://www.openswan.org/">Openswan</a> is maintained by
former
FreeS/WAN team members who have started the company <a href="http://www.xelerance.com/">Xelerance</a>.</li>
  <li><a href="http://www.strongswan.org/">strongSwan</a> is
also a
continuation of FreeS/WAN. StrongSwan's principal author is Andreas
Steffen, the creator of the X.509 certificate patch for FreeS/WAN. Not
surprisingly,
its main
focus is on good certificate and smartcard support. StrongSwan is
sponsored by&nbsp;<a href="http://www.suse.com/"></a><a href="http://www.astaro.com/">Astaro</a>. </li>
  <li>Kernel 2.6+ contains a native IPsec implementation, which is
known as "<a href="#InstallationIPsec">NETKEY</a>", "26sec" or
"PF_KEY".
This means that recent distributions ship with IPsec support out of the
box.</li>
  <li><a href="http://ipsec-tools.sourceforge.net/">ipsec-tools</a> is
based on <a href="http://www.kame.net/">KAME</a> and used by default on
many distributions. Its IKE daemon is called racoon.<br>
  </li>
  <li><a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/">isakmpd</a>:
there is a <a href="http://packages.debian.org/stable/net/isakmpd">Linux
port</a> of <a href="http://www.openbsd.org/">OpenBSD</a>'s ISAKMP
daemon.<br>
  </li>
</ul>
<a name="Kerneltable"></a> A Linux IPsec implementation typically
consist of a kernel part and corresponding userland utilities. The
kernel part of FreeS/WAN, Openswan and strongSwan is called <b><a href="http://wiki.openswan.org/index.php/Openswan/KLIPS">KLIPS</a></b>.
The
userland IKE daemon is called 'pluto'. Vanilla kernels (2.4 and older)
do not ship with KLIPS by default. You will have to apply a
KLIPS kernel patch or install loadable kernel modules for KLIPS. As
mentioned
above, kernels 2.6 and higher ship with a native IPsec implementation
called <a href="http://wiki.openswan.org/index.php/Openswan/Netkey"><b>NETKEY</b></a>.
Recent versions of
FreeS/WAN c.s. support not only KLIPS but also NETKEY. To make things
even more complex, there is also a NETKEY
backport for kernel 2.4 and work
is in progress to port KLIPS to kernel 2.6.
This means that you have the following userland vs.
kernel options on the
Linux side:<br>
<br>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top"><small><br>
      </small></td>
      <td valign="top"><small>Kernel 2.0 KLIPS<br>
      </small></td>
      <td valign="top"><small>Kernel 2.2 KLIPS<br>
      </small></td>
      <td valign="top"><small>Kernel 2.4 KLIPS<br>
      </small></td>
      <td valign="top"><small>Kernel 2.4 NETKEY backport<sup> 1) 2)</sup><br>
      </small></td>
      <td valign="top"><small>Kernel 2.6 KLIPS </small></td>
      <td valign="top"><small>Kernel 2.6 NETKEY<sup> 1)</sup><br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>FreeS/WAN 1.x<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>FreeS/WAN 2.x </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>Openswan 1.x</small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>Openswan 2.x</small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small>X<sup>4)</sup><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>strongSwan 2.x<sup><br>
      </sup></small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>ipsec-tools utilities <sup>3)</sup><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X<br>
      </small></td>
    </tr>
    <tr>
      <td valign="top"><small>isakmpd Linux port<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X?<br>
      </small></td>
      <td valign="top" align="center"><small><br>
      </small></td>
      <td valign="top" align="center"><small>X?<br>
      </small></td>
    </tr>
  </tbody>
</table>
<br>
<small><sup>1)</sup> </small><small>Linux 2.6+ contains NETKEY, a
native IPsec implementation.</small><br>
<small><sup>2) </sup></small><small>NETKEY has also been backported to
kernel 2.4. This port is not included with the vanilla Linus kernel but
some Linux distributions </small><small>(Debian in particular)</small><small>

include the backport in their kernels.</small><small><br>
<sup>3) </sup>The <a href="http://ipsec-tools.sourceforge.net/">ipsec-tools</a>
utilities
(including the IKE daemon 'racoon') are a Linux port of <a href="http://www.kame.net/">KAME</a>.
Ipsec-tools is included in most distributions.<br>
<sup>4)</sup> There are issues with the heavily modified kernels of
some distributions such as RHEL 3.<br>
</small><br>
There is a <a href="http://www.openswan.org/docs/feature_comparison.php">feature
comparison
between FreeS/WAN and Openswan</a> available and also a <a href="http://www.strongswan.org/">feature comparison between Openswan
and
strongSwan</a>. Someone should make a good feature comparison between
KLIPS and NETKEY but currently there isn't one. Each option has
its pros and cons. I have not tested
all combinations. Nowadays most people use Openswan. If you are
interested in using ipsec-tools with kernel 2.6 and L2TP/IPsec,
then you probably should check out <a href="http://www.funknet.org/doc/tunnel/l2tp.xml">this webpage</a>
by
Chris Andrews. I have also not tested L2TP on top of other
IPsec implementations such as those from OpenBSD (<tt>isakmpd</tt>) or
FreeBSD. These BSD versions use <a href="http://www.kame.net/">KAME</a>
(or its fork <a href="http://ipsec-tools.sourceforge.net/">ipsec-tools</a>
because development of KAME's racoon has <a href="http://www.kame.net/racoon/">ceased</a>), so I assume that
the procedure would be similar to what is described by Chris.<br>
<br>
Disclaimer: I
do not have
experience with this setup in production use. But since the writing of
these
pages, <a href="#ServerswithL2TPIPsec">commercial Linux products</a>
have
started to support a similar (if not the same) L2TP/IPsec setup.
<p><b>1.2 Results<br>
</b></p>
<p>The following Windows L2TP/IPsec <b>clients</b> have been tested:<b><br>
</b> </p>
<ul>
  <li> Windows XP Professional works fine as an L2TP/IPsec client.<br>
  </li>
  <li> Windows XP Home is similar to XP Professional. It has not been
tested by me personally but is reported to work.<br>
  </li>
  <li> Windows 2000 Professional also works.</li>
  <li>Windows Vista works.<br>
  </li>
  <li> Windows 2000 Server (used as a client) works just like Windows
2000 Professional. I wouldn't use it as a desktop operating system,
though.</li>
  <li> Windows Server 2003 (used as a client): is similar to Windows
2000 Professional with <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">IPsec
update</a> (MS KB Q818043) applied. Again: not recommended as a desktop
operating system (mainly due to price).</li>
  <li> Microsoft ISA Server is also <a href="http://l2tpd.graffl.net/msg01048.html">reported</a> to work.</li>
  <li> The "Microsoft L2TP/IPSec VPN Client" (alias <a href="http://www.jacco2.dds.nl/networking/msl2tp.html">MSL2TP</a>) works.<br>
  </li>
  <li><a href="http://www.safenet-inc.com/products/vpn/softRemote.asp">SafeNet
SoftRemote</a> and OEM versions such as <a href="http://www.netscreen.com/products/">Netscreen-Remote</a> and <a href="http://www.sprintbiz.com/customer_center/product_support/vpn/index.html">CoSine</a>
(Sprint Business) seem to work. The MSL2TP client is actually derived
from this client.</li>
  <li><a href="http://www.ssh.com/products/security/sentinel/"> SSH
Sentinel</a> has support for L2TP/IPsec. Seems to work fine. (Note: SSH
has <a href="http://www.ssh.com/company/newsroom/article/484/">sold</a>
Sentinel to its competitor SafeNet.
Development has ceased. Windows XP with SP2 <a href="http://www.astaro.org/showthreaded.php?Cat=&Number=48072&page=&view=&sb=5&o=&vc=1">does
not support it</a> (Vista probably neither). You can still order the
last version
from <a href="http://www.buy.com/retail/product.asp?sku=20353842&loc=105&sp=1">Buy.com</a>
and <a href="http://english.cyprotect.com/main0171.php">CyProtect</a>.)</li>
  <li><a href="http://www.fortinet.com/products/forticlient.html">Forticlient</a>:
unknown but is based on SSH Sentinel so it might work.<br>
  </li>
  <li>Windows Mobile and <a href="http://www.microsoft.com/windowsmobile/products/pocketpc/about/2003/connection.mspx">Pocket
PC 2003</a> ship with a built-in L2TP/IPsec client. Requires MS-CHAP
support in pppd. There are different versions of Windows Mobile. The
Smartphone version is a bit odd. I know how to configure a connection
on the (emulated) Smartphone but I could not figure out how
to
start this connection.<br>
  </li>
</ul>
The following L2TP/IPsec <b>clients</b> are available from Apple (for
more info, see <a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html">my other page</a>):<br>
<ul>
  <li>Mac OS X v10.4 ("Tiger") and 10.5 ("Leopard") ship with an
L2TP/IPsec client. The client GUI supports
certificate authentication but importing the client certificates is a
bit tricky.<br>
  </li>
  <li>Mac OS v10.3 ("Panther") <a href="http://www.nwfusion.com/newsletters/vpn/2003/0714vpn1.html">ships
with an L2TP/IPsec client</a>. The
Panther GUI supports authentication through <a href="#Road_Warrior_support">Preshared Keys</a> (PSKs) but it does not
support certificates.<br>
  </li>
  <li>The <a href="http://www.apple.com/iphone/">iPhone</a> supports
L2TP/IPsec. Currently it supports PSK authentication and no certificate
authentication.</li>
</ul>
<p>Linux can connect as an L2TP/IPsec <b>client</b> to other
L2TP/IPsec servers. See also <a href="http://www.jacco2.dds.nl/networking/linux-l2tp.html">this webpage</a>.<br>
</p>
<p>All clients mentioned above support some form of NAT-Traversal. Note
that you may
need to obtain the latest
version of your client to actually get the NAT-T support. Although
NAT-T is
supported by these clients, it may not always work when you connect to
a
Linux IPsec
server.
Some
of the clients have been tested successfully, others do not work yet
(this is discussed <a href="#NAT">below</a>).<br>
</p>
<p><b><a name="ServerswithL2TPIPsec"></a>1.3 Commercial products with
L2TP/IPsec</b> </p>
<p>Here is a list of L2TP/IPsec <b>server</b> products, in case you
rather buy something off the shelf. Most of these are closed source, so
you may have to pay for user licences. See also <a href="http://www.vpnc.org/vpnc-ipsec-features-chart.html">this feature
chart</a> on the VPNC website. (The list below does not imply that
these products have been tested against Linux L2TP/IPsec).<br>
</p>
<ul>
  <li>Linux based:</li>
  <ul>
    <li><a href="http://www.astaro.com/">Astaro Security Gateway</a>
uses strongSwan and <a href="http://docs.astaro.org/howtos/">supports
L2TP over IPsec</a>, in addition to pure IPsec and PPTP.</li>
    <li><a href="http://www.phion.com/">phion netfence</a><br>
    </li>
    <li><a href="http://www.cyberguard.com/"> </a><a href="http://www.securecomputing.com/">Secure
Computing</a> firewall/VPN
family (formerly <a href="http://www.smoothwall.net/">CyberGuard</a> SG
(Snapgear))</li>
    <li><a href="http://www.smoothwall.net/">Smoothwall Corporate Server</a>
with the <a href="http://www.smoothwall.net/products/smoothtunnel31/">Smoothtunnel</a>
add-on module supports both L2TP over IPsec and pure IPsec.
They have made <a href="http://www.smoothwall.net/products/smoothtunnel31/?tech_l2tp">

client software</a> which makes installation of certificates easier.
Although Smoothwall is based on Linux, there are licence fees based on
the
number of VPN tunnels.</li>
    <li><a href="http://www.stinghorn.com/">Stinghorn L2TP Gateway</a>
(no longer available?):
supports even multiple Windows/Mac
clients behind the same NAT box. It is built on Stinghorn's
virtualisation platform and thus one server can accommodate up to 50
Stinghorn L2TP
Gateways. This allows operators to isolate customers from each other
and offer them dedicated gateway services. Stinghorn used to have a <a href="http://support.stinghorn.com/wiki/L2tpVpnTestGateway">public
L2TP/IPsec server</a> available for testing.</li>
  </ul>
  <li>&nbsp;Mac OS X based:</li>
  <ul>
    <li>Apple <a href="http://www.apple.com/server/macosx/features/networkingvpn.html">Mac
OS X Server</a>. Version 10.4 and higher supports authentication
through <a href="#Road_Warrior_support">certificates</a>, Kerberos and
      <a href="#Road_Warrior_support">group secrets</a>.</li>
  </ul>
  <li>Windows based:</li>
  <ul>
    <li>Microsoft Windows 2000, Windows Server 2003 and Windows Server
2008. Windows 2000 does not support
NAT-T when used as a server.<br>
    </li>
    <li>Microsoft Windows XP Professional and Windows 2000
Professional.
These contain a small-scale VPN server (not included with XP Home) that
allow
one connection at a time. <a href="http://www.extremetech.com/print_article/0,3998,a=35983,00.asp">Extremetech</a>
and <a href="http://www.onecomputerguy.com/networking/xp_vpn_server.htm">Bob
Cerelli</a> have written articles about this.</li>
    <li>Microsoft Windows Vista. See Windows XP. However,
some versions of Vista probably do not ship with the built-in VPN
server (like with XP Home).<br>
    </li>
    <li>Windows Server based VPN <a href="http://www.microsoft.com/windows/specializedservers/solutions/security.mspx">appliances</a>
such as those from <a href="http://www.activelane.com/">ActiveLane</a>.</li>
    <li>Microsoft <a href="http://www.microsoft.com/isaserver/">ISA
Server</a>.</li>
    <li>ISA Server based <a href="http://www.microsoft.com/isaserver/howtobuy/hardwaresolutions.asp">appliances</a>.</li>
  </ul>
  <li>Dedicated hardware:</li>
  <ul>
    <li>Checkpoint <a href="http://www.checkpoint.com/products/vpn-1_pro/index.html">VPN-1</a>.</li>
    <li>Cisco <a href="http://www.cisco.com/warp/public/707/cmatrix.shtml">PIX
firewalls, VPN concentrators and routers running IOS</a>.</li>
    <li>Enterasys <a href="http://www.enterasys.com/products/routing/XSR-xxxx-VPN/">routers
with VPN capabilities</a>.</li>
    <li><a href="http://www.iss.net/">IBM/ISS</a> Proventia UTM</li>
    <li><a href="http://www.intoto.com/">Intoto</a><br>
    </li>
    <li>Juniper <a href="http://www.juniper.net/products/eseries/">E-series</a>
and <a href="http://www.juniper.net/products/integrated/">Netscreen
series</a>.</li>
    <li><a href="http://www.nokia.com/">Nokia</a><br>
    </li>
    <li>Nortel <a href="http://www.nortelnetworks.com/">VPN Routers</a></li>
    <li>SonicWALL <a href="http://dwcc.dataworld.com.hk/sonicwall/utm/Documentation/Security%20Appliances/TZ150/VPN%20TN/general%20VPN%20TN/16Configuring_L2TP_Server_SonicOS.pdf">Firewall/VPN
Appliances</a></li>
  </ul>
</ul>
<p><b>1.4 Non-commercial and Open Source products with L2TP/IPsec<br>
</b></p>
<ul>
  <li>Linux based:</li>
  <ul>
    <li><a href="http://www.astaro.org/">Astaro.org</a> - Free for home
users and special programs for non-profits and educational
institutions.</li>
    <li><a href="http://www.ipcop.org/">IPCop</a> - L2TP/IPsec support <a href="http://www.ipcops.com/index.php?name=PNphpBB2&file=viewtopic&t=3472&start=0&postdays=0&postorder=asc&highlight=&sid=c0c94460c160828e53c21cccaa6ef090">in
development</a> by Duncan Reed (<a href="http://www.elminster.com/postnuke/index.php?name=Sections&req=viewarticle&artid=6&page=1">HOWTO</a>).</li>
    <li><a href="http://www.linux-vpn.de/lr101.php">LR101</a> - The
Linux
VPN Router Project.</li>
    <li><a href="http://www.redwall-firewall.com/">redWall Firewall</a>
is
a bootable CD-ROM firewall with support for multiple VPNs, IDS, proxies
etc.</li>
    <li>The firewall, VPN server and wireless access point <a href="http://users.gotsky.com/cvonk/linux/siso/ipsec-server.html">from
scratch</a>, by Coert Vonk</li>
    <li><a href="http://www.zeroshell.net/eng/">Zeroshell</a> by Fulvio
Ricciardi is a small Linux distribution with support for wired/wireless
networks, VPN, VLANs etc.<br>
    </li>
  </ul>
</ul>
<p><b>1.5 Author</b> </p>
<p>The author of this document is <a href="http://www.jacco2.dds.nl/contact/index.html">Jacco de Leeuw</a>.
Corrections, additions, extra information etc. are much appreciated. A
big thank you to everybody who has provided feedback! </p>
<p> </p>
<hr width="100%"> <br>
<a name="Contents"></a><b>2. Contents</b>
<ul>
  <li> <a href="#Contents">Introduction</a></li>
  <li> <a href="#Contents">Contents</a></li>
  <li> <a href="#Background">Background information</a></li>
  <li> <a href="#Procedure">Procedure overview</a></li>
  <li> <a href="#Firewallwarning">Safety first: some security
considerations</a></li>
  <li> <a href="#VPNoptions">VPN alternatives</a></li>
  <li> <a href="#ProsCons">(Dis-)advantages of using IPsec with L2TP</a></li>
  <li> <a href="#Road_Warrior_support">Road Warrior support</a></li>
  <li> <a href="#InstallationIPsec">Installation (Linux kernel etc.)</a></li>
  <li> <a href="#Openswanconfig">Configuration of Openswan</a></li>
  <li> <a href="#ConfiguringMSclients">Configuring the L2TP/IPsec
clients</a></li>
  <li> <a href="#InitiatingIPsec">Initiating the L2TP/IPsec connection</a></li>
  <li> <a href="#L2TPoverview">L2TP overview</a></li>
  <li> <a href="#L2TPconfigLinux">L2TP installation and configuration
(Linux)</a></li>
  <li> <a href="#L2TP-PPPencryption">PPP authentication, compression
and encryption</a></li>
  <li> <a href="#PPPinstallconfig">PPP installation and configuration
(Linux)</a></li>
  <li> <a href="#InitiatingIPsec">Initiating the L2TP/IPsec connection
once again</a></li>
  <li> <a href="#RemarksonIPsec">Some remarks on L2TP/IPsec</a></li>
  <li> <a href="#NAT">NAT-Traversal<br>
    </a></li>
  <li> <a href="#WindowsNetworking">Windows Networking (WINS etc.)</a></li>
  <li> <a href="#Splittunnelling">Split tunnelling</a></li>
  <li> <a href="#Troubleshooting">Troubleshooting</a></li>
  <li> <a href="#Certificates">Certificates</a></li>
  <li> <a href="#Wireless">Protecting wireless connections</a></li>
  <li> <a href="#Client">Linux as an L2TP/IPsec client</a></li>
  <li> <a href="#Speculation">Some speculation</a></li>
  <li><a href="#Links">Related links</a></li>
  <li><a href="#Acknowledgements_and_disclaimer">Acknowledgements and
disclaimer</a><br>
  </li>
  <li> <a href="#Revisionhistory">Revision history</a></li>
</ul>
<hr width="100%"><a name="Background"></a><b>3. Background information</b>
<p>Microsoft has included an IPsec client with <b>Windows 2000
Professional / Server, Windows XP Home / Professional, Windows Vista, </b><b>Pocket
PC 2003</b> and <b>Windows Mobile</b>. The client is supplied with
the base operating system so
you do
not have to download it. See also my <a href="#Introduction">other
webpages</a>. </p>
<p>A separate IPsec client can be downloaded for free from the
Microsoft website. This 'MSL2TP client' can be installed on <b>Windows
95 / 98 / Me / NT4</b>. Although the client is different from the one
included with Windows 2000/XP/Vista, it is quite similar in
functionality. For
more information on the MSL2TP client, see my webpage "<a href="http://www.jacco2.dds.nl/networking/msl2tp.html">Using
a Linux server with the Microsoft L2TP/IPSec VPN Client</a>". </p>
<p>As far as I know, there is still no Microsoft client
for Windows 3.x, Windows NT 4.0 Server and Pocket PC versions 2002 and
older. But there are third-party IPsec clients on the market. For
non-commercial use you can download the free <a href="http://www.pgpi.org/">PGPNet</a>, but it is is limited to
host-to-host connections. </p>
<p>There is however a snag with the free IPsec clients from Microsoft.
You can use IPsec only in combination with another protocol called <a href="#L2TPoverview">L2TP</a>. It is fairly <a href="#RemovingL2TP">difficult</a>
(2000/XP/Vista) or probably even <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#L2TPdiscussion">impossible</a>
(MSL2TP, Pocket PC) to get rid of this L2TP requirement. One might say
that Microsoft "<a href="http://en.wikipedia.org/wiki/Embrace_and_extend">embraced and
extended</a>" the IPsec standard, in true
Microsoft fashion. To be fair though, L2TP is currently a '<a href="http://www.rfc-editor.org/rfcxx00.html">Proposed</a> Internet
Standard' (<a href="http://www.ietf.org/rfc/rfc2661.txt">RFC 2661</a> )
and so is 'L2TP over IPsec' (<a href="http://www.ietf.org/rfc/rfc3193.txt">RFC 3193</a>). PPTP, on the
other hand, is another widely used VPN protocol but it is <a href="#PPTP">not an official standard</a>. </p>
<p>The use of the L2TP protocol means that you will have to use an L2TP
daemon. Several L2TP daemons are available. I will come to that
later.
When a Windows L2TP/IPsec client connects to your Linux server, it
first
sets up an IPsec tunnel to Openswan. Then it uses the tunnel to
connect
to the L2TP daemon on the Linux server, after which the client can
access machines on the internal network. </p>
<p>There is an alternative option if you happen to have a Windows 200x
Server. With the L2TP/IPsec client you connect to the Linux IPsec
server and
then use that IPsec tunnel to connect to the L2TP server of Windows
200x, instead of Linux. Martin K&ouml;ppe has written a <a href="http://koeppe-net.de/l2tp-howto.txt">Howto</a> on this. The
advantage would be that Microsoft's L2TP server is presumably more
compatible with the Windows clients than the Open Source L2TP daemons.
Note that with this setup the Windows 200x Server is not directly
connected to the Internet: the Linux server is. One might regard this a
security advantage. Users are authenticated through PPP against Windows
200x
instead
of Linux, so you will need Client Access Licences.</p>
<p>Microsoft apparently does not think that IPsec is a good protocol
for authenticating teleworkers ("Roadwarriors"). This is a bit odd,
because third-party clients (<a href="http://www.pgp.com/">PGPNet</a>, <a href="http://www.safenet-inc.com/products/vpn/softRemote.asp">SoftRemote</a>
etc.) have absolutely no problem with it. Microsoft's rationale is
stated on their website in a <a href="http://www.microsoft.com/windows2000/techinfo/howitworks/communications/remoteaccess/vpnfaq.asp">VPN
FAQ</a>. Basically, they claim that passwords are easier to use than
certificates. But I suspect there might be another tactical decision
behind this. The L2TP protocol supports additional authentication
mechanisms which apparently suit Microsoft better (e.g. authenticating
through the Windows logon credentials, which means selling more NT/200x
client licences). </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="Procedure"></a><b>4. Procedure overview</b>
<ul>
  <li> Download Openswan, L2TP server, PPP server and example
scripts/config files.</li>
  <li> Read documentation (including these webpages, Openswan docs,
Microsoft docs).</li>
  <li>Use the kernel supplied with your Linux distribution if it
supports IPsec. If not, find download a kernel (source) package for
your distribution with IPsec support. If none is available, you might
need to compile and install one yourself.<br>
  </li>
  <li>Install the Openswan userland utilities for your Linux
distribution. If none are available, you might need to compile and
install them yourself.<br>
  </li>
  <li> Modify the Openswan configuration files.</li>
  <li> Install the L2TP/IPsec client on a Windows or Macintosh
workstation (if not built-in).</li>
  <li> Configure the client to use a Preshared Key ('password').</li>
  <li> Initiate (= "dial") the L2TP/IPsec connection on the client.</li>
  <li> Verify on the Linux VPN server that the IPsec part of the
connection is up.</li>
  <li>Download, install and configure L2TP and PPP servers on Linux.</li>
  <li> Adjust your firewall to block UDP port 1701 on the external
interface
(important!).</li>
  <li> Initiate the L2TP/IPsec connection again on the workstation.</li>
  <li> Verify on the Linux VPN server that now both IPsec and L2TP work.</li>
  <li> (Optional) Repeat using X.509 certificate instead of a Preshared
Key.</li>
</ul>
Here is a schematic of the setup. The IP addresses in this picture are
used in my sample configuration files as well.<br>
<br>
<div align="center"><img alt="The topology of a Linux L2TP/IPsec VPN server" title="IP-&gt;PPP-&gt;L2TP-&gt;IPsec-&gt;IP" src="topo.png" width="470" height="400"><br>
</div>
<br>
This may look difficult (which it probably is) but if you already have
a working Openswan system it should boil down to installing an extra
RPM/Debian package for the L2TP daemon. You will also need to change
the
L2TP configuration files a little bit. My example configuration files
use <tt>192.168.1.x</tt> and you will need to change this to the
subnet
used on your internal network. One thing which complicates things a bit
is <a href="#NAT">NAT-Traversal support</a>. I suggest you first try
to get it working without NAT.<br>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="Firewallwarning"></a><b>5. Safety first: some security
considerations</b>
<p>Read this part carefully. If you have just started reading this page
you don't have to take immediate action. Just keep it in the back of
your mind and remember to come back to it when you have got the whole
lot working and you are about to hook it up to a hostile network such
as
the Internet.</p>
<p><b>5.1.1 Ports to open on the external interface: IPsec<br>
</b></p>
<p>You are probably using a firewall on your VPN server (or in front of
it). In that case you will need to adjust
your
firewall so that the L2TP/IPsec protocol is allowed in.<br>
</p>
<p>There are many different types of firewalls on Linux. There are even
differences between
versions of the same Linux distribution. Many people prefer to use
their own custom
firewall rules instead of those of the distribution. I'm afraid it is
impossible for me to provide specific instructions for each and every
type of firewall. See also the <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/firewall.html">FreeS/WAN
documentation</a>.<br>
</p>
<p>For L2TP/IPsec you need to open the <b>same</b> protocols and ports
as for
pure IPsec:<br>
</p>
<ul>
  <li>UDP port 500 (IKE)</li>
  <li>IP protocol 50 (ESP)</li>
  <li>UDP port 4500 (NAT-T) - needed if some of your clients are behind
a <a href="#NAT">NAT</a> router<br>
  </li>
</ul>
<p>Note that IP 50 is a <i>protocol</i>, not a <i>port</i>. As you
might know, IP has
protocols such as ESP, UDP and TCP. The protocols TCP and UDP on their
turn have ports such as TCP 80 (HTTP), UDP 500 (IKE) etc.<b> <br>
</b></p>
<p><b>5.1.2 Ports to block on the external interface: L2TP</b><br>
</p>
<p>You should firewall the L2TP daemon on the external (hostile)
interface so that it is not accessible. Or better said: you MUST
firewall the L2TP daemon, otherwise you will be taking a huge risk.<br>
</p>
<p>So for L2TP/IPsec you need to <b>firewall</b> the following port<b>
</b><b>on all
interfaces</b> except <tt>ipsec0</tt> (or <tt>eth0</tt> if you are
using NETKEY instead of KLIPS):<br>
</p>
<ul>
  <li>UDP port 1701 (L2TP)</li>
</ul>
<p> </p>
<p><b><a name="listen-addr"></a>5.2.1 The listen-addr parameter (KLIPS
only)</b><br>
</p>
<p>In addition to firewalling L2TP, here is another suggestion which
makes your setup even more secure. This step is described in the
following paragraphs. By default the L2TP daemon listens on UDP port
1701. Should your firewall be down (for some reason), the L2TP daemon
would be exposed on the external interface. So you do not want anyone
to access the L2TP daemon through the VPN server's external interface.
What you want is that only IPsec authenticated clients are able to
access the L2TP daemon, i.e. L2TP packets should flow through the IPsec
tunnel and not directly (unencrypted) between the server and the
clients. However, by default the L2TP daemon listens
on <em>all</em>
interfaces, even on the external (hostile) interface. It binds to <tt>INADDR_ANY</tt>
(for those in the know). Preferably you would like the L2TP daemon to
bind to only the <tt>ipsec0</tt> interface. Unfortunately, this is not
possible. Unlike low-level network applications such as tcpdump and
Ethereal you cannot bind the L2TP daemon to a particular <i>interface</i>.<br>
</p>
<p>Fortunately, there is a way to bind the L2TP daemon to a particular <i>IP
address</i>. Patches are available for two of the major Open Source
L2TP daemons (<a href="http://l2tpd.graffl.net/msg01361.html">l2tpd</a>
and <a href="http://l2tpd.graffl.net/msg01308.html">rp-l2tp</a>) which
allows the server to bind (listen) to <i>one</i> particular IP
address.
This <tt>listen-addr</tt>
patch for l2tpd is included in my <a href="#L2TPconfigLinux">l2tpd RPM</a>
(from version <tt>7jdl</tt> and up). To use this patch you add a
parameter "<tt>listen-addr
192.168.1.98</tt>" to the L2TP
daemon's configuration file (l2tpd.conf). The daemon will then listen
on the IP address <tt>192.168.1.98</tt> (the internal interface in my
example configuration). <br>
</p>
<p>So now you have an L2TP daemon listening on the internal interface.
The daemon cannot be accessed from the external interface, which is
good. But the L2TP daemon should be accessible through the <tt>ipsec0</tt>
interface. This is done by configuring an <tt>iptables</tt>
rule which forwards L2TP packets coming from the <tt>ipsec0</tt>
interface to the internal interface:<br>
</p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
iptables -t nat --append PREROUTING -i ipsec0 -p udp --sport 1701
--dport 1701 -j DNAT --to-destination 192.168.1.98<br>
      <br>
      </tt></p>
      </td>
    </tr>
  </tbody>
</table>
<p>(Where <tt>192.168.1.98</tt> is again the IP address of the
internal
interface). The rule is deleted with:<tt><br>
</tt></p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><br>
      <tt>iptables -t nat --delete PREROUTING -i ipsec0 -p udp --sport
1701 --dport 1701 -j DNAT --to-destination 192.168.1.98<br>
      <br>
      </tt></p>
      </td>
    </tr>
  </tbody>
</table>
<p>Openswan must be running when you execute these lines, i.e. <tt>ipsec0</tt>
must exist. Alternatively, you could add these extra rules to a
firewall script called by Openswan, namely the one specified by the <tt>leftfirewall=</tt>
parameter. See also the <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/firewall.html#up_down">FreeS/WAN
documentation</a> on this.<br>
</p>
When the <tt>listen-addr</tt> parameter is used properly, the L2TP
daemon will not listen on the external interface. So, should the
firewall be down (shit happens), then the L2TP daemon
will not be exposed on the external interface. It's still prudent to
firewall incoming L2TP connections (UDP port 1701)
on all
interfaces except <tt>ipsec0</tt>. Use firewall blocking and the <tt>listen-addr</tt>
parameter in tandem (a "belt and suspenders" approach).<br>
<br>
<b><a name="listen-addr_26sec"></a>5.2.2 The listen-addr parameter
(with NETKEY)</b><br>
<br>
Unfortunately the listen-addr trick mentioned above does not work
with the native kernel 2.6 IPsec implementation (NETKEY). That is
because NETKEY does not have <tt>ipsec0</tt> style interfaces and
NAT-after-IPsec is currently broken on vanilla kernel 2.6. There are 5
ways to
solve (or work around) this problem on 2.6 kernels. Unfortunately I
have not tested
all of them yet. The first is to use KLIPS in the 2.6
kernel so that you will have <tt>ipsec0</tt> style interfaces.
Openswan 2.3+ supports KLIPS for 2.6 kernels but it is <a href="http://www.openswan.org/development/roadmap.php">fairly new</a>
and might have issues. Another option is to use kernel 2.6.16 or higher
which contains Patrick McHardy's <a href="http://www.netfilter.org/patch-o-matic/pom-extra.html#pom-extra-ipsec-01-output-hooks">ipsec
hook netfilter patches</a> (as mentioned
<a href="http://lists.openswan.org/pipermail/users/2004-August/001954.html">here</a>),
with iptables &gt;= 1.3.5.
A third option is to build your own 2.6 kernel with these netfilter
patches.
A fourth (suboptimal)
solution is use firewall rules on the IPsec server, i.e. have your L2TP
daemon listen on all interfaces and then
firewall all incoming L2TP connections on external interfaces. It is
probably a good idea to use the "mark" option in netfilter (see <a href="http://www.funknet.org/doc/tunnel/l2tp.xml">Chris Andrews' page</a>
for an example). A final (suboptimal) solution is to place a separate
firewall (possibly with NAT)
in front of the VPN server. Then you can have the VPN server's L2TP
daemon listen
on all interfaces (you can even use firewall rules on the VPN server;
having two firewalls
should not be a problem). In these last two suboptimal cases you are
relying on the
firewall; should it be compromised, (accidentally) disabled or
otherwise,
the L2TP daemon is exposed. With potentially dire consequences...<br>
<p><b>5.3 ip_forward</b><br>
</p>
<p>One other security related point to notice is that people often set <tt>/proc/sys/net/ipv4/ip_forward</tt>
to <tt>1</tt> for (VPN enabled) routers, so that packets coming from
the
IPsec tunnel are forwarded to the internal network. This can be done by
adding <tt>forwardcontrol=yes</tt> to <tt>ipsec.conf</tt>. However,
there are some security implications. Perhaps one or more iptables
forward
rules
could do the same trick, when restricted to certain interfaces. Or
you
could use <tt>iproute2</tt>
(advanced routing). This is a bit outside the scope of this document.<br>
</p>
<p><b>5.4 chroot, UML, XEN, SELinux etc.</b><br>
</p>
<p>Both Openswan and l2tpd run as root. For extra security you could
try to shoehorn them into a <tt>chroot</tt> jail or an SELinux policy.
Or you could even virtualise your server with Usermode Linux, Xen, etc.
I have not
attempted to do this but apparently the people at <a href="http://www.astaro.org/">Astaro</a> have managed to run the
L2TP/IPsec server in chroot. You could
download an
evaluation copy and check out how they did it. A commercial product
that uses virtualisation to support multiple L2TP/IPsec tunnels is <a href="http://www.stinghorn.com/">Stinghorn</a>. Red Hat / Fedora
appears to have a default SELinux policy but it is for racoon, not
Openswan.<br>
</p>
<a href="#Contents">Back to Contents</a> <br>
<hr width="100%"> <br>
<a name="VPNoptions"></a><b>6. VPN alternatives</b>
<p>Before I dig into the technical details of setting up Openswan with
L2TP, let's take one step back. I assume that you are interested in
providing remote access over the Internet to your users. Important
factors in this are price, security and user friendliness and often you
can only pick 2 out of these 3 factors. Several
solutions are available, such as: </p>
<ol>
  <li> A hardware device (or "appliance") at the client side.</li>
  <li> PPTP or SSTP, for instance using the clients included with
Windows 95
and later, Mac OS and Linux/Unix.<br>
  </li>
  <li> A remote desktop solution such as Citrix, Windows Terminal
Server, pcAnywhere or VNC.</li>
  <li> An <a href="http://www.nwfusion.com/reviews/2004/0112rev.html">SSL-based
VPN</a>, such as <a href="http://www.sshtools.com/showSslExplorer.do">SSL
Explorer</a>, <a href="http://www.hobsoft.com/">HOB</a> or <a href="http://www.citrix.com/products/csg.asp">Citrix Secure Gateway</a>.</li>
  <li>Non-standards based Open Source solutions such as <a href="http://sites.inka.de/sites/bigred/devel/cipe.html">CIPE</a>, <a href="http://vtun.sourceforge.net/">vtun</a>, <a href="http://tinc.nl.linux.org/">tinc</a> and <a href="http://openvpn.sourceforge.net/">OpenVPN</a>.</li>
  <li>Non-standards based proprietary solutions such as <a href="http://www.hamachi.cc/">Hamachi</a>.<br>
  </li>
  <li> Third-party IPsec clients such as NCP, PGP, SafeNet SoftRemote,
SSH
Sentinel or TheGreenBow VPN Client.</li>
  <li> The IPsec client included with Windows 2000/XP/Vista, manually
configured to get rid of L2TP.</li>
  <li> The IPsec client included with Windows 2000/XP/Vista, configured
with
a
free software tool to get rid of L2TP.</li>
  <li>L2TP/IPsec clients such as Windows 2000/XP/Vista, Pocket PC 2003,
Windows Mobile, Mac
OS X v10.3+ and the MSL2TP client (Win9x/Me/NT4). </li>
</ol>
<p> <b>Ad 6.1:</b> These are hardware devices with PPTP/IPsec support
such as those from Checkpoint, Cisco, Draytek or Netscreen. Hardware
devices are
easy to configure for the user (because the system administrator does
it
for them :-). The hardware box is then handed in person or shipped to
the user. Another advantage is that most of these devices also contain
a
firewall. Security of hardware devices is fairly high. Some hardware
devices can be centrally managed. A disadvantage is the price, which
tends to be higher when the device has more VPN capabilities. Hardware
boxes are also not very portable so they are less suitable for roaming
users. Another problem (the classic hardware/software trade off) is
that
they may be difficult to extend with new features. Many hardware
devices only support Preshared Keys (i.e. passwords) and not
certificates. But Netscreen and SnapGear do support certificates. If
the
hardware device only supports Preshared Keys, the user is required to
have a fixed IP address, unless the device also supports <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/interop.html">Aggressive
Mode</a>. </p>
<p><a name="PPTP"></a><b>Ad 6.2:</b> PPTP is free and easy to use but
that's about it, really. PPTP clients are included with Windows 98 and
higher. Updates (including a version for Windows 95) are available for
free from the <a href="http://support.microsoft.com/support/kb/articles/q285/1/89.asp">Microsoft
website</a>. PPTP clients are available for other operating systems as
well, including BSD, Linux and Mac. An advantage of PPTP is that it
supports NAT-Traversal, i.e. it can get through (most) devices that
employ Network Address Translation (NAT). Microsoft claims that PPTP
has
a "<a href="http://www.microsoft.com/windowsserver2003/techinfo/overview/vpnfaq.mspx">good
level of security that is suitable for most companies</a>". Security
professionals such as Bruce Schneier <a href="http://www.schneier.com/pptp.html">think otherwise</a>. A German
student managed to <a href="http://mopo.informatik.uni-freiburg.de/pptp_mschapv2/node12.html">crack
PPTP passwords</a> in 4 hours. <a href="http://asleap.sourceforge.net/">Asleap</a>
by Joshua Wright has been extended to crack weak PPTP passwords. The
authors of the premier Open Source PPTP implementations <a href="http://pptpclient.sourceforge.net/">PPTPClient</a> and <a href="http://www.poptop.org/">Poptop</a> recommend <a href="http://poptop.sourceforge.net/dox/protocol-security.phtml">against
using PPTP</a>. Others
have found a <a href="http://online.securityfocus.com/bid/5807/discussion/">flaw in
Microsoft's PPTP</a> implementation. Even Microsoft now admits that "<a href="http://news.zdnet.com/2100-1009_22-5321783.html">as a VPN
protocol, Microsoft considers PPTP to be non-strategic</a>". Note also
that PPTP is not an
official Internet standard. It is an 'de-facto industry standard' set
by
Microsoft. From Microsoft's <a href="http://www.microsoft.com/windows2000/techinfo/howitworks/communications/remoteaccess/vpnfaq.asp#C">VPN
FAQ</a> mentioned above you might easily get the impression that their <a href="http://www.ietf.org/rfc/rfc2637.txt">PPTP</a> and <a href="http://www.ietf.org/rfc/rfc2759.txt">MS-CHAPv2</a> protocols are
official IETF standards. This is not the case. You can check that on <a href="http://www.rfc-editor.org/rfcxx00.html">the RFC website</a>.
It's even mentioned in the RFCs themselves: "<i>[This RFC] does not
specify an Internet standard of any kind</i>". Those two RFCs have
never
been ratified as official standards. They expired. Quoting the <a href="http://www.rfc-editor.org/rfcfaq.html">Internet RFC FAQ</a>: "<i>Unscrupulous
marketeers and a careless trade press sometimes falsely suggest that
every RFC represents a standard, or that all standards have equal weight</i>".
PPTP also supports the MPPC compression protocol which is patent
encumbered. So is PPTP proprietary? <a href="http://www.microsoft.com/ntserver/ProductInfo/faqs/PPTPfaq.asp#16">Microsoft
says no</a>, but they are not telling the whole story. Microsoft has
developed yet another proprietary VPN protocol called <a href="http://en.wikipedia.org/wiki/SSTP">SSTP</a>. It is included with
Windows Vista SP1 and Windows Server 2008. Other operating systems are
not supported. SSTP is based
on SSL and should be able to pass through most routers, unlike the <a href="http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation">GRE</a>
protocol used in PPTP which is sometimes blocked by routers.<br>
</p>
<p><b>Ad 6.3:</b> Remote desktop clients and servers often use
proprietary protocols (<a href="http://www.realvnc.com/">VNC</a> and <a href="http://www.nomachine.com/">NX</a> are the exceptions).
Effectively, this is "<a href="http://www.schneier.com/crypto-gram-0111.html#1">security
through obscurity</a>". Security experts generally don't like this
concept. There is often little encryption (VNC) or the protocol is
vulnerable to a Man-In-The-Middle Attack (VNC, RDP). Prices can also be
fairly steep (<a href="http://www.citrix.com/">Citrix</a>, <a href="http://www.gotomypc.com/">GoToMyPC</a>, <a href="http://www.symantec.com/pcanywhere/">pcAnywhere</a>). Again, VNC
is the exception because it is open source. <a href="http://www.microsoft.com/windows2000/technologies/terminal/default.asp">Windows
Terminal Server</a> (RDP) requires extra client licences (CALs). Remote
desktop clients such as VNC and pcAnywhere only support one user per
system.</p>
<p><b>Ad 6.4:</b> SSL-based VPNs are very flexible to set up. In many
cases the only requirement is that the user must have a recent browser.
The user will have to surf to a certain website and then a special
client will be downloaded automatically using Java or ActiveX. This
means you will have to maintain and administrate a webserver connected
to the Internet. Note that in principle the user can connect from
anywhere, even dubious locations such as airport kiosks, Internet
caf&eacute;s
etc. Once the client software has been downloaded, the user is
presented
with a remote desktop (similar to 6.3). In some products, the client
will switch to a proprietary protocol (<a href="http://www.hobsoft.com/">HOB</a>,<a href="http://www.microsoft.com/windows2000/downloads/recommended/TSAC/default.asp">

Windows
TS ActiveX</a>). Other products continue to use SSL for the remote
desktop part (<a href="http://www.citrix.com/products/csg.asp">Citrix
Secure Gateway</a>?). SSL is used for downloading the applet and the
remote desktop protocol itself. Proprietary protocols may be faster but
SSL is a well-understood and open standard, so it is probably more
secure than a vendor-specific protocol. Windows Vista SP1 ships with a
SSL VPN called <a href="http://www.computerworld.com/action/article.do?command=viewArticleBasic&articleId=9008679">SSTP</a>.
<a href="http://www.sshtools.com/showSslExplorer.do">SSL Explorer</a>
is
the world's first open-source, browser-based SSL VPN solution.
Commercial vendors are <a href="http://www.aventail.com/">Aventail</a>,
<a href="http://www.f5.com/f5products/FirePass/">F5 FirePass</a>, <a href="http://www.neoteris.com/">Neoteris</a> and <a href="http://www.netilla.com/">Netilla</a> (server appliance based on <a href="http://www.tarantella.com/">Tarantella</a>). A disadvantage is
that SSL based VPNs do not support all applications (compared to full
blown VPNs such as PPTP/IPsec). For instance, one could argue that <a href="http://www.microsoft.com/exchange/techinfo/outlook/2000/0WA2000.asp">Outlook
Web Access</a> is also an SSL based VPN but you can use it only to
access Exchange Server. Another disadvantage is that you will have to
secure the special website and keep it locked down. Or, if you use an
appliance, you better not forget to install security updates from the
vendor.<br>
</p>
<p><b>Ad 6.5</b>: There are also some other non-standards based Open
Source solutions such as <a href="http://sites.inka.de/sites/bigred/devel/cipe.html">CIPE</a>, <a href="http://vtun.sourceforge.net/">vtun</a>, <a href="http://tinc.nl.linux.org/">tinc</a> and <a href="http://openvpn.sourceforge.net/">OpenVPN</a>. OpenVPN seems to be
<a href="http://www.osnews.com/story.php?news_id=5803">promising</a>
(based on OpenSSL, runs in user-space, is relatively lightweight,
supports compression, simple-to-use and runs on 7 different OS's
including Windows) but the others have <a href="http://www.cs.auckland.ac.nz/%7Epgut001/pubs/linux_vpn.txt">serious
security problems</a>, according to security expert Peter Gutmann.<br>
</p>
<p><b>Ad 6.6</b>: There are a few proprietary solutions of which <a href="http://www.hamachi.cc/">Hamachi</a> is an example. Hamachi is
freeware and claims to be very easy to use ("zero-configuration"). It
even works without change when both sides of the VPN are behind NAT.
Although the makers of Hamachi have released <a href="http://www.hamachi.cc/security">some details</a> about its
protocol, it is still proprietary and a trade secret and thus has not
seen any peer review by professional cryptographers. Source code is not
available so you cannot fix bugs yourself, or add any new features and
when there is no version for your operating system of choice, you are
out of luck. Hamachi uses a central "mediation" server operated by the
makers of Hamachi. All clients regularly communicate with this server.
</p>
<a name="Thirdparty"></a><b>Ad 6.7</b>: A freeware IPsec client is
available for Windows 2000/XP: the <a href="http://www.shrew.net/?page=software">Shrew Software VPN Client</a>.
It has been <a href="http://www.howtoforge.com/racoon_roadwarrior_vpn_p5">tested with
ipsec-tools</a> based Linux VPN servers, but it works with
Openswan/strongSwan as well. Alternatively,
several vendors sell
third-party IPsec clients: <a href="http://www.icsalabs.com/html/communities/ipsec/lab/notes/1.0B/nai-mcafee-vpn-client-71.shtml">McAfee
VPN client</a>, <a href="http://www.ncp.de/english/home/index.html">NCP
Secure Entry Client/Secure VPN/PKI Client</a> (<a href="http://wiki.openswan.org/index.php/Interop/InteroperatingNCP">Openswan
interop Wiki</a>), <a href="http://www.pgp.com/">PGP Mac VPN client</a>,
<a href="http://www.safenet-inc.com/products/vpn/softRemote.asp">SafeNet
SoftRemote</a>, <a href="http://www.ssh.com/company/newsroom/article/484/">SSH Sentinel</a>,
<a href="http://www.fortinet.com/products/forticlient.html">Forticlient</a>,
<a href="http://www.thegreenbow.com/vpn.html">TheGreenBow VPN Client</a>.
For a more complete list, see <a href="http://wiki.openswan.org/index.php/Win2K">Openswan's
interoperability overview</a>. These clients generally have a lot of
features, e.g. support for AES (a fast encryption standard). However,
you will have to pay for these clients. This has the advantage that you
receive support from the vendor, depending on your support contract. <a href="http://ftp.vc-graz.ac.at/mirror/crypto/programs/ssh/f-secure/">SSH
Sentinel 1.2 "Internetpilot"</a> (old and buggy) and <a href="http://www.pgp.com/">PGP</a> are free for non-commercial use.
<p> </p>
<p><a name="RemovingL2TP"></a><b>Ad 6.8:</b> By default, the IPsec
clients included with Windows 2000/XP/Vista, Pocket PC and Mac OS X
v10.3+
can only be used for tunnelling L2TP. You might want to get rid of
L2TP, so
that you don't have to install an L2TP daemon on your Linux server.
This
leaves you with 'pure' IPsec. Unfortunately, this is very difficult to
do manually. You can find an example for Windows 2000 Professional on
the <a href="http://www.cyberguard.info/snapgear/downloads/snapgear/documentation/IPSec/SnapGear_with_Win2k.pdf">Snapgear
website</a>. This is hardly user friendly by anyone's standards. As if
Microsoft wanted to discourage pure IPsec without L2TP. Another
drawback is that you will need Administrator privileges to change the
IPsec settings using MMC. Note also that this VPN option is only
available for Windows 2000, XP and Vista. The MSL2TP client and Pocket
PC
cannot be configured for IPsec without L2TP (as far as I know). In
other
words, if you have Windows 9x/Me/NT or Pocket PC, you will have to
choose one of the other VPN options, possibly buying a third-party
client (see <a href="#Thirdparty">option 5</a>). This means you will
have to support not one, but two different VPN options... </p>
<p><a name="IPSEC.EXE"></a><b>Ad 6.9:</b> Fortunately, there are tools
(wrappers around the built-in IPsec client). Two popular tools are
available: the <a href="http://sourceforge.net/projects/lsipsectool/">Linsys
IPsec Tool</a> (lsipsectool) and <a href="http://vpn.ebootis.de/">IPSEC.EXE</a>
by
Marcus
M&uuml;ller. They do the configuring for you when you
want to use Windows
2000/XP without L2TP. Like the previous VPN option, <a href="http://www.microsoft.com/technet/itcommunity/chats/trans/network/net0708.asp">Administrator
privileges are required</a> to run the IPSEC.EXE utility, but you can
get around this if you are prepared to run IPSEC.EXE as a Service (see <a href="http://lists.virus.org/freeswan-0311/msg00781.html">this
post</a> by Uwe Knop). You will have to distribute the Linsys tool or
the IPSEC.EXE
program
to your users, together with a configuration file and the user's
private
key and certificate. The configuration file resembles a Openswan
config
file, so you could even generate it on your Linux server. Nate Carlson
has made an excellent webpage with instructions on <a href="http://www.natecarlson.com/linux/ipsec-x509.php">using Windows
2000/XP with Openswan</a>. There are also <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Advanced">several graphical front-ends</a>
for the IPSEC.EXE utility available. There is also a free GUI that
works similar to these graphical IPSEC.EXE wrappers: the <a href="http://www.securepoint.cc/en/products-vpn.html">Securepoint
Personal Firewall & VPN Client</a>. If you use Mac OS X v10.3+
instead of Windows, then there are <a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html#VPN_alternatives">similar
programs</a>
available as well. Note that
the MSL2TP client cannot be used with this option. It cannot be
configured to
get rid of L2TP, so you'll have the same MSL2TP related problem as with
option 6.7.<br>
</p>
<p><b>Ad 6.10:</b> I will go into more details below, as L2TP over
IPsec
is the main topic of this page. One thing is certain, though: you will
have to use an L2TP server on the Linux side. </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="ProsCons"></a><b>7. (Dis-)advantages of using IPsec with L2TP</b>
<p>Here are the advantages and disadvantages of using IPsec with L2TP. </p>
<p>Pros: </p>
<ul>
  <li> '<b>Free</b>': a client is included with Windows or can be
downloaded <a href="#Introduction">without charge</a> from Microsoft.
Mac OS X 10.3+ also ships with a client. Of course, the clients
themselves
are not really free because you pay for them through
your Windows/Mac OS licences. And obviously the clients are <a href="http://www.gnu.org/philosophy/free-sw.html">not free</a> in the
definition of the Free Software Foundation.</li>
  <li><b>Readily available on the client.</b> A client is
installed by default on Windows 2000/XP/Vista, Windows Mobile and Mac
OS X
v10.3+. On Win9x/Me/NT4, you need to install extra software (requires
Dial-Up Networking 1.4 and IE 5.01 or higher).<br>
  </li>
  <li> <b>Fairly easy to use.</b> There's not much to configure, so
less
to go wrong.</li>
  <li> <b>'Native' client</b> (i.e. from Microsoft and Apple). Some
managers fall for that...</li>
  <li><b>Secure</b>. IPsec is generally <a href="http://www.schneier.com/paper-ipsec.html">considered a secure
VPN protocol</a>. More so than PPTP, for example. L2TP is a not a
strong VPN protocol but the L2TP packets are encapsulated within IPsec
anyway.<br>
  </li>
  <li> <b>Supports 'Virtual IP addresses'.</b> This means that the
remote client will get an IP address from the internal network once it
has logged on. To other computers it will seem as if the remote client
is on the internal network.</li>
  <li> <b>Supports TCP/IP and IPX tunnelling.</b>
With L2TP you are creating a layer 2 tunnel, so in theory any layer 3
protocol can
be tunnelled. In most cases, however, TCP/IP will be used within the
VPN
tunnel. IPX is reported to work as well (not tested by me). The
Microsoft clients
support NetBEUI but pppd does not, so NetBEUI will probably not work.</li>
  <li> <b>L2TP over IPsec is an official IETF standard.</b> (<a href="ftp://ftp.isi.edu/in-notes/rfc2661.txt">RFC 2661</a>). This
means that the protocol is fully documented and supported by multiple
vendors. Similar VPN
related schemes such as PPTP, SSTP, MPPE, L2sec and OpenVPN are no
official standards. Some are closed source and undocumented, which is
generally frowned upon in the security community. </li>
  <li> <b>NAT-Traversal.</b> Most of the IPsec clients support this
(but
in some cases an update is needed, for instance Windows 2000/XP). More
information <a href="#NAT">below</a>.</li>
</ul>
Cons:
<ul>
  <li><b>Possibly difficult to install on the server.</b> L2TP/IPsec
may
be easier to use on the client, but the trade-off is that it is more
difficult to install on the server than either PPTP or pure IPsec.
However,
this largely depends on
your skill set and your choice of Linux distribution. </li>
  <li><b>Fewer features.</b> AES encryption, for example, is only
supported on Microsoft Vista, Mac OS X and some commercial
clients. AES is
considerably
faster than 3DES. It is not supported by Windows 2000/XP.<br>
  </li>
  <li> <b>Support.</b> Who can you call for support on the clients?
Microsoft? Microsoft resellers? There are <a href="http://lists.openswan.org/mailman/listinfo/">Openswan</a> and <a href="http://www.mail-archive.com/l2tpd-devel%40l2tpd.org/maillist.html">l2tpd</a>
mailinglists with very helpful people, but if you bump into a bug in a
Windows client, only Microsoft can fix it. There are companies such as <a href="http://www.astaro.com/">Astaro</a> and <a href="http://www.xelerance.com/">Xelerance</a> that provide support on
their Linux VPN products.<br>
  </li>
  <li> <b>Requires an L2TP server.</b> Openswan provides an IPsec
server but you will also need an L2TP server. Several implementations
exist but they are not widely used on Linux/Unix.</li>
  <li> <b>Requires certificates.</b> Unless all your clients have
fixed
IP addresses, you will need <a href="#Certificates">X.509
certificates</a>. In other words, you need a Public Key Infrastructure
(PKI). PPTP on the other hand only requires passwords.<br>
  </li>
  <li><b>Not much experience available.</b> The combination of IPsec
with L2TP is fairly new on Linux. There are probably few people using
this setup at the moment. There is a relatively active community on the
    <a href="http://lists.openswan.org/mailman/listinfo/users">Openswan
mailinglist</a>. As far as I know there is also not much
information online except for these webpages and the Microsoft
documentation. However, several <a href="#ServerswithL2TPIPsec">commercial
vendors</a> are using this setup, so professional support is available
if you need it, including support from <a href="http://www.xelerance.com/">Xelerance</a>, the authors of Openswan.<br>
  </li>
  <li> <b>Uncertain upgrade path.</b> I am not aware of any long term
roadmap by Microsoft. Windows Vista supports new features such as AES
but the IPsec client shipped with
Windows 2000/XP has not been
updated since June 2003.&nbsp; The MSL2TP client for Win9x/NT/Me is
basically a
version 1.0 client and it will not be updated. </li>
  <li> <b>Packet overhead.</b> The payload traffic gets encapsulated a
couple of times (IPsec, L2TP, PPP). This requires more bandwidth. It
could also result in a problem with MTU size. If I'm not mistaken,
'pure' IPsec has an overhead of 56 bytes per packet. L2TP will add an
extra 16 bytes per packet. If NAT-Traversal (IPsec encapsulated in UDP)
is used
the
overhead will be even larger. I have not done any extensive performance
evaluations. (Here is <a href="http://lists.openswan.org/pipermail/users/2005-May/005029.html">one
report</a> by a user). The 16 byte overhead is especially apparent if
IP is the
only protocol you want to tunnel, which is usually the case. Pure
IPsec does not have this extra L2TP/PPP overhead. Note that if you want
to tunnel IPX over the Internet, you cannot avoid this overhead.</li>
  <li> <b>Slower.</b> The L2TP and PPP protocols require extra daemons
on the Linux server. These daemons currently run in user mode. This
means extra
processing overhead and more latency. I have not done many
measurements, but on an ADSL
line the line speed seemed to be the bottleneck, not the VPN. If you
run
the VPN over a LAN, the VPN <i>is</i> the bottleneck. On my (crappy
old)
hardware, adding pure IPsec seemed to halve the throughput, and when
l2tpd was added it seemed to halve again. (If you have done some more
elaborate benchmarking, let me know).</li>
  <li> <b>Complicates things for non-Microsoft/non-Apple clients.</b>
L2TP on
top
of IPsec makes life easer for the native Windows clients and Mac OS X
clients but not all
third-party IPsec clients support L2TP. For instance, if you also have
Linux users, it would be silly to ask them to run an L2TP client. It
would also mean more work for you too because you would have to provide
support for not one, but two different VPN options, i.e. IPsec with and
without L2TP.</li>
  <li> <b>NAT-Traversal</b> with L2TP/IPsec is currently
experimental on Linux. <a href="#NAT-multiple-clients">Some NAT
configurations</a> are currently not supported by Openswan. NAT-T has
been ratified by the IETF (<a href="http://www.ietf.org/rfc/rfc3947.txt">RFC
3947</a>) but most
vendors have only implemented older draft versions.<br>
  </li>
  <li><b>No "</b><b>Perfect Forward Secrecy"</b>. <a href="#PFS">PFS</a>
is a security feature that can be enabled for IPsec connections but the
Windows and Mac L2TP/IPsec clients do not support it (unless the user
manually creates an IPsec policy, which is user unfriendly and error
prone, or unless Vista is used from the command-line which is user
unfriendly, too).<br>
  </li>
  <li> <b><a name="Patent"></a>Patent issues.</b> Cisco has a U.S.
patent
claim on
the L2F protocol. L2TP is essentially Cisco's L2F and Microsoft's PPTP
merged into one. Cisco has a <a href="http://www.ietf.org/ietf/IPR/CISCO-L2TP">patent on L2TP</a> as
well. It is licensed under "Reasonable And Non-Discriminatory" (RAND)
terms which may be <a href="http://xml.coverpages.org/patents.html#RAND">not that great</a>
as it sounds. However, according to people in the know, it is not to be
expected that
Cisco will seek royalties. There are also <a href="http://www.kame.net/newsletter/20040525/">patent claims on
NAT-Traversal</a> as well, by several companies (some even <a href="http://www.ietf.org/ietf/IPR/SSH-NAT">mutually</a> <a href="http://www.ietf.org/ietf/IPR/MICROSOFT-NAT-Traversal.txt">exclusive</a>?).
Note that this patent
issue may
only affect you if you are in the United States, Japan or another
country with <a href="http://nosoftwarepatents.com/">silly</a> software
patent laws.<br>
  </li>
</ul>
As you can see, there are a lot of good reasons to <i>not</i> use L2TP
over IPsec. But the single fact that it is reasonably secure and cost
effective might make it
interesting enough to consider it, until better solutions such as IKEv2
and
<a href="ftp://ftp.isi.edu/in-notes/rfc3456.txt">DHCP over IPsec</a>
are more widely available.
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr size="2" width="100%"><b><a name="Road_Warrior_support"></a>8. Road
Warrior support</b><br>
<br>
VPN users often have dynamic IP addresses: they can have a
different IP address with every connection that they make. A good
example of this are travellers who connect with a laptop from hotels or
conference rooms (<a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/intro.html#road.intro">'Road
Warriors'</a>). Also, some cable/ADSL providers use DHCP to assign
dynamic IP addresses which change regularly. <br>
<br>
In IPsec
there are several ways to support this scenario:<br>
<ul>
  <li>One Preshared Key (PSK) shared by every user<br>
  </li>
  <li>RSA authentication<br>
  </li>
  <li>Multiple Preshared Keys with Aggressive Mode</li>
  <li>XAUTH</li>
  <li>DHCP-over-IPsec</li>
  <li>IKEv2<br>
  </li>
  <li>X.509 certificates<br>
  </li>
</ul>
<p>A <b><a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/adv_config.html#prodsecrets">Preshared
Key</a></b> is a secret password that is shared by both sides of the
IPsec
tunnel. Preferably, the PSK is distributed 'out-of-band', i.e. not over
the hostile network (read: the Internet). For instance, you could meet
the user face to face and hand him the PSK on a piece of paper. PSKs
are
fairly simple to use, but they do not scale very well with the number
of users and if you want
to
use a PSK in a Road Warrior setup, all users with dynamic IP addresses
will have to <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/faq.html#road.PSK">share
the same PSK</a> ("group secret"). This is of course a significant
security risk: if one
user
leaves the company or loses his laptop, all the other users will have
to
get
a new PSK. The alternative would be to give every user a different PSK,
but this is only supported in IPsec if all users have fixed (= static)
IP addresses. Because of this limitation PSKs are generally not used in
Road Warrior setups, unless there is only one user or everyone has a
static IP address (e.g. home workers with cable or ADSL).<br>
</p>
<p>With <b><a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/adv_config.html#auto-auth">RSA
authentication</a></b> you specify the raw RSA public key of the user
in
the Openswan configuration. RSA authentication supports both static and
dynamic IP addresses. RSA authentication is also relatively
light-weight
to implement and almost as easy to use as a password. RSA keys have the
advantage that they are inherently more secure because passwords can be
guessed. Unlike passwords, RSA keys cannot be remembered by the user.
They will have to be cut and pasted into the configuration.
Unfortunately, none of the IPsec clients that support RSA
authentication
seem to support L2TP/IPsec, and vice versa.<br>
</p>
<p>Some IPsec clients support <b><a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/compat.html#dropped">Aggressive
Mode</a></b>. This allows them to use PSKs with dynamic IP addresses.
Especially clients for devices with relatively little processing power
such as Pocket PC and Palm use Aggressive Mode, because RSA encryption
is much slower than symmetric key encryption. There is a <a href="http://www.jacco2.dds.nl/networking/README.AggressiveMode">patch</a> for FreeS/WAN that adds support
for Aggressive Mode. This patch is also included with <a href="http://www.openswan.org/">Openswan 1.x</a> and <a href="http://www.freeswan.ca/">SuperFreeS/WAN</a>. The trouble with
Aggressive Mode is that security depends on the strength of the
password
itself (<a href="#PPTP">PPTP</a> has the same problem). There are
programs such as <a href="http://ikecrack.sourceforge.net/">IKEcrack</a>
and <a href="http://www.oxid.it/cain.html">Cain&Abel</a> that
attempt to crack the Preshared Key from intercepted sessions, as
explained by <a href="http://www.ernw.de/download/pskattack.pdf">Michael
Thumann</a>.</p>
<p></p>
<p><b><a href="http://www.watersprings.org/pub/id/draft-beaulieu-ike-xauth-02.txt">XAUTH</a></b>
(Hybrid Mode) is an extension to IPsec that was never ratified by IETF
because it
required changes to the (already complex) IKE standard. Cisco seems to
be a <a href="http://www.cisco.com/univercd/cc/td/doc/product/software/ios121/121newft/121t/121t1/xauth.htm">big
XAUTH proponent</a>. XAUTH is not supported by FreeS/WAN or
strongSwan, but there is an implementation in Openswan (disabled by
default; requires a <a href="http://wiki.openswan.org/index.php/XAUTH%20authenticator">recompile</a>).
<a href="http://www-rocq.inria.fr/who/Philippe.Sultan/vpn/spoofed_vpn_server.html">Philippe
Sultan demonstrates</a> that the XAUTH username and password can be
obtained using a spoofed server if the Preshared Key is already known.
That Preshared Key can be obtained through brute-force cracking (as
mentioned in the previous paragraph) or by copying from the client
itself (<a href="http://www.unix-ag.uni-kl.de/%7Emassar/bin/cisco-decode">disk</a>
or <a href="http://www.cisco.com/en/US/tech/tk583/tk372/technologies_security_notice09186a0080215981.html#details">memory</a>).
A
solution to this problem is to switch to Cisco's <a href="http://www.cisco.com/en/US/products/sw/secursw/ps2308/prod_release_note09186a00802d398a.html#wp1382364">Mutual
Group Authentication</a> (server certificates and client passwords;
currently only available for Cisco VPN Concentrators, not IOS) or to <a href="http://www-rocq.inria.fr/who/Philippe.Sultan/vpn/configuring_cisco_ios_vpn_rsasig.html">use
certificates</a> (requires client passwords and both client and server
certificates, but the client certificates can be 'junk' so a full PKI
can be avoided).</p>
<p><b>DHCP-over-IPsec</b> is supported by Openswan but there is very
little client support. The only Windows client is currently SSH
Sentinel but this product has been discontinued. (Note: this is not the
same as DHCP Inform, which is essentially
DHCP-over-PPP-over-L2TP-over-IPsec).<br>
</p>
<p><b>IKEv2</b> is a successor to the current IKE. It will support
'legacy'
authentication modes such as passwords through EAP. <a href="http://en.wikipedia.org/wiki/IKEv2">IKEv2</a> is expected to
become
the main standard. <a href="http://www.strongswan.org/">StrongSwan</a>
already supports IKEv2 and other implementations are under development.<br>
</p>
<p><b>X.509 certificates</b> are supported by almost all L2TP/IPsec
clients. Openswan supports it too, courtesy of a <a href="#Certificatepatch">patch
by Strongsec</a>. Certificates are generally considered the way to go
for Road Warriors. The disadvantage is that you will need to set up
some
kind of Public Key Infrastructure (PKI), which may be an administrative
burden. You need to generate, distribute, revoke etc. the X.509
certificates for the Openswan host and the L2TP/IPsec clients. More
information can be found in <a href="#Certificates">this section on
certificates</a>.<br>
</p>
<p>Other IPsec authentication methods such as <a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#AuthIP">AuthIP</a>, CRACK, HYBRID, Kerberos
and <a href="http://www.watersprings.org/pub/id/draft-ietf-ipsra-pic-06.txt">PIC</a>
exist as well, but currently there are no implementations available for
Openswan or any other Linux IPsec implementation (as far as I know).
</p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="InstallationIPsec"></a><b>9. Installation (Linux kernel etc.)</b>
<p>Here are the components to be used at the server side.<br>
</p>
<ul>
  <li> Linux <a href="http://www.kernel.org/">kernel</a>. A fairly
recent version is required, e.g. kernel 2.4.18 or higher, kernel 2.6.11
or higher. The 2.6 kernels contain <a href="http://wiki.openswan.org/index.php/26sec">NETKEY</a>, a native
IPsec implementation.</li>
  <li> <a href="http://www.openswan.org/">Openswan</a> or <a href="http://www.strongswan.org/">strongSwan</a>. If you can, try to
avoid
Openswan 1.x (or use at least version 1.0.6) because 1.x is no longer
supported by the Openswan team. Preferable use Openswan
2.4.x+. For strongSwan, use at least version
2.1.3. (That's because older versions of Openswan and strongSwan
contain a <a href="http://www.openswan.org/support/vuln/can-2004-0590/">vulnerability</a>).
If you prefer to use
the discontinued <a href="http://www.freeswan.org/">FreeS/WAN</a>
(which is not recommended because security bugs will not be fixed) you
should avoid versions 2.0, 2.01, 2.02 and 2.06. This is because
Transport Mode (a
requirement for L2TP/IPsec) has been removed from FreeS/WAN v2.06. The
FreeS/WAN versions 2.0, 2.01 and 2.02 contain a <a href="http://lists.virus.org/freeswan-0309/msg00358.html">bug
in the SHA-1 hashing algorithm</a> which leads to problems with some
clients, most notably the MSL2TP client. FreeS/WAN 2.03 and lower are
not compatible with NETKEY. On FreeS/WAN 2.x you may need
to <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/policygroups.html#disable_policygroups">disable
Opportunistic Encryption</a> (OE). Openswan and strongSwan ship with
OE disabled by default. </li>
  <li> Strongsec's <a href="http://www.strongsec.com/freeswan/index.htm">X.509
certificate patch</a>. This is a very popular add-on for FreeS/WAN.
Openswan and strongSwan already contain this patch. Only if you use
FreeS/WAN, you need this patch. In that case, make sure you use at
least version 0.9.40 or version 1.6.1 of the X.509 patch.<br>
  </li>
  <li> Optional (but strongly recommended for FreeS/WAN versions below
2.00): the <a href="#DeleteNotification">Delete/Notification patch</a>.
It is already included in Openswan and strongSwan.<br>
  </li>
  <li> Optional: Mathieu Lafon's <a href="http://open-source.arkoon.net/">NAT-Traversal
patch</a>. For more information, read <a href="#NAT">this</a>.</li>
  <li> Recommended if you use MSL2TP clients: JuanJo Ciarlante's <a href="http://www.jacco2.dds.nl/networking/freeswan-msl2tp-payload-malformed-workaround-1.diff">patch</a>
for FreeS/WAN. For more information, read <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#Rekeyingerror">this</a>. Openswan and strongSwan
already contain this patch.</li>
  <li> An L2TP server. I myself used <a href="#L2TPoverview">l2tpd-0.69</a>
but several other L2TP daemons are <a href="#L2TPoverview">available</a>.
I had to use extra patches from the l2tpd mailinglist and create some
patches myself. Vanilla 0.69 will not work. These patches are included
in my <a href="#L2TPconfigLinux">l2tpd RPM</a>. A version 0.70 is long
overdue (the Debian people created one themselves).</li>
  <li> A PPP server. One should be included with your distribution. I
used ppp-2.4.1 but 2.4.2 should be fine as well. You also need to
enable PPP support in your Linux
kernel
(most distributions already do).<br>
  </li>
  <li> Configuration files for Openswan, l2tpd and pppd. These are
included in my <a href="#L2TPconfigLinux">l2tpd RPM</a>. Also
available
is a <a href="#L2TPconfigLinux">tarball</a> which contains these
configuration files. </li>
</ul>
<b>9.1 Obtaining Openswan / strongSwan / </b><b>FreeS/WAN<br>
</b>
<p></p>
You may prefer to use the kernel supplied with your
Linux distribution if it already contains KLIPS or NETKEY. That
should give
you a head start. Later on, if you decide you need the latest versions,
extra patches or more features, you can decide to compile your own
kernel and userland utilities. This is not a tutorial on how to compile
and install Openswan et al.
Please refer to <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/install.html">FreeS/WAN's
documentation</a> and <a href="http://www.strongsec.com/freeswan/install.htm#section_3.2">Strongsec's
instructions</a>. Openswan is supported on many
distributions, sometimes by the vendor, sometimes by third parties.
I'll discuss the specifics for some of these
distributions below. Openswan RPMs for SuSE,
Red Hat, RHEL, and Fedora are available on the <a href="ftp://ftp.openswan.org/openswan/binaries/">Openswan website</a>.
The corresponding SRPMs can be found <a href="http://www.openswan.org/code">elsewhere</a> on the site.<br>
<p></p>
<p><a name="Notsupported"></a>Red Hat 9 and previous versions
are <a href="http://www.redhat.com/solutions/business/migration/">no
longer supported</a> by Red Hat. Fedora 4 and previous version are
also&nbsp; no longer supported by the Fedora Project. The <a href="http://www.fedoralegacy.org/">Fedora Legacy Project</a>
has been discontinued so there are no more security updates for these
old versions. There are also other <a href="http://www.seifried.org/security/redhat/20031230-redhat-support.html">alternatives</a>
if you use an old Red Hat version. MandrakeLinux 10.0 and older are <a href="http://www.mandriva.com/security/productlifetime">no longer
supported</a> by Mandriva. SuSE 8.0 and older are <a href="http://lwn.net/Articles/89794/">no longer supported</a>.
Obviously it does not make much sense to run
a VPN
server on an old distribution with unpatched vulnerabilities. The VPN
part may be highly secure but it won't help much if you are using, say,
a vulnerable kernel. This means that I won't be releasing updated RPMs
for Mandrake 8.x and Mandrake 9.0. (Also from a practical
standpoint: they simply had to make room for newer distributions on my
systems). Of course you should be able to compile the Source RPM
yourself if there is no RPM available for your distribution.<br>
</p>
<a name="RedHat"></a><b>9.1.1 Red Hat, Fedora and RHEL</b>
<p> </p>
<a href="http://www.redhat.com/">Red Hat</a> does not include
Openswan's KLIPS
in Red Hat Linux or Fedora. They prefer to use the
native
IPsec implementation (<a href="http://lartc.org/howto/lartc.ipsec.html">NETKEY</a>).
This implementation is included
in Fedora Core 2 and higher and RHEL. You will also need Openswan
userland
utilities to use NETKEY. Openswan RPMs are included in Fedora Core 3
and higher. RPMs are also available from the <a href="http://www.openswan.org/code/">Openswan
website</a>, <a href="http://atrpms.net/">Axel
Thimm's website</a> and <a href="http://dag.wieers.com/packages/kernel-module-openswan/">Dag
Wie&euml;rs
website</a>.<br>
<br>
Fedora Core 1 and Red Hat Linux up to version 9 do not ship with KLIPS
or NETKEY. Axel Thimm, Dag Wie&euml;rs and the Openswan team itself
provide KLIPS
enabled kernel RPMs and Openswan userland RPMs for these older
distributions. Source and binary RPMs from the Openswan team
are
available <a href="http://www.openswan.org/download/binaries/">here</a>.
You need two RPMs: the Openswan kernel-module RPM
and the Openswan userland RPM. The advantage of using an Openswan
kernel-module RPM is that you don't have to install a new kernel. The
kernel-module RPM is installed as an addition to the current (stock)
kernel. You don't even have to reboot. The downside is that that
this kernel-module RPM does not support <a href="#NAT">NAT-T</a>.
If you do need NAT-T, you will have to install <a href="http://atrpms.net/name/kernel/">Axel's KLIPS enabled kernel</a>
instead of the Openswan kernel-module RPM. If you do not need NAT-T (or
if you
don't want to bother with it as this moment), simply use the Openswan
kernel-module
RPM.<br>
<br>
If you want to use Openswan, do not install the ipsec-tools RPM that is
also included with Fedora. It contains another IKE daemon, racoon,
which conflicts with the IKE daemon of Openswan, pluto. If you prefer
to use ipsec-tools (racoon) instead of Openswan, you probably want
to check out <a href="http://www.funknet.org/doc/tunnel/l2tp.xml">Chris
Andrews' webpage</a>.
<p><a name="Legacy_pty_problem"></a>FC
2 and later (and quite possibly also RHEL) do not contain
'Legacy (BSD) PTY support' (<tt>CONFIG_LEGACY_PTYS=y</tt>), in contrast
with previous FC and Red Hat versions. You will need to use l2tpd RPM
version <tt>11jdl</tt> or later. These versions use the new(er)
Unix98-style pty
system
instead of the legacy BSD-style pty system. L2tpd version before <tt>11jdl</tt>
will not
be able to
start pppd and abort with the error message
"<tt>getPtyMaster: No more free pseudo-tty's</tt>". An alternative is
to
switch from l2tpd to another <a href="#L2TPoverview">L2TP daemon</a>
such as rp-l2tp.</p>
<p>If you use <a href="http://www.redhat.com/software/rhel/">Red Hat
Enterprise</a> (RHEL) or
clones such as <a href="http://www.centos.org/">CentOS</a>,&nbsp;<a href="http://www.raimokoski.com/lineox/">Lineox</a>, <a href="http://www.taolinux.org/">Tao Linux</a>, <a href="http://www.whiteboxlinux.org/">Whitebox Linux</a>
or <a href="http://www.xos.nl/resources/xoslinux" id="xoslinux">X/OS
Linux </a> then I don't have much advice because I do not have these
installed
myself. It seems that they use the backported NETKEY
implementation for kernel 2.4. Openswan RPMs for RHEL are available on
the Openswan website.
</p>
<p>According to Paul Wouters of the Openswan team, RHEL 3 (and its
derivatives such as CentOS 3) "is the <a href="http://lists.openswan.org/pipermail/users/2005-April/004382.html">worst
choice</a> for a kernel for IPsec related matters"
because its kernel is a 2.4 / 2.6 hybrid. You are better
off with RHEL 4+ or Fedora.
</p>
<p><b>9.1.2 SuSE / Novell</b> </p>
<p>Novell (SuSE) was a sponsor of Openswan development. SuSE kernels
already contain IPsec support, either
through NETKEY or
KLIPS. But SuSE employee Kurt
Garloff has made <a href="http://www.suse.de/%7Egarloff/linux/FreeSWAN/">source
and binary RPMs</a> for several versions of SuSE. They contain more
IPsec related patches than SuSE's official kernels. Some of Kurt's
KLIPS based kernels also contain the NAT-T patch. Alternatively,
Openswan RPMs are
available on the <a href="ftp://ftp.openswan.org/openswan/binaries/">Openswan
website</a>.
</p>
<p><b><a name="Mandrake"></a>9.1.3 Mandriva / Mandrake</b> </p>
<p>The 2.6 kernels included with Mandriva <b>2005-2006</b> and
Mandrake <b>10.x</b>
contain the
native NETKEY implementation. FreeS/WAN 2.04 is included
with Mandrake 10.0 and FreeS/WAN 2.06 is included with Mandrake 10.1,
Mandrive 2005 (=10.2) and 2006.
Unfortunately, FreeS/WAN version 2.06 <a href="#InstallationIPsec">cannot
be used</a>
for L2TP/IPsec because Transport Mode has been removed.
Openswan and strongSwan RPMs are available in the Mandriva
Cooker / contrib directory. If you don't want to use FreeS/WAN or one
of its successors, you can use <a href="http://www.funknet.org/doc/tunnel/l2tp.xml">racoon</a> from
ipsec-tools instead. Mandrake 10.0--10.2 also ship with a
SuperFreeS/WAN
RPM but
it is based on FreeS/WAN 1.99 so it is utterly useless because that
version of FreeS/WAN does not support NETKEY. Unfortunately the <tt>openswan</tt>
RPM in Cooker has a dependency on the <tt>ipsec-tools</tt> RPM. That
RPM will install and run (the competing IKE daemon) racoon by default.
That means you will have to stop racoon (<tt>service racoon stop</tt>)
and remove it from the startup scripts (<tt>chkconfig --del racoon</tt>)
before you install the Openswan RPM.<br>
</p>
<p>The stock kernel included with Mandrakelinux <b>10.1 </b>(and
probably Mandriva <b>10.2</b> as well) does not contain
'Legacy (BSD) PTY support'. This is the <a href="#Legacy_pty_problem">same
problem</a>
as with Fedora Core 2 and 3. This means that you will have to download
l2tpd RPM version <tt>11jdl</tt> or later. Or you will have to switch
to
another L2TP daemon such as rp-l2tp.<br>
</p>
<p>The stock kernels included with <b>Mandrake 9.x</b> contain KLIPS
and
the X.509 patch. A FreeS/WAN RPM is also included. This should in
theory be sufficient to
get you started. In practice however, there are some problems. The
current kernel for Mandrake <b>9.2</b> at the
time of this writing is kernel-2.4.22.28mdk. Unfortunately that kernel
contains FreeS/WAN 1.99.8 but the userland utilities are FreeS/WAN 2.01
(<tt>freeswan-2.01-1mdk.i586.rpm</tt>). So there is a mismatch and it
will not
work. You could try to compile the Openswan RPM from Mandrake Cooker.
Mandrake <b>9.1</b>'s
kernels for x86 are broken (kernel-2.4.21.0.13mdk...0.19mdk). There is
a <a href="http://qa.mandrakesoft.com/show_bug.cgi?id=1647">workaround</a>,
however. Kernel-2.4.21.0.24mdk for x86 is OK. And Mandrake 9.1's
kernels
for PowerPC are also OK. The current kernel for Mandrake 9.1 at the
time
of this writing is <tt>kernel-2.4.21.0.28mdk</tt>. That kernel
contains
FreeS/WAN
2.00 but unfortunately the userland utilities are still FreeS/WAN 1.99,
so it does not work. Mandrake
<b>9.0</b>
uses a fairly old version of the X.509 patch (be sure to avoid using
special characters in certificate names!).<br>
</p>
<p>Mandrake <b>8.1</b> and <b>8.2</b>
contain
older versions of FreeS/WAN without the X.509 patch. The stock kernels
included with 8.1 and 8.2 will not work with L2TP/IPsec because the
X.509 patch is required. That means you should either upgrade your
kernel or upgrade your Mandrake. Upgrading to a more recent Mandrake
version is
highly recommended. Should you
still want to use Mandrake 8.x, you can find newer kernels <a href="ftp://ftp.nluug.nl/pub/os/Linux/distr/Mandrake/official/updates/">here</a>.
You will also need an update for the FreeS/WAN user mode utilities
(normally called <tt>freeswan-x.xx.rpm</tt>). I could not find these
in the official updates but I did find a version 1.98 on Mandrake
Cooker at
<a href="http://rpmfind.net/linux/rpm2html/search.php?query=freeswan">rpmfind.net</a>.
Unfortunately (again), the latest Mandrake 8.x kernels contain older
FreeS/WAN versions than 1.98 so there is a mismatch.</p>
<p>Only Mandrake 9.2 contains the "Delete/Notification" patch and the <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#Rekeyingerror">'malformed payload' patch</a>. But if
you use an older Mandrake version it can be <a href="#DeleteNotification">fixed</a>.<br>
</p>
<p><b><a name="Debian"></a>9.1.4 Debian / Ubuntu / Knoppix etc.<br>
</b></p>
<p>Debian's "unstable" and "testing" distribution contain <tt>freeswan-modules-source</tt>
and <tt>openswan</tt>. Simply run the command '<tt>apt-get install
openswan</tt>' in install the Openswan .deb file. Most of Debian's 2.4
and 2.6 kernels ship with <a href="#InstallationIPsec">NETKEY</a>
support. If you want to build a
kernel yourself, you
may need to install the <tt>kernel-headers</tt>, <tt>kernel-package</tt>,<tt>

debianutils</tt> and <tt>fakeroot</tt> packages.<br>
</p>
<p>Debian <a href="http://packages.debian.org/search?suite=default&section=all&arch=any&searchon=names&keywords=l2tp">ships</a>
with l2tpd, xl2tpd and l2tpns. There is a <a href="http://bugs.xelerance.com/view.php?id=881">bug
in recent versions of xl2tpd</a> which results in a kernel Oops on
Ubuntu 7.10 if AppArmor is running (which is the default). You'll have
to either disable AppArmor (perhaps only for xl2tpd?), downgrade
xl2tpd,
change to another L2TP daemon or wait for this bug to be fixed.<br>
</p>
<p><b>9.1.5 Slackware</b><br>
</p>
<p>Derek T. Murphy has <a href="http://lists.virus.org/freeswan-0311/msg00682.html">released</a>
(unofficial) kernels with FreeS/WAN support.<br>
</p>
<p><b>9.1.6 Gentoo</b><br>
</p>
<p><a href="http://packages.gentoo.org/package/net-misc/openswan">Openswan</a>
and <a href="http://packages.gentoo.org/package/net-misc/strongswan">strongSwan</a>
packages are available
for Gentoo. Gentoo specific information can be found on the<a href="http://forums.gentoo.org/viewtopic-t-324500-highlight-openswan.html">

Gentoo forum</a> and on <a href="http://teh.sh.nu/HowTo/openswan-l2tp.html">this webpage</a> by
Brett Curtis. See also the <a href="http://wiki.openswan.org/index.php/Openswan/Gentoo">Gentoo Wiki</a>
on the Openswan website.<br>
</p>
<b>9.1.7 Other distributions</b>
<p> </p>
<p>You probably have to compile the kernel yourself, if there are none
available on <a href="http://rpmfind.net/">rpmfind.net</a> or other
sites.</p>
<p><a name="Certificatepatch"></a><b>9.2.1 The X.509 certificate patch</b>
</p>
<p>The X.509 certificate patch by <a href="http://www.strongsec.com/">Strongsec</a>
adds support for variable IP addresses to FreeS/WAN. Openswan and
strongSwan already contain this patch. In addition to X.509 support,
the patch provides another feature which is vitally important to
L2TP/IPsec.
L2TP/IPsec clients want to restrict the IPsec tunnel so that only UDP
packets (=IP protocol 17) are tunnelled. The standard version of
FreeS/WAN can not make such restrictions. Vanilla FreeS/WAN wants to
encrypt <i>all</i> protocols between itself and the other party, not
just the L2TP traffic. Openswan, strongSwan and the X.509 certificate
patch for FreeS/WAN support <a href="http://www.strongsec.com/freeswan/install.htm#section_4.5">two
parameters</a> that solve this problem: <tt>leftprotoport</tt> and <tt>rightprotoport.<br>
</tt></p>
Most L2TP/IPsec clients (including the <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">updated
clients included with Windows 2000/XP</a>, Windows Vista and XP SP2+)
require the
following parameters:
<p><tt>&nbsp;&nbsp;&nbsp; leftprotoport=17/1701</tt> <br>
<tt>&nbsp;&nbsp;&nbsp; rightprotoport=17/1701</tt> </p>
<p>However the original (non-updated) L2TP/IPsec client included
with Windows 2000/XP requires these parameters which seem to be a
mistake (or at least an inconsistency) by Microsoft because no other
vendor uses them): </p>
<p><tt>&nbsp;&nbsp;&nbsp; leftprotoport=17/0</tt> <br>
<tt>&nbsp;&nbsp;&nbsp; rightprotoport=17/1701</tt> </p>
<p>Mac OS X 10.3.x+ clients require yet another configuration because
they use a 'floating' UDP port. Fortunately, this configuration also
covers the <tt>rightprotoport=17/1701</tt> mentioned above:<br>
</p>
<p><tt>&nbsp;&nbsp;&nbsp; leftprotoport=17/1701</tt> <br>
<tt>&nbsp;&nbsp;&nbsp; rightprotoport=17/%any</tt> </p>
On Openswan 2.4.10+ you use this instead:<br>
<p><tt>&nbsp;&nbsp;&nbsp; leftprotoport=17/1701</tt> <br>
<tt>&nbsp;&nbsp;&nbsp; rightprotoport=17/0</tt> </p>
So if you have a mixed environment with different clients, it is
probably best to use <tt>leftprotoport=17/1701</tt> and<tt>

rightprotoport=17/0 </tt>(or <tt>17/%any</tt> on older versions) and
simply drop support for non-updated
Windows clients. Those clients would have to install the <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">KB
Q818043 update</a> or install XP SP2. (As an alternative, the Openswan
development team suggests to use <tt>leftprotoport=17/%any </tt>and <tt>rightprotoport=17/%any
</tt>but this allows access to <i>all</i> UDP daemons that may run on
the Openswan server. This is a bit too lenient for my taste. Another
solution would be an ugly hack where <tt>leftprotoport=17/0 </tt>is
accepted as a side-effect if <tt>leftprotoport=17/1701</tt> is
specified in the configuration).
<p>Only recent versions of the X.509 patch (e.g. 1.4.8+ for FreeS/WAN
2.x and
0.9.37+ for FreeS/WAN 1.99) can actually restrict the IPsec connection
to the specified protocol and port. Older versions of the X.509 do
support the left/rightprotoport parameters but they can not <i>enforce</i>
those restrictions. They will accept the protocol 17 (UDP) / port 1701
(L2TP) restriction but still happily send all other traffic (ICMP,
HTTP,
SSH etc.) through the IPsec tunnel, ignoring the restriction.</p>
<p><a name="Protocoltunnellingproblem"></a><b>9.2.2 Protocol tunnelling
problem</b> </p>
<p>If you don't use the X.509 patch there will be an interoperability
problem between the L2TP/IPsec clients and FreeS/WAN (reported by <a href="http://www2.frell.ambush.de/archives/freeswan-users/3389.html">Jason
A. Pattie</a>, among others). An IPsec connection can not be set up
because FreeS/WAN complains: </p>
<p><tt>&nbsp;"peer client ID payload ID_IPV4_ADDR specifies protocol
17; we only support 0"</tt> </p>
<p>If you get this error then you will have to apply the X.509 patch to
the FreeS/WAN userland programs. </p>
<p><a name="DeleteNotification"></a><b>9.2.3 "Delete/Notification"
support</b> </p>
<p>FreeS/WAN versions below
2.00 ignore "Delete/Notification" messages. Mathieu Lafon has made a <a href="http://open-source.arkoon.net/">"Delete/Notification"</a>
patch for FreeS/WAN which contains support for these messages.
Openswan, strongSwan and FreeS/WAN versions 2.00 and higher already
contain this patch.<br>
</p>
<p>A client may want to inform the server that it has taken down the
IPsec connection. It may do so by sending a "Delete SA" message. If the
server does support "Delete SA" messages, it simply ignores them and
the
IPsec connection may time out. In the mean time however, a client could
of course reconnect to the server. The server then gets confused about
the packets it receives. It thinks the packets are for the old
connection, whereas the client is convinced it has a new IPsec
connection. Mathieu Lafon's "Delete/Notification" patch fixes this.
Note
that if the client crashes or if the Internet connection breaks down,
the client does not get a chance to send a "Delete SA" message. In that
case, the server <i>will</i> time out, with or without the
"Delete/Notification" patch. For more information on this issue, see <a href="http://quimby.gnus.org/internet-drafts/draft-spencer-ipsec-ike-implementation-02.txt">this
document</a> by FreeS/WAN team member Henry Spencer. The
"Delete/Notification" patch seems especially useful for the MSL2TP
client (see <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#Restarting">this paragraph</a>).
(Note: the MSL2TP client seems to send each "Delete SA" message twice.
The first message will normally remove the SA so the second one will
result in a harmless "ignoring Delete SA payload" message).<br>
</p>
<p>Dominique Cressatti wrote in private correspondence that the
"Delete/Notification" support is required if you want the connection to
last for more than a few hours. </p>
<p>Mandrake RPMs lack "Delete/Notification" support. Also missing is
the <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#Rekeyingerror">'malformed payload' patch</a>
which is recommended for use with the MSL2TP client. I added these two
patches to the original RPM (the modified RPMs have been signed with <a href="http://www.jacco2.dds.nl/contact/index.html#RPMsecurity">my PGP key</a>). Again, <i>I
do
not recommend</i> using outdated and unmaintained versions of Mandrake,
but
here they are anyway: </p>
<p><tt>&nbsp;&nbsp; Mandrake Cooker original:&nbsp; <a href="http://search.belnet.be/packages/mandrake/9.0/SRPMS/freeswan-1.98b-1mdk.src.rpm">freeswan-1.98b-1mdk.src.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Modified 8.1/9.0 source: &nbsp; <a href="http://www.kerklied.com/%7Ejacco/SRPMS/freeswan-1.98b-2jdl.src.rpm">freeswan-1.98b-2jdl.src.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Mandrake 8.1 binary (x86): <a href="http://www.kerklied.com/%7Ejacco/RPMS/Mandrake8.1/freeswan-1.98b-2jdl.i586.rpm">freeswan-1.98b-2jdl.i586.rpm</a>
(please read <a href="#Notsupported">this</a>)<br>
</tt><tt>&nbsp;&nbsp; Mandrake 9.0 binary (x86): <a href="http://www.kerklied.com/%7Ejacco/RPMS/Mandrake9.0/freeswan-1.98b-2jdl.i586.rpm">freeswan-1.98b-2jdl.i586.rpm</a>
</tt><tt>(please read <a href="#Notsupported">this</a>)</tt><br>
<tt>&nbsp;&nbsp; Mandrake 9.1 original: &nbsp; &nbsp; <a href="http://search.belnet.be/packages/mandrake/9.1/SRPMS/freeswan-1.99-3mdk.src.rpm">freeswan-1.99-3mdk.src.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Modified 9.1 source: &nbsp;&nbsp; &nbsp;&nbsp; <a href="http://www.kerklied.com/%7Ejacco/SRPMS/freeswan-1.99-4jdl.src.rpm">freeswan-1.99-4jdl.src.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Mandrake 9.1 binary (x86): <a href="http://www.kerklied.com/%7Ejacco/RPMS/Mandrake9.1/freeswan-1.99-4jdl.i586.rpm">freeswan-1.99-4jdl.i586.rpm</a><br>
</tt><tt>&nbsp;&nbsp; Mandrake 9.1 binary (PPC): <a href="http://www.kerklied.com/%7Ejacco/RPMS/Mandrake9.1-PPC/freeswan-1.99-4jdl.ppc.rpm">freeswan-1.99-4jdl.ppc.rpm</a></tt><br>
</p>
<p><tt>&nbsp;&nbsp; You may need to hold the 'Shift' key while clicking
these links!</tt> </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="FreeSWANconfig"></a><a name="Openswanconfig"></a><b> 10.
Configuration of Openswan<br>
</b>
<p>Once you have a kernel with IPsec support, you will
need to configure one or more IPsec connections. (If you use FreeS/WAN,
don't forget to <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/policygroups.html#disable_policygroups">disable
Opportunistic Encryption</a> first). </p>
<p>The examples in the Openswan documentation assume that
"Roadwarrior" clients want to make "host-to-subnet" IPsec connections.
I
assume you want to do this as well. In other words, you want users to
have access to an (internal) subnet protected by a Openswan gateway.
In
'pure' IPsec (i.e. without L2TP) you do this using the <tt>left/rightsubnet</tt>
keyword. </p>
<p>The Openswan documentation does not cover L2TP/IPsec connections. In
L2TP/IPsec the user also wants to access the subnet, but the mechanism
to achieve this is different. First, you specify a host-to-host IPsec
tunnel between the Windows/Macintosh client and the Openswan server.
Once this
IPsec connection is up, the client connects to the L2TP
server
on the Openswan server. The L2TP server then forwards the packets to
the internal subnet. In pure IPsec, Openswan does the forwarding
itself. </p>
<p><a name="PSKs"></a><b>10.1 Preshared Keys overview</b> </p>
<p>Most L2TP/IPsec clients support two kinds of authentication
methods: X.509 certificates and Preshared Keys (PSK). I suggest you try
PSKs first, get an understanding of how IPsec works with the L2TP/IPsec
clients and then switch to certificates if you need them. </p>
<p><b>10.1.1 Preshared Key: configuration an IPsec connection</b> </p>
<p>Here is an example Openswan configuration file (included in my
l2tpd RPM). It defines an IPsec connection for one user. Note that if
you want to use this configuration you will have to add it to your <tt>ipsec.conf</tt>
file (or add the following parameter at the end of your <tt> ipsec.conf</tt>
file: <tt>include L2TP*.conf</tt>).<br>
</p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
# Configuration supporting multiple users with any type of<br>
# IPsec/L2TP client. This includes the updated Windows 2000/XP<br>
# (MS KB Q818043), Vista and Mac OS X 10.3+ but excludes the<br>
# non-updated Windows 2000/XP.<br>
#<br>
# Authenticates through a Pre-Shared Key. Supports clients that<br>
# are not behind NAT. Does not support clients that are behind NAT.<br>
      <br>
conn L2TP-PSK <br>
      </tt> <tt>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pfs=no<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rekey=no<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #
----------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The VPN server.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Allow incoming connections
on the external network interface.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If you want to use a
different interface or if there is no<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # defaultroute, you can
use:&nbsp;&nbsp; left=your.ip.addr.ess<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftprotoport=17/1701<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If you insist on
supporting non-updated Windows clients,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # you can
use:&nbsp;&nbsp;&nbsp; leftprotoport=17/%any<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #
----------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # The remote user(s).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Allow incoming connections
only from this IP address.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=234.234.234.234<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If you want to allow
multiple connections from any IP address,<br>
&nbsp; &nbsp; &nbsp; &nbsp; # you can use:&nbsp;&nbsp;&nbsp; right=%any<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightprotoport=17/%any<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #
----------------------------------------------------------<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Change 'ignore' to 'add'
to enable this configuration.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=<b>ignore</b><br>
      <br>
      </tt> </p>
      </td>
    </tr>
  </tbody>
</table>
<p>As you can see, the configuration is relatively simple. Note the
absence
of <tt>leftsubnet</tt> and <tt>rightsubnet</tt>, as explained above.
A convention followed by many people is to use "<tt>left</tt>" for the
server ("local") and "<tt>right</tt>" for Road Warriors. Recent
versions of FreeS/WAN, Openswan and strongSwan support the use of "<tt>right=%any</tt>"
for Preshared Keys as well as certificates. <br>
</p>
<p>Note: by default my example configuration files are not activated by
default (for security reasons). You will have to change <tt>auto=<b>ignore</b>
</tt>to <tt>auto=<b>add</b></tt> if you want to enable them. </p>
<p><b><a name="SpecifyPSK">10.1.2 Specifying the Preshared Key</a></b> </p>
<p>You enter the Preshared Key in <tt>/etc/ipsec.secrets</tt>
following
the <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/manpage.d/ipsec.secrets.5.html">FreeS/WAN
guidelines</a>. On Mandrake the path can be <tt>/etc/freeswan</tt>, <tt>/etc/
openswan</tt> or <tt>/etc/strongswan</tt>. Nothing much to it. For
instance: <br>
<br>
</p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt>#</tt> <tt><br>
# Sample /etc/ipsec.secrets file <br>
# The Openswan server has an IP address of 123.123.123.123 <br>
      </tt> <tt># <br>
      </tt><tt># Preshared Keys for two clients with fixed IP addresses:<br>
      </tt></p>
      <p><tt>123.123.123.123 234.234.234.234: PSK "keyforoneclient"<br>
      </tt> <tt>123.123.123.123 111.222.111.222: PSK
"keyforanotherclient"<br>
      </tt></p>
      <p><tt># Preshared Key for clients connecting from any IP address:<br>
123.123.123.123 %any: PSK "keysharedbyallclients"<br>
      </tt><tt># (Line above only works on recent versions of Openswan).</tt><br>
      </p>
      <p><tt># There is a subtle difference with the following<br>
# (see also 'man ipsec.secrets') which affects NATed<br>
# clients that use a PSK:<br>
# 123.123.123.123 : PSK "keysharedbyallclients"<br>
      <br>
      </tt><tt> </tt></p>
      </td>
    </tr>
  </tbody>
</table>
<p><a name="PFS"></a><b>10.2 Perfect Forward Secrecy</b> </p>
<p><a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/glossary.html#PFS">Perfect
Forward Secrecy</a> (PFS) provides extra security. When you enable PFS,
your adversaries (hackers, competitors, law enforcement, the mob etc.)
cannot decipher packets previously sent through the IPsec connection, <i>even</i>
if they eavesdropped on the encrypted connection <i>and</i> they have
your secret key (through hacking, court order, escrow etc.). This
property of PFS is also known as "escrow-foilage".<br>
</p>
<p>As you can see in the example above, there is a line: </p>
<p><tt>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pfs=no</tt> </p>
<p>This parameter is required because Apple's and Microsoft's
L2TP/IPsec
clients do not enable PFS. Openswan, on the other hand, enables PFS by
default. (One could only speculate why PFS is not used by Apple and
Microsoft as a default. Is it because of the<i> &lt;insert your
favourite
3-letter government agency&gt;</i>?).</p>
<p>The easiest way to solve this interoperability problem is to disable
it explicitly in Free/SWAN. But <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/interop.html#req.features">this</a>
is what the FreeS/WAN team says about it: </p>
<blockquote>"The FreeS/WAN default is <tt>[pfs=yes]</tt>. We see no
reason not to; this is more secure and costs little. The PFS settings
on
the two ends must match. You can turn PFS off in FreeS/WAN with
the&nbsp; <tt>pfs=no</tt>&nbsp;&nbsp; setting in ipsec.conf(5), but if
possible we suggest you enable PFS on the other end instead. That is
more secure".</blockquote>
They may be right but in this case it is much more work. 'The other
end' means the Microsoft client or Mac OS X v10.3+. Enabling PFS on the
MSL2TP client is done by <a href="http://www.jacco2.dds.nl/networking/msl2tp.html#EnablingPFS">editing
the
Windows registry</a>. This could be a bit dangerous and perhaps even
too
advanced if you let your users do it. So the alternatives are changing
the PFS setting on each and every client, or disabling PFS by adding
one
line at the server side. Unfortunately, I don't know how to enable <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#PFS">PFS for L2TP/IPsec on Windows
2000/XP/Vista</a> or <a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html#PFS">Mac OS X 10.3+</a>
using their graphical interfaces.<br>
<p>Note that Openswan will use PFS when the client asks for it, even
when <tt>pfs=no</tt> is specified in the Openswan configuration.
Openswan will ignore the <tt>pfs=no</tt> for that particular client
because PFS is more secure and if the client supports it, why not use
it? So <tt>pfs=no</tt> allows you to connect with clients that are
configured with or without PFS. </p>
<p>In short, if you see the following error in your Openswan logs: </p>
<p><tt>&nbsp;&nbsp;&nbsp;&nbsp; "we require PFS but Quick I1 SA
specifies no GROUP_DESCRIPTION"</tt> </p>
<p>...the simplest solution would be to add the line&nbsp;&nbsp; <tt>pfs=no</tt>&nbsp;
to your Openswan configuration. </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="ConfiguringMSclients"></a><b>11. Configuring the L2TP/IPsec
clients</b>
<p>I assume that you have configured Openswan at this stage. Now it is
time to install and configure the L2TP/IPsec clients. This depends on
the type(s) of clients you use (Windows 2000/XP/Vista, SoftRemote, Mac
OS X
10.3+,
Pocket PC etc.). See the <a href="#Introduction">list of clients</a>
at
the top of this page.</p>
<p>After you have configured your client(s), you can use it to initiate
the VPN connection. It will first try to set up an IPsec connection and
then an L2TP connection.<br>
</p>
<p><a href="#Contents">Back to Contents</a> </p>
<hr width="100%"> <br>
<a name="InitiatingIPsec"></a><b>12. Initiating the IPsec connection</b>
<p>Initiate ('dial') the VPN connection. The procedure for this depends
on the type of client (see the previous section). The client <i>will</i>
report an error ("The computer you are dialling is not responding" or
something similar). The error is correct: you do not have an L2TP
server
yet so just ignore the error for the moment. </p>
<p>The IPsec connection should come up successfully, though. You can
check that in the Openswan logfile (normally <tt>/var/log/secure</tt>)
which should look similar to this: </p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
Nov&nbsp; 1 14:09:59 xxx Pluto[yyy]: "L2TP-PSK" #7: responding to Main
Mode</tt> <br>
      <tt>Nov&nbsp; 1 14:09:59 xxx Pluto[yyy]: "L2TP-PSK" #7: Peer ID
is ID_IPV4_ADDR: '234.234.234.234'</tt> <br>
      <tt>Nov&nbsp; 1 14:09:59 xxx Pluto[yyy]: "L2TP-PSK" #7:
STATE_MAIN_R3: sent MR3, ISAKMP SA established</tt> <br>
      <tt>Nov&nbsp; 1 14:09:59 xxx Pluto[yyy]: "L2TP-PSK" #8:
responding to Quick Mode</tt> <br>
      <tt>Nov&nbsp; 1 14:10:00 xxx Pluto[yyy]: "L2TP-PSK" #8:
STATE_QUICK_R2: IPsec SA established<br>
      <br>
      </tt></p>
      </td>
    </tr>
  </tbody>
</table>
<p><br>
</p>
<p>If you see this, congratulations! You've got the IPsec part nailed.
Continue with the L2TP part below. If not, check your configuration or
go to '<a href="#Troubleshooting">Troubleshooting</a>'. </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="L2TPoverview"></a><b>13. L2TP overview</b>
<p>The IPsec connection you just configured is to be used for
tunnelling the <a href="http://www.ietf.org/rfc/rfc2661.txt">L2TP</a>
protocol (L2TP over IPSEC is defined in <a href="http://www.ietf.org/rfc/rfc3193.txt">RFC 3193</a>). L2TP on its
turn will tunnel PPP and PPP is to tunnel the actual payload. This
means
you will need an L2TP server on your Linux system. I am aware of the
following open source implementations: </p>
<ul>
  <li> <a href="http://l2tpd.sourceforge.net/">l2tpd</a>: originally by
Mark
Spencer, Jeff McAdams and others (project webpage previously at <tt>http://www.marko.net/l2tp/</tt>
and <tt>http://www.l2tpd.org</tt>). Now maintained by Damion de
Soto and Robert Vogelgesang, but development seems to have stalled.
Included with Debian/Ubuntu and Mandriva.<br>
  </li>
  <li><b><a href="http://www.xelerance.com/software/xl2tpd/">xl2tpd</a></b>:
a version of l2tpd by <a href="http://www.xelerance.com/">Xelerance</a>,
the main authors of Openswan. In active development. xl2tpd is included
with
Fedora and Debian/Ubuntu. The upcoming version 1.2.x is expected to
support the PPPoL2TP module (<tt>CONFIG_PPPOL2TP</tt>) that is included
in Linux kernel 2.6.23+. Data packets will then be processed by the
kernel (fast!), only the control messages will be processed by the
userland daemon. </li>
  <li> <a href="http://sourceforge.net/projects/rp-l2tp/">rp-l2tp</a>:
an L2TP server implementation by <a href="http://www.mail-archive.com/l2tpd-devel@l2tpd.org/msg00153.html">Roaring
Penguin</a>, of <a href="http://www.roaringpenguin.com/pppoe/">rp-pppoe</a>
fame. Development
has stalled.<br>
  </li>
  <li><b><a href="http://opensource.katalix.com/openl2tp/">OpenL2TP</a></b>:
already supports the PPPoL2TP module in Linux kernel 2.6.23+. A patch
is available for older kernel versions, which requires (re-)compiling
the PPPoL2TP module for
those kernel versions. Binary RPMs are available for some
distributions.
When used with Openswan or ipsec-tools (racoon) OpenL2TP <a href="http://opensource.katalix.com/openl2tp/quick_start.html">has
been
tested</a> with several L2TP/IPsec clients and servers including
Windows
2000/XP, Mac OS X and Draytek. It has also been tested with a Cisco
3600 router and a commercial <a href="http://www.ixiacom.com/">IXIA</a>
network protocol tester in configurations without IPsec. In active
development. </li>
  <li><b><a href="http://l2tpns.sourceforge.net/">l2tpns</a></b>: this
is an
L2TP
server with an integrated PPP server by Optus Internet Engineering.
The functionality of the PPP server is limited, compared to pppd.
Unlike l2tpd, it cannot be used as a client, only as a server. "l2tpns
does not
require pppd or any kernel patches. It can support up to 65535 active
sessions on a single box. Also supports ISP features like speed
throttling, walled garden, usage accounting, and more". An example
L2TP/IPsec configuration is provided by <a href="http://thundarr.its.hawaii.edu/advanced/make_work/IPSec/Openswan_Windows_x509/index.html">Alan
Whinery</a> and another one by <a href="http://www.wogri.at/RoadWarrior-VPN.249.0.html">Wolfgang
Hennerbichler</a>. l2tpns is in active development and appears to be
the
preferred L2TP daemon in Debian/Ubuntu.<br>
  </li>
  <li> <a href="http://sourceforge.net/projects/l2tp/">l2tp</a>: a
kernel-mode implementation. Seems to be defunct, no new versions since
January 2002.</li>
  <li>Apple's <a href="http://darwinsource.opendarwin.org/10.3.7/ppp-144.3/Drivers/">L2TP
client plugin</a> for pppd. I don't know if this one can be used for
anything else but Mac OS X (there is also an L2TP kernel extension?).
Is the server part from Mac OS X Server available as well?<br>
  </li>
  <li> <a href="http://sourceforge.net/projects/internet-l2tp/">internet-l2tp</a>:
= l2tpd + wrapper scripts in Portuguese?</li>
  <li><a href="http://www.dellroad.org/sl2tps/">sl2tps</a> is a simple,
statically configured L2TP server for FreeBSD (alpha quality). It
probably won't run on Linux but I am just mentioning it for
completeness.<br>
  </li>
</ul>
I have mainly used l2tpd and its fork xl2tpd. It was the first L2TP
server available, it has been released under the GPL and it is probably
the easiest L2TP server to use because of three reasons:<br>
<ol>
  <li>L2tpd has a simple configuration file called <tt>l2tpd.conf</tt>
which is reasonably intuitive to configure.<br>
  </li>
  <li>L2tpd runs in user mode so there is no kernel recompilation
needed. Recompiling the kernel is often a lot of trouble.<br>
  </li>
  <li>L2tpd has built-in support for IP pools which means that l2tpd
can dynamically assign internal IP addresses from a pool that l2tpd
maintains. The other L2TP servers require installation of a RADIUS
server to maintain an IP pool.</li>
  <li>L2tpd uses pppd. This is a well-known PPP implementation which is
very complete and has several authentication options and plugins.<br>
  </li>
</ol>
There are also some drawbacks:<br>
<ol>
  <li>L2tpd runs in user mode and uses pppd, so it is slower than
kernel mode L2TP
servers.</li>
  <li>L2tpd is in maintenance mode. No new features are to be expected,
but bugfixes and security vulnerabilities will be fixed if reported.
There
is <a href="http://sourceforge.net/mailarchive/forum.php?forum_id=2492">not
a very active
user community</a> (<a href="http://l2tpd.graffl.net/threads.html">older
archive</a>).</li>
  <li>There are some concerns about the code quality and possibly
security issues in l2tpd.<br>
  </li>
</ol>
It seems to me that l2tpd is great to get started and easy to use
for small setups. However, for a serious deployment with a considerable
number of clients, you will
probably want to use one of the other L2TP servers: rp-l2tp, l2tpns or
possibly
OpenL2TP. For practical use you will also need a RADIUS, LDAP or other
authentication
server. <a href="http://www.debian.org/">Debian</a>, for instance, now
prefers l2tpns over l2tpd.<br>
<br>
The
authors of l2tpd, rp-l2tp, l2tpns and OpenL2TP use their
software in commercial settings. However, I don't know how robust these
L2TP
implementations are. I have confidence in Openswan, and pppd is used
by
lots of people all over the world, but Open Source L2TP implementations
are
fairly new
on the scene. Emphasis seems to be on functionality. Security
may not have been that much of a concern. This may not be too much of a
problem, as long
as the L2TP server is not exposed directly to the Internet (see these <a href="#Firewallwarning">security considerations</a>). That is because
users can only access the L2TP daemon once they have
been authenticated through Openswan, which <i>was</i> designed with
security in mind.
<p><a name="radius"></a>Dossy Shiobara <a href="http://l2tpd.graffl.net/msg00933.html">reports</a> that rp-l2tp
works for L2TP/IPsec, which I can confirm. One thing to note is that
both l2tpd
and rp-l2tp use the same location for their daemon: <tt>/usr/sbin/l2tpd</tt>.
That is very unfortunate but in most cases you will only install one of
these two daemons so it should not be that much of a problem. Rp-l2tp
seems to have a better code
base than l2tpd.<br>
</p>
<p>Most of the L2TP daemons (l2tpd is the exception) have the <a href="http://l2tpd.graffl.net/msg00957.html">drawback</a> that they
cannot assign dynamic internal (virtual) IP addresses by themselves.
This
is not an
issue if you want to assign fixed
internal addresses to your users. But this is a problem if you want to
assign dynamic IP addresses to users. Three solutions have been
proposed: the L2TP servers could be extended so that they
hand out IP addresses dynamically. This approach more or less violates
the OSI networking layering model but this is how l2tpd does it.
Nobody
has implemented this solution for the other L2TP daemons (yet). The
second solution is
to let the PPP server obtain IP addresses from a DHCP server that you
already might have on your network. For this to work you need a pppd
plugin called <a href="http://www.netservers.co.uk/gpl/"><tt>ppp-dhcp</tt></a>
(for more information read <a href="http://l2tpd.graffl.net/msg01111.html">this thread</a>, with
additional configuration tips by Ben McKeegan in <a href="http://l2tpd.graffl.net/msg01476.html">this thread</a>). The
third solution is to use pppd version 2.4.2 or later which supports
RADIUS (alternatively, there is a <a href="http://www.chelcom.ru/%7Eanton/projects/pppd-tacacs+radius/">plugin
for pppd 2.4.1</a> by Anton Voronin, see also <a href="http://www.mail-archive.com/l2tpd-devel@l2tpd.org/msg00871.html">this
post</a>). The RADIUS solution is of course the most flexible but it
requires
a RADIUS server which adds to the complexity, especially if you have
only a few users. Your RADIUS server must support a feature called "IP
pools" if you want
to use it with PPP (I believe <a href="http://www.freeradius.org/">FreeRADIUS</a>
does). </p>
<p>Except when you use l2tpns, you will also need a PPP server since
L2TP is used to tunnel PPP. Most distributions ship with a PPP server
(pppd). No sample PPP configuration files were included with l2tpd, so
I
made some myself (included with the l2tpd RPM mentioned <a href="#L2TPconfigLinux">above</a>). Again, I don't claim that these
are the best but they should get you started. Finetuning the l2tpd and
pppd
configuration and/or switching to a different L2TP implementation may
be required for the best results.<br>
</p>
<p>According to Wolfgang Hennerbichler, <a href="http://www.wogri.at/RoadWarrior-VPN.249.0.html">Windows
2000/XP/Vista and Mac OS X also
support DHCP</a> in order to retrieve settings such as domain names,
static routes etc. from the VPN server. You need a DHCP
server that supports "DHCP Informational" messages, such as <a href="http://www.isc.org/sw/dhcp/">ISC DHCPD</a>
3.x or higher. Only Mac OS X 10.5 ("Leopard") and Windows 2000/XP/Vista
clients support these messages at this time.<br>
</p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="L2TPconfigLinux"></a><b>14. L2TP installation and
configuration (Linux)</b>
<p>Probably the easiest way to install l2tpd is to get it readily
packaged for your distribution. </p>
<ul>
  <li><b>Mandrake</b>: there is an <a href="http://www.rpmfind.net/linux/rpm2html/search.php?query=l2tpd">RPM
in Cooker</a>, the development branch of Mandrake. I have modified
Mandrake's RPM and created a new one which can be used with Openswan.
You might want to use my RPM listed below, instead of the original.</li>
  <li><b>Red Hat</b> or <b>SuSE</b>: you can use my RPMs listed below.</li>
  <li><b>Debian</b>: xl2tpd is in the <a href="http://packages.debian.org/sid/xl2tpd">unstable tree</a>, l2tpd
is in the <a href="http://packages.debian.org/etch/l2tpd">stable tree</a>,
and l2tpns is in <a href="http://packages.debian.org/sid/l2tpns">both</a>.
Executing an '<tt>apt-get
install xl2tpd</tt>' (or likewise for <tt>l2tpd</tt>) should get you
started. Alternative, you can use my
RPM
processed through <tt>alien</tt>, as reported by Nicolas Pouvesle:<br>
    <ul>
      <li><tt>apt-get install rpm</tt></li>
      <li><tt>rpmbuild --rebuild l2tpd-0.69-10jdl.src.rpm</tt></li>
      <li><tt>alien /usr/src/RPMS/i386/l2tpd</tt><tt>-0.69-10jdl</tt><tt>.rpm</tt></li>
      <li><tt>dpkg -i l2tpd</tt><tt>-0.69-10jdl</tt><tt>.deb</tt><br>
      </li>
    </ul>
  </li>
  <li><b>Gentoo</b>: it's in <a href="http://packages.gentoo.org/search/?sstring=l2tp"><tt>net-dialup</tt></a>.<br>
  </li>
  <li>If you have another <b>distribution that supports RPM</b>, you
could try to modify my Source RPM. Please send your changes to <a href="http://www.jacco2.dds.nl/contact/index.html">me</a> so that I can incorporate them
into
my spec file.</li>
  <li>If you have a <b>different distribution</b>, you might have to
compile l2tpd yourself. Download the l2tpd tarball from the <a href="http://l2tpd.sourceforge.net/">l2tpd website</a>. Also download
my
tarball (listed below) which contains additional patches. It contains
two patches that are mutually exclusive: <tt>l2tpd-pty.patch.bz2</tt>
and <tt>l2tpd-pty.patch2.bz2</tt>. <i>Apply only one of these two
patches!</i> The second one seems to work better for me, but it may be
different for your distribution. Once you have applied the patches,
l2tpd should compile by simply typing 'make'. Note that (lacking a
startup script for your distribution) you may need to use l2tpd in
daemon mode by starting it with the parameter<tt> -D</tt>.<br>
  </li>
</ul>
<a name="download_l2tpd"></a>l2tpd RPMs by <a href="http://www.jacco2.dds.nl/contact/index.html">me</a>
(based on the Mandrake Cooker RPM by Lenny Cartier and Per
&Oslash;yvind
Karlsen):
<p><tt>&nbsp;&nbsp; Source RPM: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.jacco2.dds.nl/networking/SRPMS/l2tpd-0.69-12jdl.src.rpm">l2tpd-0.69-12jdl.src.rpm</a>&nbsp;
(based on the l2tpd version of</tt><tt> August 20, 2002)</tt><tt><br>
</tt><tt>&nbsp;&nbsp; Source RPM: &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="http://www.jacco2.dds.nl/networking/SRPMS/l2tpd-0.69cvs20051030-1jdl.src.rpm">l2tpd-0.69cvs20051030-1jdl.src.rpm</a>&nbsp;
(based on the l2tpd CVS version of Oct 30, 2005)</tt><br>
<tt>&nbsp;&nbsp; Mandrake 10.1 (x86): <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake10.1/l2tpd-0.69-11jdl.i586.rpm">l2tpd-0.69-11jdl.i586.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Mandrake 10.0 (x86): <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake10.0/l2tpd-0.69-10jdl.i586.rpm">l2tpd-0.69-10jdl.i586.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Mandrake 9.2&nbsp; (x86): <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake9.2/l2tpd-0.69-10jdl.i586.rpm">l2tpd-0.69-10jdl.i586.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Mandrake 9.1&nbsp; (x86): <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake9.1/l2tpd-0.69-10jdl.i586.rpm">l2tpd-0.69-10jdl.i586.rpm</a>
(no longer updated by Mandrake)</tt><br>
<tt>&nbsp;&nbsp; Mandrake 9.1&nbsp; (PPC): <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake9.1-PPC/l2tpd-0.69-12jdl.ppc.rpm">l2tpd-0.69-12jdl.ppc.rpm</a></tt><tt>

&nbsp;(no longer updated by Mandrake)</tt><tt><br>
</tt><tt>&nbsp;&nbsp; Fedora Core 1 (x86):</tt><tt> <a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore1/l2tpd-0.69-10jdl.i386.rpm">l2tpd-0.69-10jdl.i386.rpm</a><br>
</tt><tt>&nbsp;&nbsp; Fedora Core 2 (x86):</tt><tt> <a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore2/l2tpd-0.69-11jdl.i386.rpm">l2tpd-0.69-11jdl.i386.rpm</a></tt><tt><br>
</tt><tt>&nbsp;&nbsp; Fedora Core 3 (x86):</tt><tt> <a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore3/l2tpd-0.69-11jdl.i386.rpm">l2tpd-0.69-11jdl.i386.rpm</a><br>
</tt><tt>&nbsp;&nbsp; Fedora Core 4 (x86):</tt><tt> <a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore4/l2tpd-0.69-12jdl.i386.rpm">l2tpd-0.69-12jdl.i386.rpm</a></tt><br>
<tt>&nbsp;&nbsp; Red Hat 9.0&nbsp;&nbsp; </tt><tt>(x86)</tt><tt>:
<a href="http://www.jacco2.dds.nl/networking/RPMS/RedHat9.0/l2tpd-0.69-10jdl.i386.rpm">l2tpd-0.69-10jdl.i386.rpm</a><br>
</tt><tt>&nbsp;&nbsp; Red Hat 8.0&nbsp;&nbsp; </tt><tt>(x86)</tt><tt>:
<a href="http://www.jacco2.dds.nl/networking/RPMS/RedHat8.0/l2tpd-0.69-10jdl.i386.rpm">l2tpd-0.69-10jdl.i386.rpm</a><br>
&nbsp;&nbsp; Red Hat 7.3&nbsp;&nbsp; (x86): </tt><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/RedHat7.3/l2tpd-0.69-10jdl.i386.rpm">l2tpd-0.69-10jdl.i386.rpm</a></tt><br>
<tt>&nbsp;&nbsp; SuSE 9.1:&nbsp;&nbsp;&nbsp;&nbsp; (x86)&nbsp; <a href="http://www.jacco2.dds.nl/networking/RPMS/SuSE9.1/l2tpd-0.69-10jdl.i586.rpm">l2tpd-0.69-10jdl.i586.rpm</a>
(thanks to Bernhard Thoni)</tt><br>
<tt>&nbsp;&nbsp; <a href="http://www.jacco2.dds.nl/networking/tarballs/l2tpd-10jdl.tgz">Tar ball
(v.10jdl)</a> with software, patches, config files (<a href="http://www.jacco2.dds.nl/networking/tarballs/l2tpd-10jdl.tgz.sig">sig</a>)<br>
&nbsp;&nbsp; Versions <a href="#Notsupported">no longer supported</a>:
<a href="http://www.jacco2.dds.nl/networking/RPMS/SuSE8.0/l2tpd-0.69-8jdl.i386.rpm">SuSE 8.0</a>, </tt><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/SuSE8.0/l2tpd-0.69-8jdl.i386.rpm">Mandrake 9.0</a>,
</tt><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/SuSE8.0/l2tpd-0.69-8jdl.i386.rpm">Mandrake 8.1</a></tt><br>
</p>
<p><tt>&nbsp;&nbsp; You may need to hold the 'Shift' key while clicking
these links!</tt> </p>
<p>rp-l2tp RPMs by <a href="http://www.jacco2.dds.nl/contact/index.html">me</a>&nbsp; (based
on the ASP Linux RPM by Alexandr D. Kanevskiy):<br>
</p>
<p><tt>&nbsp;&nbsp; Source RPM: &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="http://www.jacco2.dds.nl/networking/SRPMS/rp-l2tp-0.4-2jdl.src.rpm">rp-l2tp-0.4-2jdl.src.rpm</a><br>
&nbsp;&nbsp; </tt><tt>Mandrake 10.1 (x86): </tt><a href="http://www.jacco2.dds.nl/networking/SRPMS/rp-l2tp-0.4-1jdl.src.rpm"><tt></tt></a><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake10.1/rp-l2tp-0.4-1jdl.i586.rpm">rp-l2tp-0.4-1jdl.i586.rpm</a></tt><tt><br>
</tt><tt>&nbsp;&nbsp; </tt><tt>Fedora Core 2 (x86):</tt><tt> </tt><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore2/rp-l2tp-0.4-1jdl.i386.rpm">rp-l2tp-0.4-1jdl.i386.rpm</a><br>
</tt><tt>&nbsp;&nbsp; </tt><tt>Fedora Core 4 (ppc):</tt><tt> </tt><tt><a href="http://www.jacco2.dds.nl/networking/RPMS/FedoraCore4-PPC/rp-l2tp-0.4-2jdl.ppc.rpm">rp-l2tp-0.4-2jdl.i386.rpm</a>
(l2tpd does not seem to work on FC4-PPC)</tt><br>
<tt><a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake10.1/rp-l2tp-0.4-1jdl.i586.rpm"></a></tt></p>
<p>The RPMs have been signed with <a href="http://www.jacco2.dds.nl/contact/index.html#RPMsecurity">my PGP key</a>. I have built
several binary RPMs for your convenience but I recommend you get the
source RPM, inspect the SPEC file, download the original tarball and
the
patches from their original locations, review all source files for
backdoors and other security risks and then build the RPM yourself.
It's
a lot more of a hassle, but security has its price... :-) (At least
with
open source software you get the chance to inspect the source!). Note
that the RPM spec file defaults to Red Hat/Mandrake/Fedora. You will
need to set a
boolean variable for SuSE. </p>
<a name="l2tpd.conf"></a>I include a minimal l2tpd configuration file
with the RPMs as an
example (<tt>/etc/l2tpd/l2tpd.conf</tt>). I will discuss it here:<br>
<br>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc"><tt><br>
; Sample l2tpd.conf</tt><tt><br>
;<br>
      </tt><tt>[global]<br>
; listen-addr = 192.168.1.98<br>
      <br>
[lns default]<br>
ip range = 192.168.1.128-192.168.1.254<br>
local ip = 192.168.1.99<br>
require chap = yes<br>
refuse pap = yes<br>
require authentication = yes<br>
name = LinuxVPNserver<br>
ppp debug = yes<br>
pppoptfile = /etc/ppp/options.l2tpd<br>
length bit = yes<br>
      <br>
      </tt></td>
    </tr>
  </tbody>
</table>
<p>The '<tt>listen-addr</tt>' parameter has already been discussed <a href="#Firewallwarning">above</a>. By default, l2tpd will listen on
all
interfaces. The parameter '<tt>ip range</tt>' specifies a range of IP
addresses on the internal LAN that will be allocated to remote users.
With '<tt>local ip</tt>' you specify what IP address will be used by
the
Linux server on <tt>pppX</tt> interfaces created by l2tpd. Please
note: '<tt>local
ip</tt>' must be an IP address on the <b><i>internal</i></b> network
(i.e. your intranet). In the example above '<tt>local ip</tt>' is <tt>192.168.1.99</tt>.
You cannot use the IP address of the internal interface for '<tt>local
ip</tt>', nor can you use the IP address of '<tt>listen-addr</tt>'
(both are <tt>192.168.1.98</tt> in the example above). '<tt>Local ip</tt>'
should be a free IP address within the same subnet of the internal
interface.<br>
</p>
<p>CHAP is
enabled and PAP is disabled because otherwise the Microsoft clients
will
complain that the password is not encrypted (which is of course
nonsense
because the connection is already encrypted by IPsec). I also had to
set
'<tt>length bit</tt>' to yes, because the connection was unstable
without this parameter. </p>
<p> <a name="L2TPauth"></a><b>14.1 L2TP authentication and client IP
restrictions (not essential)</b> </p>
<p>IPsec supports authentication through Preshared Keys and
certificates. PPP also supports authentication e.g. through passwords;
see <a href="#L2TP-PPPencryption">below</a>). It turns out that L2TP <i>also</i>
supports authentication. The problem is that you cannot specify those
passwords anywhere in the Windows/Mac L2TP clients. I guess none of the
vendors thought that L2TP authentication was important. And rightly
so, because it does not seem very useful anyway. IPsec and PPP
authentication should be enough for anyone.</p>
<p>The confusion comes from the '<tt>require authentication</tt>'
parameter in <tt>l2tpd.conf.</tt> This parameter has <i>nothing</i>
to
do with enabling L2TP authentication. It is actually for PPP
authentication (i.e. PAP/CHAP). The Windows clients use this by
default,
so you should enable PPP authentication by including '<tt>require
authentication</tt>' in your l2tpd configuration file. </p>
<p>L2TP authentication, on the other hand, can be enabled by specifying
the parameters '<tt>auth file</tt>' and '<tt>challenge</tt>'. But as
explained above, normally you do not need L2TP authentication. </p>
<p>l2tpd can also do access control based on IP addresses. This is
slightly more interesting than L2TP authentication. However, Openswan <i>already
does</i> access control on IP addresses. You could use l2tpd's access
control as an extra security measure ('belt and suspenders' approach).
There's nothing wrong with that but it only works if you know all the
IP
addresses of the clients in advance (e.g. they all have fixed IP
addresses). This rules out "Roadwarriors" with dynamic addresses. Let's
say that you want to restrict l2tpd access to a client with the fixed
IP
address 234.234.234.234. Then your l2tpd.conf should be extended as
follows: </p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
[global]</tt> <br>
      <tt>access control = yes</tt> </p>
      <p><tt>[lns default]</tt> <br>
      <tt>lac = 234.234.234.234</tt><br>
      <br>
      </p>
      </td>
    </tr>
  </tbody>
</table>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="L2TP-PPPencryption"></a><b>15. PPP authentication, compression
and
encryption</b>
<p><b>15.1 PPP authentication: overview</b><br>
<br>
IPsec is used to tunnel L2TP, which on its turn tunnels PPP. Several
authentication methods exist for PPP. The most popular ones are PAP
(unencrypted
passwords) and CHAP (challenge/response based authentication). You are
free to choose either one of these but I recommend CHAP. If you
use PAP, the Microsoft clients will complain that the password is not
encrypted. This is besides the point because IPsec already does
encryption. Both PAP and CHAP are IETF standards but Microsoft has
'embraced and extended' CHAP into a new dialect: MS-CHAP (later fixed
as MS-CHAPv2).<br>
</p>
<p>Windows 2000/XP/Vista clients also support EAP for PPP
authentication.
This might require a <a href="http://www.samba.org/cgi-bin/ppp-bugs/trashcan?id=1109;expression=heiart;user=guest">pppd
plugin</a> by Michael Heiart which allows you to use a RADIUS server
for
EAP.<br>
</p>
The easiest way to use PAP or (MS-)CHAP is through a passwords
("secrets") file, see <a href="#PPPinstallconfig">below</a>. These
passwords are specified in the file<tt>/etc/ppp/chap-secrets</tt> or <tt>/etc/ppp/pap-secrets</tt>
which are for PAP and (MS-)CHAP, respectively. In more complex
situations
with a larger number of users, you may be looking for something more
flexible. This is a bit out of the scope of this document (it is a PPP
issue after all) but there are several possible solutions:
<ul>
  <li> Use of the "<tt>unix authentication</tt>" keyword in <tt>l2tpd.conf</tt>.
Accountnames and passwords will then be checked against the Linux user
database (<tt>/etc/passwd</tt>). What it does is add the "<tt>login</tt>"
keyword to the PPP options. Note that you will have to use PAP because
(MS-)CHAP cannot be used with pre-encrypted user passwords such as
those in <tt>/etc/passwd</tt>. Accountnames will still have to be
specified in <tt>/etc/ppp/pap-secrets</tt>,
but the passwords in that file can be empty strings (<tt>""</tt>) which
will cause pppd to use the Unix password. See <tt>man
pppd</tt>.</li>
  <li>Pppd version 2.4.2 and later includes a RADIUS plugin (<tt>radius.so,
radattr.so</tt>)
which allows you to authenticate PPP users against a RADIUS server.
This was mentioned <a href="#radius">above</a>. A sample setup with
RADIUS and MySQL can be found on this <a href="http://poptop.sourceforge.net/dox/radius_mysql.html">Poptop
webpage</a>. They use PPTP but the same principle can be applied to
L2TP as well. Again, if you authenticate against a Unix/Linux back-end
server, you may have to use PAP. Alternatively, you can use l2tpns
which ships an integrated PPP server and RADIUS support. </li>
  <li>Pppd version 2.4.3 and later includes a
Winbind plugin (<tt>winbind.so</tt>) from Andrew Bartlet of the Samba
team, which provides the ability to authenticate users against a Samba
or Windows domain controller (Active Directory or NT domains) using
MS-CHAP or MS-CHAPv2. Andrew has
also released <a href="ftp://ftp.samba.org/pub/unpacked/lorikeet/pppd/final-report.pdf">documentation</a>
about such a setup. A <a href="http://www.members.optushome.com.au/%7Ewskwok/poptop_ads_howto_1.htm">similar
Howto</a> for using MS-CHAPv2, Samba, Kerberos and Active Directory is
available from Wing S Kwok. Both authors assume you are using PPTP but
for L2TP/IPsec you can use the same procedure. Just skip the
PPTP (Poptop) parts and use the regular pppd daemon. Alternatively, you
can install a RADIUS server (known as <a href="http://technet.microsoft.com/en-us/network/bb643123.aspx">IAS</a>
on Windows Server 2003 and <a href="http://technet.microsoft.com/en-us/network/bb629414.aspx">NPS</a>
on Windows Server 2008) and use it to authenticate users on Windows
Server.<br>
  </li>
  <li> Most PPP daemons are now compiled with <a href="http://www.kernel.org/pub/linux/libs/pam/">PAM</a> support.
This means you should be able to use all kinds of authentication
mechanisms. For instance, instead the Winbind plugin mentioned above
you could authenticate with modules such as <tt><a href="http://pamsmb.sourceforge.net/faq/pam_smb_faq.html">pam_smb</a></tt>
(including <tt>pam_smb_auth</tt>), <tt>pam_winbind</tt> or <tt>pam_ntdom</tt>
(discontinued) against Samba or Windows servers.</li>
  <li>To authenticate against an LDAP server, you could use try the <a href="http://sourceforge.net/projects/pppd-ldap/">pppd-ldap</a> plugin
for pppd. Alternatively, there is a <a href="http://www.kalamazoolinux.org/projects/awilliam/ldap.html">pppd
patch</a> by Adam Tauno Williams. Or you could use <a href="http://www.kernel.org/pub/linux/libs/pam/">PAM</a> in
combination
with <tt><a href="http://www.padl.com/OSS/pam_ldap.html">pam_ldap</a></tt>
(see also this <a href="http://www.tldp.org/HOWTO/LDAP-Implementation-HOWTO/pamnss.html">Howto</a>).
This has not been tested by me. <a href="http://www.wogri.at/RoadWarrior-VPN.249.0.html">Another setup</a>
by Wolfgang Hennerbichler also authenticates against an LDAP server,
but it uses RADIUS as an in-between. RADIUS is of course well-supported
by PPP. Wolfgang's setup is also based on l2tpns.<br>
  </li>
</ul>
For testing purposes, you could skip PPP authentication altogether
by specifying "<tt>noauth</tt>" in <tt>/etc/ppp/options.l2tpd. </tt>Then
it will work with any version of pppd because it won't ask the client
to do PPP authentication (of course the client still has to do IPsec
authentication). But this is not recommended for real-world usage.
Clients will be able to fake internal IP addresses if PPP
authentication is disabled.<br>
<br>
<b><a name="No_MSCHAP"></a></b><b>15.2 MS-CHAP not always supported on
Linux</b><br>
<br>
By default, Microsoft clients will want to use
MS-CHAP for PPP authentication (either MS-CHAPv1 or MS-CHAPv2, with the
exception of Windows Vista which only supports MS-CHAPv2). Obviously,
this means that MS-CHAP
support at the Linux server side is highly preferable. There are
however two things to take into account with MS-CHAP. First, if you
decided to use <a href="#L2TPoverview">l2tpns</a>
as your L2TP and PPP daemon, then you cannot use MS-CHAP. It is
currently not supported by l2tpns. A problem with older Linux
distributions is that their PPP daemons do not support MS-CHAP.
Examples of such distributions are Red
Hat Linux 9 and earlier. A solution is to configure every Windows
client
to use CHAP. Another solution is to upgrade to <a href="http://www.samba.org/ppp/">pppd version 2.4.2 or later</a> which
contains MS-CHAP(v2) support. If you
connect to a server without MS-CHAP support and the client is
configured to use MS-CHAP, pppd will complain about "<tt>auth
chap 81</tt>" and "<tt>peer will not authorize</tt>". Once you have
installed a pppd with MS-CHAP support, you enable it by adding
an extra parameter to <tt>/etc/ppp/options.l2tpd</tt>. Depending on
your
pppd version (check <tt>man pppd</tt>), you have to use:<br>
<p><tt>require-mschap-v2</tt><br>
</p>
<p>Less common are:<br>
</p>
<p><tt>require-chapms-v2</tt><br>
</p>
<p>and:<br>
</p>
<p><tt>+mschap-v2</tt><br>
</p>
<b><a name="MPPE"></a>15.3 MPPE encryption</b><br>
<br>
Microsoft has also made MPPE, an encryption protocol for PPP. It is
based on RSA Security's RC4 encryption algorithm and used in PPTP.
Normally you do not want to use MPPE in combination with L2TP/IPsec
because it means that you will have double encryption: both IPsec's and
MPPE's.
In some cases the Windows clients want to force MPPE. In that case, '<a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Disableencryption">disable encryption</a>'
on those Windows clients. Note that this may confuse the user. He has
to
disable MPPE encryption, thinking there is no encryption at all. In
reality, IPsec already provides the encryption but the user may not be
aware of this.<br>
There is a situation where you do want to use double encryption: when
the Preshared Key is public knowledge and shared by multiple
users, posted on a website somewhere. Some organisation want to
avoid using certificates by doing this but it will compromise the IPsec
encryption. Instead they rely on the MPPE encryption in the PPP stage.<br>
<br>
If the client is configured to require MPPE but the server (pppd) is
not, you would see it in the pppd logs as something like:&nbsp; <font color="#000000" face="verdana, arial, helvetica, sans-serif"><tt><small>

sent [CCP ConfRej id=0x1 &lt;mppe +H -M +S -L -D -C&gt;]</small></tt></font>
See <a href="http://pptpclient.sourceforge.net/howto-diagnosis.phtml#mppe_rbpr">this
explanation</a> of the MPPE bits.<br>
<br>
<b><a name="compression"></a>15.4 MPPC compression</b><br>
<br>
Some Windows clients also support compression. Mind you, this is PPP
compression. The Windows IPsec implementation does not support IPsec
compression (<a href="http://www.faqs.org/rfcs/rfc2393.html">IPCOMP</a>).
The compression protocol
used by
Microsoft (MPPC) is <a href="http://www.polbox.com/h/hs001/">patent
encumbered</a>
(in those countries which know software patents, mainly the US and
Japan). If you want to use MPPC nevertheless,
check the documentation for setting up <a href="http://www.poptop.org/">a
Linux PPTP server</a>.<br>
<br>
<a href="#Contents">Back to Contents</a> <br>
<hr width="100%"> <br>
<a name="PPPinstallconfig"></a><b>16.1 PPP installation and
configuration (Linux)</b>
<p>Once the L2TP connection is up, it hands over control to the PPP
daemon. Obviously you will need a PPP server. Almost every distribution
has one: <a href="http://www.samba.org/ppp/">pppd</a>. Install a
recent version, i.e. ppp 2.4.1 or higher. The
same PPP software can be used for something else as well (e.g. an
analogue
modem for dial-up purposes). Fortunately, with the parameter '<tt>pppoptfile</tt>'
in <tt>l2tpd.conf</tt> you can specify a separate PPP options file for
the L2TP daemon. </p>
<p><b>Note</b>: The PPP daemon's passwords are shared by all PPP
processes, not just the ones started by l2tpd. However, you can
restrict
the validity of usernames/passwords to certain IP addresses, such as in
this example <tt>chap-secrets</tt> file: </p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <pre><br># Secrets for authentication using CHAP<br># client&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server&nbsp; secret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IP addresses<br>jacco&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mysecret"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.1.128/25<br>*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jacco&nbsp;&nbsp; "mysecret"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.1.128/25<br>sam&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "rumpelstiltskin"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.1.5<br>*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sam&nbsp;&nbsp;&nbsp;&nbsp; "rumpelstiltskin"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.1.5<br><br></pre>
      </td>
    </tr>
  </tbody>
</table>
<br>
There are two entries for every user since both sides authenticate. In
this case, user "jacco" will get an address from l2tpd's IP address
pool
as specified in <tt>/etc/l2tpd/l2tpd.conf</tt> (in my example
configuration this is <tt>192.168.1.128-192.168.1.254</tt> which
agrees
with <tt>192.168.1.128/25</tt>). User "sam" however always gets <tt>192.168.1.5</tt>
from the PPP server. This way you can give users fixed virtual IP
addresses on your internal LAN (it seems to work, although I am not
100%
sure it works in all cases). If you don't want any restrictions on the
IP addresses, you can use the wildcard "*" as an IP address instead (I
don't recommend this since this will allow the client to determine its
own address, which may be a risk).
<p>The Microsoft clients have an option "Use Windows logon". If you
enable this, the client will want to authenticate with the username <tt>"\\DOMAINNAME\username"</tt>.
You will have to specify this username format in <tt>chap-secrets/pap-secrets</tt>
as well. </p>
<p>Configuring the PPP server is not explained here. There is lots of
documentation on this subject, for instance the <a href="http://www.linux.org/docs/ldp/howto/PPP-HOWTO/">PPP Howto</a>.
Check out my sample configuration file <tt>/etc/ppp/options.l2tpd</tt>
included with the RPMs mentioned above. </p>
<p>For simplicity, let's assume that the external interface of your
Linux server is <tt>eth0</tt> and the internal interface is <tt>eth1</tt>.
The PPP server is to provide the remote user with an IP address from
the internal (protected) network. Once the user is connected interface <tt>ppp0</tt>
will be up. My sample L2TP configuration file <tt>l2tpd.conf</tt> has
a
line '<tt>local ip</tt>'. With this parameter you specify a dedicated
IP
address for the L2TP daemon on the internal subnet. </p>
<p>Note that <tt>options.l2tpd</tt> contains the parameter <tt>proxyarp</tt>.
This parameter will set a proxy arp entry on the internal interface (<tt>eth1</tt>
in the example above) for the remote user. If this keyword is not
specified, packets from the L2TP/IPsec clients will arrive at internal
servers but those servers will not know where to send responses to
because nobody replies to its ARP requests. With the <tt>proxyarp</tt>
parameter, the machines on the internal network are fooled into sending
packets for the remote Windows clients to the gateway. The gateway has
IP forwarding on, so it knows how to send the packets through to the
Windows clients.<br>
</p>
<p><b><a name="DNS_ignored"></a>16.2 Issue: specified DNS is ignored</b><br>
</p>
<p>As you can see from the sample PPP options file (<tt>/etc/ppp/options.l2tpd</tt>),
you can specify DNS and WINS servers. Remote clients will pick these up
automatically once the connection has been established. Normally you
will want remote clients to use the same DNS/WINS servers that clients
on the internal network use. However,
<a href="http://lists.openswan.org/pipermail/users/2004-November/002832.html">it
seems</a> that a native Windows 2000/XP/Vista client will only pick up
these
DNS/WINS servers when its Internet
connection is
configured with a dynamic IP address (e.g. through DHCP or PPP's IPCP).
This puzzles me and I don't have an explanation or a workaround for
this. It could be that the DNS entry is not updated (check with <tt>IPCONFIG
/ALL</tt>
on the Windows client) but that nevertheless the correct DNS server (as
specified through the <tt>ms-dns</tt> parameter) is used.<br>
</p>
<p><b><a name="MTUproblems"></a>16.3 MTU problems</b> </p>
<p>If you see PAYLOAD_MALFORMED error or if you have intermittent
problems with your VPN connection, it could
be an MTU problem. What you might see is that you can ping machines on
the internal network and you can surf or transfer very small files, but
you can't copy large files because the connection stalls. Then try
decreasing the MTU to 1410 (or perhaps even lower?) by adding the
following parameter to <tt>/etc/ppp/options.l2tp</tt>:</p>
<blockquote><tt>mtu 1400</tt> <br>
  <tt>mru 1400</tt></blockquote>
This problem may be especially apparent if you connect through
the VPN to sites with <a href="http://www.netheaven.com/pmtu.html">broken
'Path MTU (PMTU) Discovery'</a> (a letter with an executive summary
describing
the situation can be found <a href="http://www.phildev.net/mss/mss_letter.txt">here</a>). Perhaps
people with ADSL connections that use PPTP or PPPoE have this problem
as
well. I myself had no problem with a PPTP ADSL connection ('KPN
Mxstream') which uses Alcatel equipment. Reducing the PPP packet size
does not help if the connection fails before the authentication has
succeeded. Try again with a smaller certificate and without a NATed
connection, if you can. If you use NETKEY on kernel 2.6, then <a href="http://lists.openswan.org/pipermail/users/2005-October/006947.html">kernel
2.6.12+ is recommended</a> if you experience PMTU problems. On a
2.6.12+ kernel you could do: <tt>echo "0" &gt;
/proc/sys/net/ipv4/ip_no_pmtu_disc</tt><br>
<br>
There has been some discussion
on the
FreeS/WAN mailinglist (for instance, by Sam Sgro <a href="http://www2.frell.ambush.de/archives/freeswan-users/5940.html">here</a>
and <a href="http://www2.frell.ambush.de/archives/freeswan-users/3866.html">here</a>).
The FreeS/WAN team <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/faq.html#pmtu.broken">writes</a>:
"The MTU can be changed with an <tt>overridemtu=</tt> parameter in the
config setup section of ipsec.conf". Currently this parameter is only
supported on KLIPS, not NETKEY. Other suggestions might be
reducing
the size of your certificates (shorter names, fewer X.509v3 options
etc.) or forcing your Ethernet interfaces to <a href="http://support.iglou.com/fom-serve/cache/239.html">use a lower
MTU</a>: <tt>ifconfig ethX mtu 1400</tt><br>
<br>
Another option that you might want to try on Openswan versions
before 2.4.5 is: <tt>fragicmp=no</tt><br>
<br>
Microsoft has a Knowledge Base article on how to <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;826159">change
the MTU for VPN connections</a>. A ready to use batch file that changes
the MTU parameter can be downloaded from <a href="http://www.jsifaq.com/SF/Tips/Tip.aspx?id=7457">JSI FAQ</a>.
Alternatively, there is a registry patch file that can be downloaded
from <a href="https://www.publicvpn.com/support/VPNMTU.zip">PublicVPN.com</a>
(sets an MTU size of 1200).
There is a similar KB article <a href="http://support.microsoft.com/default.aspx?scid=KB;EN-US;Q314053">here</a>
which
explains how to set the MTU for a specific network adapter, among other
things.
Microsoft also has a troubleshooting guide for "black hole" routing
problems (<a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;q314825">Q314825</a>).
Cisco also has some documentation on this problem (<a href="http://www.cisco.com/warp/public/105/pmtud_ipfrag.html">here</a>,
<a href="http://www.cisco.com/en/US/tech/tk801/tk703/technologies_tech_note09186a0080094c4f.shtml">here</a>
and <a href="http://www.cisco.com/univercd/cc/td/doc/product/vpn/client/3_1/admin/vcach5.htm">here</a>).
<p>

In some cases (especially when certificates are used) fragmentation may
lead to a problem with IKE. An extension to IKE has been proposed by
Cisco. This extension allows fragmented IKE packets pass through
(broken) routers which cause the
fragmentation. Openswan does not support this extension but <a href="http://ipsec-tools.sourceforge.net/">ipsec-tools</a> (racoon)
does.
Fragmentation is less likely with PSKs. Other options might be to
reduce the size of certificates (e.g. by reducing the size of the RSA
key,
shortening the Distinguished Name fields or removing extended
attributes) and eliminating (NAT) devices that don't support fragments.<br>
<br>
Another option is to "<a href="http://lists.openswan.org/pipermail/users/2006-November/011164.html">clamp</a>"
the Maximum Segment Size (<a href="http://iptables-tutorial.frozentux.net/chunkyhtml/x4700.html">MSS</a>)
of the application protocols that are sent through the VPN. This only
works with TCP protocols, not with UDP based protocols.<br>
<br>
<b><a name="ppp_unit"></a>16.4 Tip for multi-homed DSL users</b><br>
<br>
Most DSL users have a static IP address or a dynamic IP address
assigned through DHCP. However, some DSL services use PPP for the
Internet connection (e.g. through
PPTP or PPPoE). If you have such a DSL service, you often use interface
<tt>ppp0</tt> for your
Internet connection. And when you decide to use an L2TP/IPsec VPN over
that Internet
connection, the PPP daemon spawned by the L2TP daemon will
automatically pick the next free interface
name, <tt>ppp1</tt>.<br>
<br>
However, a problem might arise when you have multiple DSL links and one
of them goes down for some reason
and then comes
up again. In the mean time, the PPP interface might have been picked up
by an L2TP/IPsec client because pppd detected that it was free. This
might screw up several of your settings, for instance, your firewall
rules might expect the DSL links on fixed PPP interfaces.<br>
<br>
A workaround for this problem is adding the parameter '<tt>unit xxxx</tt>'
to the PPP options file for your DSL links, where <tt>xxxx</tt> is a
high number, say 1000. Each DSL link will have to have a unique PPP
interface (<tt>ppp1000</tt>,<tt> ppp1001</tt> resp.) that does not
conflict with the lower PPP unit numbers which are reserved for
L2TP/IPsec client (<tt>ppp0</tt>,<tt> ppp1</tt>, etc.).<br>
<br>
You do need <a href="http://www.samba.org/ppp/">ppp-2.4.2</a> or
higher for this particular '<tt>unit</tt>' parameter. The <a href="http://www.strw.leidenuniv.nl/cgi-bin/man?program=pppd&section=8">pppd
man page</a> says that the parameter only works for outbound
connections but it works for incoming connections too (looks like an
undocumented
feature in pppd?). The '<tt>unit</tt>' parameter does not have to be
used in <tt>/etc/ppp/options.l2tpd</tt>, only in the PPP options files
of your DSL links. This workaround should work
as long as the highest PPP unit number assigned to the DSL links is
higher than the total number of clients.
<br>
</p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="InitiatingIPsec"></a><b>17. Initiating the L2TP/IPsec
connection once again</b>
<p>At this point you should have IPsec, L2TP and PPP configured. Try
initiating the VPN connection on the Windows or Macintosh client again.
The
procedure
is the same as <a href="#InitiatingIPsec">described above</a>.
But
this time the L2TP connection should come up as well. If it does,
congratulations, you've got a working L2TP/IPsec setup! If it does not
work, check and double check your settings. See also '<a href="#Troubleshooting">Troubleshooting</a>'.<br>
</p>
<p>There are two final checks that I highly recommend before you
consider rolling out to a live network:<br>
</p>
<ol>
  <li>Put a third
machine between the client and the
server. You should be then use that machine to sniff the communication
between the
client and the server with a network monitoring program such as tcpdump
or Ethereal. The packets should be encrypted. If you see unencrypted
packets (e.g. plain text L2TP), there is something wrong in your setup.</li>
  <li>Use <a href="http://www.insecure.org/nmap/index.html">nmap</a>
(or any other good portscanner) on the client and scan for open UDP
ports on the server: <tt>nmap -sU 123.123.123.123</tt>. You should <i>not
    </i>see the L2TP daemon (UDP port 1701). The only open ports should
be UDP 500 (IKE) and optionally UDP 4500 (NAT-T).<br>
  </li>
</ol>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="RemarksonIPsec"></a><b>18. Some remarks on L2TP/IPsec</b>
<p>At one time during testing, I forgot to enter a default gateway and
a hostname in the TCP/IP settings of a Windows workstation. This was
not
really a problem since the Linux server was on the local network.
However, when I set up a connection from the Windows client to the
Linux
server, l2tpd complained with a rather cryptic error message in <tt>/var/log/messages</tt>:
"<tt>Specify your hostname</tt>". At first I thought that perhaps l2tpd
could not determine the hostname of the Linux server it was running on.
I solved the problem by entering a hostname on the Windows workstation.
I simply did not expect that l2tpd relied on it. </p>
<p><a href="#Contents">Back to Contents</a> </p>
<p> </p>
<hr width="100%"><a name="NAT"></a><b>19. NAT-Traversal</b>
<p><b>19.1 Introduction</b><br>
</p>
<p>If you don't need NAT-Traversal
(or if you don't want to deal with the complications at this moment)
you
can <a href="#WindowsNetworking">skip
this part</a>. </p>
Sometimes Network Address Translation (NAT) is used between the
client and the IPsec server, e.g. when the user has networked his home
and all his computers are sharing the same Internet connection through
a
NAT router. Another case where NAT is used is when the VPN server
itself is behind a NAT device (UDP ports 500 and 4500 are forwarded to
the VPN server). In some situations even both the client and the server
may be behind NAT. Some ISPs also use NAT on the route. I have also
read
reports that many GPRS providers employ NAT, i.e. they assign <tt>10.x.x.x</tt>
or <tt>192.168.x.x</tt> addresses to GPRS phones.&nbsp;<br>
<p>NAT changes packets on the fly. The problem is that this kind of
'tampering' is exactly what a VPN tries to prevent! Fortunately, some
NAT devices support 'IPsec passthrough' which allows IPsec to be used
through the device. However, it seems that IPsec passthrough only works
for one
user at a time, not multiple concurrent users behind the same NAT
device. I have not tested L2TP/IPsec through a NAT device with IPsec
passthrough myself, but I received a report by Tim Behrsin about '<tt>UDP:
bad checksum</tt>' problems. Some NAT devices are broken in the sense
that you cannot disable IPsec passthrough (the SMC 2804 comes to
mind?). Pure IPsec on the other hand has been
reported to work with these devices (i.e. Tunnel Mode, not L2TP/IPsec
in Transport Mode).<br>
</p>
<p>Instead of modifying the NAT device, you could modify the IPsec
standard itself. And this is exactly what has happened. Extensions to
IPsec are in development so that you can set up IPsec connections
through a NAT device without IPsec passthrough support. This is called
"NAT-Traversal" (NAT-T) which was published by the IETF as a Proposed
Standard, <a href="http://www.ietf.org/rfc/rfc3947.txt">RFC 3947</a>.
Openswan versions 1.0.9+ and 2.3.1+ support this RFC. The NAT-T RFC is
based on the NAT-T
requirements stipulated in
<a href="http://www.ietf.org/rfc/rfc3715.txt">RFC 3715</a>.
NAT-Traversal works around the NAT problem by encapsulating IPsec ESP
packets
within UDP (<a href="http://www.ietf.org/rfc/rfc3948.txt">RFC 3948</a>).<br>
</p>
<p><a href="http://www.computerworld.com/securitytopics/security/story/0,10801,102985,00.html?source=x73">This
article</a> by Debra Schinder
provides some more background information on NAT-Traversal. And <a href="http://www.isaserver.org/articles/IPSec_Passthrough.html">these</a>
<a href="http://blogs.isaserver.org/pouseele/2007/11/24/multiple-l2tpipsec-vpn-clients-behind-a-nat-device/">articles</a>
by Stefaan Pouseele provide detailed info on the packet
structures and mechanisms behind NAT-T. <br>
</p>
<p>NAT-Traversal is considered by Mathieu Lafon to be experimental and
unsafe
if used with L2TP/IPsec (see section 5 "Security Considerations" of the
"IPsec within UDP" IETF document mentioned above). Mathieu is one of
the
people involved with the implementation of NAT-T on Linux. Linux kernel
2.6
contains a different IPsec implementation (NETKEY) which includes
also
supports NAT-T. Apparently it has the same security issue as the
NAT-T patch for Openswan et al. The NETKEY implementation supports
racoon (from ipsec-tools) as well as Openswan/ strongSwan/ FreeS/WAN
2.x.
Switching to ipsec-tools won't fix the security issue either.<br>
</p>
<p>
</p>
<b>19.2 Limitations and requirements</b><br>
<br>
NAT-T is supported natively by NETKEY (kernel 2.6.6 or higher
required). Recent distributions such as Fedora Core 2+, Debian
"(un)stable", Mandrake 10.0+
and SuSE 9.1+ ship with a NETKEY kernel that supports NAT-T. If you use
a kernel with KLIPS instead of NETKEY, you will need
Mathieu Lafon's <a href="http://open-source.arkoon.net/">NAT-Traversal
patch</a>. Note: according to <a href="http://open-source.arkoon.net/freeswan/README.NAT-Traversal.0.6">

Mathieu Lafon</a> and Openswan team member <a href="http://lists.openswan.org/pipermail/users/2005-March/004285.html">Ken
Bantoft</a>, NAT-T in Transport Mode is (currently) unsafe.
Microsoft, SSH and SafeNet do support NAT-T but they have come
up with a workaround for the unsafe part.<br>
<br>
The NAT-T
patch for KLIPS
is not included with older Red Hat, Mandrake and SuSE
kernels (except Mandrake 9.2). For these versions you will have to
recompile the kernel, because
the NAT-T patch touches the TCP/IP part of the kernel. If you use
FreeS/WAN, this patch will also have to be applied to the FreeS/WAN
userland utilities. The userland utilities included with <a href="http://www.openswan.org/">Openswan</a>
and <a href="http://www.strongswan.org/">strongSwan</a> already contain
the patch. Transport Mode NAT-T has to be explicitly enabled on
FreeS/WAN by <a href="http://www.jacco2.dds.nl/networking/super-freeswan-ignoreTransportmodeNAT-risk.patch">patching</a>
the Makefile. Openswan and strongSwan already support Transport Mode
NAT-T.<br>
<br>
Openswan's NAT-T support is activated on both NETKEY and KLIPS by
adding
the parameter "<tt>nat_traversal=yes</tt>"
to the
configuration file <tt>ipsec.conf</tt>. Clients <i>not</i> behind NAT
are not affected by this line. Everything will still work for these
clients. For testing purposes you might be interested to know that
recent versions of Openswan can be forced to use NAT-T even if the
client and server are not behind NAT. You can do this by adding the
line "<tt>forceencaps=yes</tt>" to the connection section in ipsec.conf.<br>
<p> The NAT-T patch for KLIPS currently does not support
connections that authenticate through <a href="#Road_Warrior_support">Preshared
Keys</a> (PSKs). If you use a Preshared Key with KLIPS and NAT-T,
Openswan will not
authorise the connection because the sender's port is not 500 and the
NAT-T patch fails to support this. This should be looked into by a
programmer. PSKs have some <a href="#Road_Warrior_support">drawbacks</a>
so generally you want to use certificates anyway. The NETKEY
implementation does support PSKs but you will have to use <tt>right=%any</tt>
and use <tt>leftid=someservername</tt> and <tt>rightid=someclientname</tt>.
If you do specify an IP address with <tt>right=a.b.c.d</tt> without <tt>leftid=someservername</tt>
and <tt>rightid=someclientname</tt>, Openswan will complain about "no
connection
authorized". If you use <a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#PSK_and_NAT-T_in_Vista">Windows Vista with a
PSK</a>, and NAT is involved, you are required to use <tt>rightsubnet=vhost:%no,%priv</tt>.
This is probably true for other RFC 3947 compliant clients (such as Mac
OS X) as well.<br>
<a name="NAT-multiple-clients"></a> <br>
If you have multiple clients
behind the same NAT device, only the
first client will be able to connect. Openswan logs an error similar to
this: <tt>Virtual IP 10.0.0.1/32 is already used by 'C=NL, ST=ST, L=L,
O=TESTORG, CN=TESTUSER'</tt> (or <tt>... used by '@Pocket_PC'</tt> in
the case of a PSK). Another
limitation of Openswan is that clients cannot share the same NAT-ed
(internal)
address. This is of course
difficult
to avoid
completely, especially when there is little coordination between remote
clients. Many users will be using the same <tt>192.168.1.101</tt>
address if they are using a Linksys router, for instance. These are
limitations of
Openswan. Patrick Naubert, the CEO of Xelerance, has released <a href="http://lists.openswan.org/pipermail/users/2006-May/009487.html">this
statement</a> on the subject. He writes that they have implemented a
solution for KLIPS but they need $55,000 to recoup their costs before
they can
release the source code. Paul Wouters of Xelerance has said that <a href="http://lists.openswan.org/pipermail/users/2007-September/013069.html">perhaps
a solution is in the works</a>. A number of alternative solutions
exist. For example, <a href="http://opensource.katalix.com/openl2tp/">OpenL2TP</a>
with
ipsec-tools (racoon) does support multiple clients behind the same NAT
device. Another alternative is the <a href="http://www.stinghorn.com/opensource/">workaround</a>
by
the Finnish company Stinghorn which is based on modifications to the
Linux kernel and ipsec-tools. Some more details can be found <a href="http://www.kame.net/racoon/racoon-ml/msg00824.html">here</a>.<br>
</p>
<p></p>
<p>If you have multiple users behind the same NAT device and one client
connects to the Openswan server, the other users behind that NAT device
will not be able to set up non-IPsec connections (WWW, SSH etc.) to
that server. You can solve this by adding an extra <a href="http://lists.openswan.org/pipermail/users/2005-December/007763.html">'passthrough'
section</a> to <tt>ipsec.conf</tt> as described by Paul Wouters of the
Openswan team.<br>
</p>
<p>NAT-T is supported by almost all of the L2TP/IPsec clients. Windows
Server 2003 also
supports NAT-T (a test report can be found <a href="http://www.isaserver.org/tutorials/isaserverorgchat05292003.html">here</a>).
Microsoft has released <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">IPsec
updates</a> (MS KB Q818043) for Windows XP and Windows 2000
Professional, as <a href="http://www.nwfusion.com/news/2003/0407specialfocus.html">promised</a>.
This update is also included with XP ServicePack 2. However it turned
out that the NAT-T update had
<a href="http://groups.google.com/groups?hl=en&lr=&ie=UTF-8&selm=e709AnnJDHA.2220%40TK2MSFTNGP10.phx.gbl">issues
with some third-party applications</a> which caught a lot of
<a href="http://www.usatoday.com/tech/news/2003-05-27-xp-oops_x.htm">bad
press</a>. So Microsoft had to recall the NAT-T update. In August 2003
they <a href="http://www.w2knews.com/index.cfm?id=438">re-released</a>
it. The
patch can be installed through <a href="http://windowsupdate.microsoft.com/">WindowsUpdate</a>. If you
use Windows 2000 Professional, you will need to install <a href="http://www.microsoft.com/windows2000/downloads/servicepacks/default.asp">

ServicePack 3</a> or higher first, otherwise the IPsec update will not
show up in WindowsUpdate. For XP you will need <a href="http://www.microsoft.com/WindowsXP/sp1/default.asp"> ServicePack1</a>
or higher. If the update still does not show up in WindowsUpdate, go to
the <a href="http://v4.windowsupdate.microsoft.com/catalog">Windows
Update Catalog</a> and search for "818043" using the Advanced Search
Options feature. If you prefer to download the NAT-T update to disk and
then distribute it to multiple clients, you can use Windows Update's <a href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;323166">Download
Basket</a> or <a href="http://www.microsoft.com/windowsserversystem/sus/default.mspx">Software
Update Services</a>.<br>
</p>
<p> According to posts by Microsoft employees, updates for <a href="http://groups.google.com/groups?hl=en&lr=&ie=UTF-8&selm=eNQt4Sm8CHA.1808%40TK2MSFTNGP12.phx.gbl">Windows
2000 Server</a> and <a href="http://www.microsoft.com/technet/treeview/default.asp?url=/technet/itcommunity/chats/trans/isa/isa0129.asp">ISA
Server</a> would become available as well. I had some doubts when I
read
this because Microsoft would rather see you upgrade to Windows Server
2003 instead. It turns out I was right. Quoting Microsoft (KB <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">

Q818043</a>): <em>"NAT-T server-side support will not be added to
Windows 2000 Routing and Remote Access"</em>. Fortunately this decision
by Microsoft will not affect you if you use Linux on the server... </p>
<p>All clients except SSH Sentinel (and possibly Forticlient)
automatically detect if NAT-T has to
be enabled. SSH Sentinel has to be manually configured to use NAT-T: in
the "Properties" window of a VPN connection, select the "Advanced" tab
and enable "NAT-Traversal" (<a href="http://www.jacco2.dds.nl/networking/screenshots/sentinel/15enableNAT-Tv14.png">Sentinel 1.4</a>
screenshot). Sentinel 1.4 also has a feature called "UDP encapsulation
to port xxxx" but that variant is not supported by Linux. You will have
to use the other Sentinel option called "NAT-T".
Sentinel 1.3 has only one NAT-T variant but that is the <a href="http://www.jacco2.dds.nl/networking/screenshots/sentinel/15enableNAT-T.png">non-supported</a> type
so
you can't use it. Next, click "OK". Don't enable this option in
Sentinel
if the NAT device itself already supports "IPsec-passthrough". The
documentation of SSH Sentinel states that NAT-T cannot be used in
combination with IPCOMP, the IPsec compression protocol. This is a
limitation of Sentinel itself, not a limitation of NAT-T or IPCOMP.</p>
<a name="NAT-status"></a><b>19.3 Status of NAT-T support in L2TP/IPsec
clients</b><br>
<br>
Successfully tested:<br>
<ul>
  <li><b>Windows XP</b> Home/Professional: requires the <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">IPsec
update Q818043</a> or <a href="http://www.microsoft.com/technet/prodtechnol/winxppro/maintain/winxpsp2.mspx">ServicePack
2</a>. If you are using XP with SP2
and the Openswan server is behind NAT, you need to <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#SP2">modify a registry setting</a>.<br>
  </li>
  <li><b>Windows 2000 Professional</b>:
requires the <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">IPsec
update Q818043</a> (this update is not included in any Service Pack for
Windows 2000).</li>
  <li><b>Windows Vista</b>. If the Openswan server is behind NAT, you
need to <a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#NAT-T">modify a registry stetting</a>.
Vista supports RFC 3947, the first Microsoft operating system to do so.
If a PSK is used for authentication, you need to add a <a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#PSK_and_NAT-T_in_Vista"><tt>rightsubnet=</tt>
line</a>. </li>
  <a name="Win2000hack"></a>
  <li>Windows 2000 Server (used as a client):
is reported to work but
only through an unsupported hack.<small> (The <a href="http://support.microsoft.com/support/kb/articles/q818/0/43.asp">IPsec
update</a><a> Q818043</a> does not show up on <a href="http://windowsupdate.microsoft.com/">WindowsUpdate</a> for this
version of Windows. But what you can do is download the NAT-T patch for
Windows 2000 <i>Professional</i> and install that one. This is
probably not supported by Microsoft, i.e. it might break
your support contract. On WindowsUpdate, go to the Windows Update
Catalogue and select "Windows 2000
Professional SP3" and your language version. In the "Advanced Search"
options, select "Contains these words: 818043". Add the update to the
Download Basket, download and install).</small></li>
  <li>Windows Server 2003 used as a client: has built-in NAT-T draft-02
support ("<tt>draft-ietf-ipsec-nat-t-ike-02</tt>"). Does not support
RFC 3947.<br>
  </li>
  <li><b>MSL2TP client</b> connecting to a KLIPS-based Linux server.<br>
  </li>
  <li><b>SafeNet SoftRemote</b> versions 7.0.5 and 9.2.1 (KLIPS only?)<br>
  </li>
  <li><b>SSH Sentinel</b> version 1.4.1 build 98 connecting to a KLIPS
based
server. There is however a problem with disconnecting. Sentinel does
not
seem
to send "Delete SA" packets. Openswan still thinks there is an IPsec
connection, so the client will not be able to access services on the
external interface of the Linux machine until the IPsec connection
times
out. (Note: SSH Sentinel has been discontinued, but an upgrade
from full version 1.4 to 1.4.1 is still available <a href="http://www.hullomail.net/support/ssh141parts.shtml">here</a>). </li>
  <li><b>Windows Mobile 6, Windows Mobile 5.0</b> and <b>Pocket PC 2003</b>
connecting
with a
certificate: works, but only if the certificates are
small in size (<a href="http://www.jacco2.dds.nl/networking/openswan-pocketpc.html#Discussion">fragmentation
problem</a>?).</li>
  <li>Windows Mobile 6, Windows Mobile 5.0 and Pocket PC 2003
connecting with a Preshared Key to a NETKEY based
server.</li>
  <li><b>Mac OS X 10.4</b> Tiger: preferably use Mac OS X 10.4.4 or
higher because these support RFC 3947. If you still have 10.4.0-10.4.3,
use at least Openswan 2.4.5.<br>
  </li>
  <li><b>Mac OS X 10.3</b> Panther: get Mac OS X 10.3.6+ and Openswan
2.4.5+. Mac OS X 10.3 only supports PSK authentication. It does not
support certificates with L2TP/IPsec.</li>
</ul>
Probably working:<br>
<ul>
  <li><b>Mac OS X 10.5</b> Leopard.<br>
  </li>
  <li>Windows Mobile based Smartphones. I can create an L2TP/IPsec VPN
connection but I don't know how to initiate this connection.<br>
  </li>
</ul>
Not working:<br>
<ul>
  <li>Mac OS X 10.3 Panther connecting to a server that requires
certificate authentication. Panther's GUI does not support certificates
with the L2TP/IPsec protocol.</li>
  <li>MSL2TP client connecting to NETKEY based server. (Client rejects
packets with an "INVALID_SPI" error. Floating port
confuses client?).</li>
  <li>Pocket PC 2003 or Windows Mobile connecting with a Preshared Key
to a KLIPS based
server: the NAT-T patch does not
support PSKs on KLIPS.</li>
  <li>SSH Sentinel version 1.4.1 build 98 connecting to a NETKEY based
server. (Client rejects packets?).<br>
  </li>
  <li>SSH Sentinel version 1.4 build 177 (discontinued, but evaluation
version still available at <a href="http://english.cyprotect.com/main0173.php">CyProtect</a>):
'Diagnostics' works. 'Select VPN' fails: no tunnel is set up. In fact,
Sentinel does not send any (IPsec) packets at all (routing bug?).</li>
  <li>SSH Sentinel version 1.3 or lower (discontinued): uses a
non-standard
NAT-T protocol which is not supported by the NAT-T patch.</li>
</ul>
<ul>
</ul>
<b>19.4 Preparing for NAT-T</b><br>
<b><br>
</b>The procedure for enabling NAT-T starts with determining whether
the kernel included with your distribution supports either NETKEY or
KLIPS. If your kernel support NETKEY, then it already has kernel
support
for NAT-T. If your distribution's kernel does
not contain either NETKEY or KLIPS, then it obviously lacks NAT-T
support for IPsec. Even if your kernel supports KLIPS, it probably
does not support NAT-T
yet (Mandrake 9.2 is an exception).&nbsp; Distributions that do not
ship with any IPsec support at all or with a KLIPS-based kernel without
NAT-T patch will probably require installation of a new kernel. If you
do need to install and reboot to a new kernel RPM, be sure to take the
usual precautions with kernel RPMs, i.e. <i>do
not upgrade</i> but install the new kernel in addition to the current
kernel and add an entry for the new kernel to lilo.conf. Then rerun
lilo (or use GRUB).<br>
<br>
<b>19.4.1 Using NAT-T with NETKEY based kernels</b><br>
<br>
The NETKEY
implementation supports NAT-T with authentication through certificates
but also through PSKs, unlike the NAT-T
patch for KLIPS. However, you cannot specify a fixed IP address with
the <tt>right=a.b.c.d</tt> parameter. You will have to specify <tt>right=%any</tt>
and use <tt>leftid=</tt> / <tt>rightid=</tt>, which means
that the PSK is shared by all Road Warriors. You will also have to use <tt>%any</tt>
in <tt>ipsec.secrets</tt>:<br>
<br>
<tt>123.123.123.123 %any: PSK "thisismytopsecretkey"</tt><br>
<br>
I could not use the
l2tpd parameter
<tt>listen-addr</tt> because NETKEY does not use <tt>ipsec0</tt>
style interfaces. <br>
<br>
<b>19.4.2 Using NAT-T with KLIPS based kernels</b><br>
<br>
Preshared Keys are not supported by the NAT-T patch for KLIPS. Using
NAT-T with KLIPS on kernel 2.6 is currently not supported. The Openswan
team is working on this. NAT-T with KLIPS on kernel 2.4 does work.<br>
<br>
<b>19.5 Distribution-specific information regarding NAT-T</b><br>
<b><br>
</b>The sections below contain information on how to obtain support for
NAT-T on several Linux distributions.<b><br>
<br>
</b><b>19.5.1 Red Hat Linux, Fedora Core 1<br>
<br>
</b>I recommend&nbsp;the RPMs made by Axel Thimm for Red Hat
Linux 7-9 and Fedora Core 1. You
will need Axel's <a href="http://atrpms.net/name/openswan/">Openswan
userland utilities RPMs</a> and <a href="http://atrpms.net/name/kernel/">kernel</a> with built-in
Openswan support. Do <i>not</i> install Axel's Openswan kernel-module
RPM (<tt>kernel-module-openswan-*.rpm</tt>) because it does not add
support for NAT-T. Axel's kernel RPM provides the NAT-T support.<br>
<br>
<b>19.5.2 Fedora Core 2+, RHEL</b><br>
<br>
Fedora Core 2+ and Red Hat Enterprise Linux ship with a NETKEY enabled
kernel so they support NAT-T out of the box. Reminder: Fedora Core 2+ <a href="#Legacy_pty_problem">does not support Legacy PTYs</a> so you
need a recent l2tpd RPM version.<br>
<p> <b>19.5.3 Mandrake 10.x, Mandriva 2005+<br>
</b></p>
<p>Mandrake 10.x and Mandriva 2005+ ship with a 2.6 kernel so it
supports NAT-T out of
the box. Mandrake 10.0 ships with a
FreeS/WAN 2.04 userland utilities RPM which does not support NAT-T.
The FreeS/WAN 2.06 included with Mandriva 2005+ and Mandrake 10.1 does
not support Transport Mode so
L2TP/IPsec with or without NAT-T will not work. Mandrake 10.0+ and
Mandriva 2005-2006 ship with a SuperFreeS/WAN RPM but it does not
support NETKEY so
it
will not work either. One solution is to use the Openswan or strongSwan
userland RPM from the contrib directory or Mandriva Cooker. Reminder:
Mandrake 10.1 and Mandriva <a href="#Legacy_pty_problem">do
not support Legacy PTYs</a> so you need a recent l2tpd RPM version.<br>
</p>
<b>19.5.4 Mandrake 9.2<br>
</b>
<p>Mandrake 9.2 supports SuperFreeS/WAN out of the box which contains
the NAT-T patch for KLIPS. I suggest you do not use any older Mandrake
version than 9.2. Unfortunately the FreeS/WAN userland RPM included
with Mandrake 9.2 does not work. You will need the updated <a href="http://rpmfind.net/linux/rpm2html/search.php?query=super-freeswan&submit=Search+...&system=&arch=">

SuperFreeS/WAN 1.99.8 userland RPMs</a> made available by Mandrake
employee Florin Grad. Florin's RPMs do not contain two patches that are
required for NAT-T support in Transport Mode.
Those two patches need to be copied over to your RPM SOURCES directory.
The <a href="http://www.jacco2.dds.nl/networking/super-freeswan-ignoreTransportmodeNAT-risk.patch">first
patch</a> enables NAT-T support in Transport Mode (this is considered <a href="http://open-source.arkoon.net/freeswan/README.NAT-Traversal.0.6">unsafe</a>
by Mathieu Lafon). The <a href="http://www.advancevpn.com/public/super-freeswan-818043NATv3.patch">second
patch</a> (version 3) by <a href="http://lists.virus.org/freeswan-0309/msg00276.html">Mikael
L&ouml;nnroth</a> works around a problem with the NAT-T implementation
in Windows 2000/XP/Vista. The patch doesn't actually add support for
this
implementation, it is only a hack and probably a security risk. Then
you apply this <a href="http://www.jacco2.dds.nl/networking/patches/super-freeswan.mdk.spec.patch">diff</a>
against Florin's original SPEC file which ties the two patches into the
original SRPM. You can get the whole lot from me with this <a href="http://www.jacco2.dds.nl/networking/SRPMS/Mandrake/super-freeswan-1.99.8-7jdl.src.rpm">modified SRPM</a>
(<tt>super-freeswan-1.99.8-7jdl.src.rpm</tt>). Suggested build command:
<tt>rpmbuild
-ba super-freeswan.mdk.spec</tt>. Or, if you really want, you could
download the <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake9.2/super-freeswan-1.99.8-7jdl.i586.rpm">binary RPM</a>
(<tt>super-freeswan-1.99.8-7jdl.i586.rpm</tt>) and the <a href="http://www.jacco2.dds.nl/networking/RPMS/Mandrake9.2/super-freeswan-doc-1.99.8-7jdl.i586.rpm">documentation
RPM</a> (<tt>super-freeswan-doc-1.99.8-7jdl.i586.rpm</tt>) from my
webpage.<tt> </tt>You
may need to hold the 'Shift' key while clicking these links!<br>
</p>
<b>19.5.5 SuSE</b><br>
<p>SuSE 9.x uses kernel 2.6 so it supports NAT-T out of the box.
SuSE 9.2 ships with an Openswan 2.2.0 userland utilities RPM.
Alternatively, you can download Openswan RPMs for SuSE 9.x from the
<a href="http://www.openswan.org/download/binaries/Suse-RPMS/">Openswan
website</a>. Alternatively, SuSE employee <a href="http://www.suse.de/%7Egarloff/linux/FreeSWAN/">Kurt
Garloff</a> has made Openswan packages and KLIPS enabled kernels for
older SuSE versions.
</p>
<b>19.5.6 Debian<br>
</b>
<p>Debian uses kernel 2.4 with the backported NETKEY implementation. It
should work. <a href="http://packages.debian.org/unstable/net/openswan">Openswan
packages</a> are available.<br>
</p>
<p><b>19.5.7 Other distributions<br>
</b></p>
<p>See if there are any Openswan packages (kernel and userland
RPMs, deb, whatever) available. If none are available, you might
have to create them yourself but that may be a lot of work.<br>
</p>
<p><b>19.6 Procedure for enabling NAT-T (server not NATed)<br>
</b><br>
Once you have a kernel that supports NAT-T, you
can follow the procedure below to enable NAT-T. If your Openswan server
is behind NAT, see the <a href="#NATed-server">next section</a>. The
procedure assumes that your setup looks like this:<br>
</p>
<p><tt>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAT-&nbsp;
&nbsp; &nbsp; &nbsp; Internet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Openswan<br>
Client&nbsp; --------- device&nbsp; =================== Server ... <font color="#000099"><b>192.168.1.0/24</b></font>
<br>
192.168.0.2&nbsp;&nbsp;&nbsp; &nbsp; /&nbsp; &nbsp;&nbsp; \ &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp;&nbsp;
\<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.1.1 &nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp; </tt><tt><b>192.168.0.1/24</b> </tt><tt>&nbsp;
234.234.234.234&nbsp;&nbsp; 123.123.123.123
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</tt><br>
</p>
<p>The internal subnet behind your Openswan server is <font color="#000099"><b><tt>192.168.1.0/24</tt></b></font>. Note that
l2tpd.conf's <tt>local ip</tt> (and <tt>ip range</tt>) must be an IP
address (and subrange) within this internal network (in <a href="#l2tpd.conf">my example above</a> they are <tt>192.168.1.99</tt>
and <tt>192.168.1.128--192.168.1.254</tt>, respectively). The IP
address of the client is <tt>192.168.0.2</tt>. Often the NAT device
assigns this IP address to the client through DHCP. The client is on a
subnet behind the NAT device, in this example <b><tt>192.168.0.0/24</tt></b>.
Openswan needs
to
know what remote subnets the clients use. You specify these subnet(s)
with
the <tt>virtual_private=</tt> parameter in <tt>ipsec.conf</tt>. Most
people prefer to enumerate <em>all</em> network subnets that are
defined in <a href="http://www.ietf.org/rfc/rfc1918.txt">RFC 1918</a>
because there can be many clients with many different subnets. But of
course you can also specify only the <tt>192.168.0.0/24</tt> network
if there is only one client. You should however always exclude the
subnet(s) that are behind the Openswan server. An exclamation mark is
used for this purpose (see the example below). In this example we
assume that the internal IP address of the NAT device is <b><tt>192.168.0.1</tt></b>.
The
external (public) IP
address of the NAT device (in this case <tt>234.234.234.234</tt>) is
specified with the <tt>right=</tt>
parameter. For Road Warriors you would probably want to use <tt>right=%any</tt>
instead of <tt>right=234.234.234.234</tt>. The <tt>%no</tt>
option of the <tt>rightsubnet=</tt> parameter allows the same
configuration to be used for other clients that are not behind NAT. </p>
<p>The procedure is as follows:<br>
</p>
<ul>
  <li>Make sure that your clients support NAT-T. That often means they
will have to get the latest version or install an update (<a href="#NAT-status">see
above</a>).</li>
  <li>If a client is behind a NAT device (Sitecom, Netgear, etc.) which
supports IPsec
passthrough: change the configuration of that NAT device so that IPsec
passthrough is
disabled. (Note: Linksys and Draytek routers do require IPsec
passthrough to be enabled. In these routers "IPsec passthrough"
does not mean: "use the broken built-in IPsec passthrough support that
is incompatible
with NAT-T" but: "allow any and all IPsec packets through the device".)<br>
  </li>
  <li>Extend your existing ipsec.conf file with the following
parameters:<br>
    <br>
    <tt>&nbsp; config setup<br>
&nbsp;&nbsp;&nbsp; </tt><tt># ...Existing parameters<br>
&nbsp;&nbsp;&nbsp; </tt><tt>nat_traversal=yes<br>
&nbsp;&nbsp;&nbsp;
virtual_private=%v4:10.0.0.0/8,%v4:172.16.0.0/12,%v4:<b>192.168.0.0/16</b>,%v4:!<font color="#000099"><b>192.168.1.0/24</b></font><br>
    <br>
&nbsp; conn L2TP-CERT<br>
&nbsp;&nbsp;&nbsp; </tt><tt># ...Existing parameters<br>
    </tt><tt>&nbsp;&nbsp;&nbsp; left=123.123.123.123<br>
&nbsp;&nbsp;&nbsp; rightsubnet=vhost:%no,%priv<br>
    </tt><br>
  </li>
  <li>Restart Openswan.</li>
  <li>You should now be able to connect with a NATed client.</li>
</ul>
Note that <tt>192.168.0.0/24</tt>, the internal network of the NAT
device, is covered by the <tt>192.168.0.0/16</tt> of the <tt>virtual_private=</tt>
parameter. The <tt>nat_traversal, virtual_private </tt>and<tt> vhost</tt>
parameters listed above are implemented by the NAT-T patch (see <a href="http://open-source.arkoon.net/freeswan/README.NAT-Traversal.0.6">this
README</a> for a description of the parameters). That means they are
supported by all
versions of Openswan
and strongSwan on both KLIPS and NETKEY. They are also supported
on FreeS/WAN but only if you apply the NAT-T
patch. I am not sure why the <tt>rightsubnet=</tt> parameter is
required for NAT-T. Transport Mode uses host-to-host connections so in
reality
there are no subnets(!). Sam Sgro of the FreeS/WAN team discussed this
on the mailinglist and provided an <a href="http://lists.virus.org/freeswan-0402/msg00247.html">explanation</a>.<tt><br>
<br>
</tt>
<p><b><a name="serverNATed">19.7 Procedure for enabling NAT-T (server
NATed)</a><br>
</b></p>
<p><a name="NAT-OA-bug">If your Openswan server itself is behind NAT,
the procedure is slightly different.</a> You can use almost the same
setup as described in the previous section but it now looks
like this:<br>
</p>
<p><tt>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAT-&nbsp;
&nbsp; &nbsp; &nbsp; Internet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
NAT-<br>
Client&nbsp; --------- device&nbsp; =================== device
-------------+-------- ... <font color="#000099"><b>192.168.1.0/24</b></font>
<br>
192.168.0.2&nbsp;&nbsp;&nbsp; &nbsp; /&nbsp; &nbsp;&nbsp; \ &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; /&nbsp;&nbsp;&nbsp;&nbsp;
\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
|<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/&nbsp;&nbsp; 192.168.1.1 &nbsp; Openswan<br>
&nbsp;&nbsp;&nbsp;&nbsp; </tt><tt><b>192.168.0.1/24</b> </tt><tt>&nbsp;
234.234.234.234&nbsp;&nbsp; 123.123.123.123
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Server<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;&nbsp; 192.168.1.2</tt><br>
</p>
The Openswan server is now only connected to the internal network
behind the NAT device (<font color="#000099"><b><tt>192.168.1.0/24</tt></b></font>).
The diagram shows a NATed client but the procedure is also to be used
for non-NATed clients.
L2tpd.conf's <tt>local ip</tt> (and <tt>ip range</tt>) are still
required to be an IP address (and subrange) within this internal
network (in <a href="#l2tpd.conf">my example above</a> they are <tt>192.168.1.99</tt>
and <tt>192.168.1.128--192.168.1.254</tt>, respectively). The main
difference with the previous setup is that you need to add a
<tt>leftnexthop=</tt> parameter and that the <tt>left=</tt> parameter
is the IP address
of the Openswan server's network interface, not the public IP address
of the NAT device.<br>
<br>
The procedure is now as follows:<br>
<ul>
  <li>Use Openswan
2.4.5 or higher (or apply a <a href="#NATed-server">patch</a> if you
are using an older version).</li>
  <li>Make sure that your clients support NAT-T. That often means they
will have to get the latest version or install an update (<a href="#NAT-status">see
above</a>).</li>
  <li>If you have clients running XP with ServicePack 2, you need to <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#SP2">modify a registry setting</a> on
these XP SP2 clients. Windows Vista requires a similar <a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#NAT-T">registry modification</a>.<br>
  </li>
  <li>If a client is behind a NAT device (Sitecom, Netgear, etc.) which
supports IPsec
passthrough: change the configuration of that NAT device so that IPsec
passthrough is
disabled. (Note: Linksys and Draytek routers do require IPsec
passthrough to be enabled. In these routers "IPsec passthrough"
does not mean: "<i>use the broken built-in IPsec passthrough support
that
is incompatible
with NAT-T</i>" but rather: "<i>allow any and all IPsec packets through
the device</i>".)<br>
  </li>
  <li>Extend your existing ipsec.conf file with the following
parameters:<br>
    <br>
    <tt>&nbsp; config setup<br>
&nbsp;&nbsp;&nbsp; </tt><tt># </tt><tt>...Existing parameters</tt><br>
    <tt>&nbsp;&nbsp;&nbsp; </tt><tt>nat_traversal=yes<br>
&nbsp;&nbsp;&nbsp;
virtual_private=%v4:10.0.0.0/8,%v4:172.16.0.0/12,%v4:<b>192.168.0.0/16</b>,%v4:!<font color="#000099"><b>192.168.1.0/24</b></font><br>
    <br>
&nbsp; conn L2TP-CERT<br>
&nbsp;&nbsp;&nbsp; # ...Existing parameters<br>
&nbsp;&nbsp;&nbsp; left=192.168.1.2<br>
&nbsp;&nbsp;&nbsp; leftnexthop=</tt><tt>192.168.1.1<br>
    </tt><tt>&nbsp;&nbsp;&nbsp; rightsubnet=vhost:%no,%priv<br>
    </tt></li>
  <br>
  <li>Restart Openswan.</li>
  <li>You should now be able to connect with a NATed client.</li>
</ul>
<p></p>
<p><a name="NATed-server">W</a>ith older
Openswan versions there
is a <a href="http://bugs.xelerance.com/view.php?id=238&nbn=4">problem</a>
when the server itself is behind NAT (or when both the client and the
server are behind NAT). The Openswan team was notified of this problem
by <a href="http://lists.openswan.org/pipermail/users/2005-February/003927.html">Bernd
Galonska</a>. It has been fixed in Openswan 2.4.5 and higher. For older
versions
you can
download
Bernd's experimental patch from this webpage which I
have modified slightly so that it applies cleanly to <a href="http://www.jacco2.dds.nl/networking/patches/openswan-2.3.0-NATserver.patch">Openswan 2.3.0</a> and <a href="http://www.jacco2.dds.nl/networking/patches/openswan-2.3.1-NATserver.patch">2.3.1--2.4.4</a>
respectively.</p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="WindowsNetworking"></a><b>20. Windows Networking (WINS etc.)</b>
<p>In many cases VPNs are used to tunnel NetBIOS/SMB/CIFS network
traffic ("Windows Networking"). Unfortunately, Windows Networking is a
terrible protocol (ask the Samba guys) and it often results in all
kinds
of problems. This is not a tutorial on Windows Networking so I can't
help you with that. But I can provide some hints. </p>
<p>If you want to browse the Network Neighbourhood across subnets (this
includes WANs and VPNs), a WINS server is highly recommended. If you
don't have a Windows NT/2000/2003 server available or if you don't want
to
buy one, you can download <a href="http://www.samba.org/">Samba</a> and
configure it as a WINS server. The important part to remember is that <i>all</i>
computers should be configured to use this WINS server. Otherwise some
computers might have trouble seeing other computers.</p>
<p>I also noticed that for the best results all clients should be
configured to use the same workgroup/domain name, namely that of the
office network. Out of the box, many clients have a default
workgroup/domain name such as <tt>WORKGROUP</tt> or <tt>MSHOME</tt>
which is different from the office network's workgroup/domain name. It
is better to change these to a common name. Similar tips can be found
on
the <a href="http://www.tacteam.net/isaserverorg/vpnkitbeta2/vpnclientbrowsing.htm">ISA
Server.org</a> website.<br>
</p>
<p>The <a href="http://www.jacco2.dds.nl/networking/screenshots/psk/11logondomain.png">Microsoft</a> <a href="http://www.jacco2.dds.nl/networking/screenshots/msl2tp/31deselectprotocols.png">clients</a> have a
stetting "Log on to network". Enable this if you want to log on to a
domain server. </p>
<p>Note that <a href="http://www.microsoft.com/windowsxp/home/evaluation/overviews/xpindomain.asp">Windows
XP Home cannot join a domain</a>. This is also the case for some
versions of Windows Vista. You should be able to access
resources in the domain, however. </p>
<p>I have not really tried to get logon scripts (batch files) to work.
In theory it should work, since L2TP/IPsec is a Microsoft "approved"
protocol. Perhaps the following procedure works. At the end of the New
Connection Wizard, you are asked if this connection is for "Me only" or
for "Anyone who uses this computer". Select anyone. You might prefer
to not enter the password. The next time you logon, click the
"Options &gt;&gt;" button. You will notice that a checkbox "Logon
through Dial-up Networking" appears. Tick off this checkbox. Logon with
your Windows Networking username and password. You will be presented
with a window from which you can select the VPN connection that you
just
created. Select it and (hopefully) you will logon over the VPN
connection, and the logon script will start.<br>
</p>
<p> </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"> <br>
<a name="Splittunnelling"></a><b>21. Split tunnelling</b>
<p>If you have a VPN connection to the office, normally all packets
will be sent through the VPN tunnel. This includes not only traffic to
internal servers but also Internet traffic, for instance when you surf
to an Internet website. This has the disadvantage that the Internet
traffic goes through the office's Internet link twice: once from your
location to the office site and a second time from the office site to
the Internet. </p>
<p>If you use 'split tunnelling' on the other hand, all internal
traffic will be tunnelled through the VPN but all Internet traffic will
be sent to the Internet directly, i.e. not through the office Internet
connection. The problem is that this is less secure. Client users will
then have two connections at the same time: one to the office and one
to
the Internet. Hackers could in theory break into the user's home
machine
and access the office from there. With split tunnelling disabled, this
is more difficult to do. See also <a href="http://technet.microsoft.com/en-us/library/bb878117.aspx">this
Cable Guy</a> article on the Microsoft website for more information
about split tunnelling.<br>
</p>
<p>Here is how to enable split tunnelling:<br>
</p>
<ul>
  <li><a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Split_tunnelling">Windows 2000/XP</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#Split_tunnelling">Windows Vista</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/msl2tp.html#Split_tunnelling">The MSL2TP client</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html#Split_tunnelling">Mac OS X</a><br>
  </li>
  <li><a href="http://www.jacco2.dds.nl/networking/linux-l2tp.html#Split_tunnelling">Linux</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/l2tp3rdparty.html#Split_tunnelling">SSH Sentinel 1.4 or
higher</a></li>
</ul>
<p>Generally, I would recommend against enabling split tunnelling. You
gain a bit of extra bandwidth but you also introduce a security
problem.
If you are worried that users might secretly enable split tunnelling
without your permission, you could consider assigning "off-subnet"
virtual IP addresses to the VPN clients. This is not a water tight
solution but it would keep away most users. With off-subnet I mean that
the
virtual IP addresses (specified with l2tpd's "<tt>ip range</tt>"
parameter) are <i>not</i> within the internal subnet (<tt>192.168.1.0/24</tt>
in my example configuration files). You will have to do some extra
routing on the VPN server so that the client on the virtual IP subnet
can still reach resources on the internal subnet. Let's assume you have
configured off-subnet virtual IP addresses. So what happens when a user
connects? When the user has disabled split tunnelling, the default
route
will be to the VPN server. The user can access internal resources
because of the extra routing on the VPN server. Internet sites are also
routed through the VPN server and thus accessible. When the user has
enabled split tunnelling, however, things are a bit different. The VPN
client's default route will be to the Internet. So Internet sites will
be accessible. But resources on the internal subnet are not accessible.
The client has an off-subnet virtual IP address so packets to the
internal subnet will be sent to the default route (the Internet), not
to
the VPN server. If you use private non-routable IP addresses on your
internal subnet (following RFC 1918, e.g. <tt>192.168.1.0/24</tt>),
then the ISP will drop those packets. In other words, the VPN client
will not be able to access resources on the internal subnet when split
tunnelling is enabled, which was the whole objective. Unfortunately
this method can be circumvented by users who define a static route to
the internal subnet on their workstation. There is no cure for
negligent users, except not using a VPN at all...<br>
</p>
<p><a href="#Contents">Back to Contents</a> </p>
<hr width="100%"> <br>
<a name="Troubleshooting"></a><b>22.1 Troubleshooting</b>
<p>The very nature of a VPN makes it difficult to troubleshoot. VPN
servers
do not want to give away much information to a potential 'attacker' in
case of a problem. Packets may be silently dropped by the server. Error
messages sent to the client might not be very helpful. That said,
here are some tips in case of problems with your L2TP/IPsec connection.<br>
</p>
<p>

Use the command <tt>ipsec verify</tt>. Not every "[Failed]" error that
it reports
is a real problem but it can be helpful in certain circumstances.
If you don't use Opportunistic Encryption you should ignore the
error messages about missing reverse DNS entries, for instance.
</p>
<p>Sometimes the IPsec packets get blocked. For instance when there is
a too restrictive firewall on the route or when an ISP
actively
blocks VPN protocols. Verify with tcpdump that the IPsec packets (UDP
ports 500/4500 and IP protocol 50) actually arrive at your Linux
server.
You can also use Openswan's <tt>ipsec ikeping</tt> command for that.
Problems can be debugged by tracing packets layer by layer: </p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
tcpdump -n -i eth0 not port 22</tt> <br>
      <tt>tcpdump -n -i ipsec0 -s 1500</tt> <br>
      <tt>tcpdump -n -i ppp0 -s 1500</tt> <tt><br>
tcpdump -n -i eth1<br>
      <br>
      </tt></p>
      </td>
    </tr>
  </tbody>
</table>
<p><br>
Where <tt>eth0</tt> is the hostile network, <tt>ipsec0</tt> is
the
IPsec connection running over the hostile network (only if you use <a href="#Kerneltable">KLIPS</a>; if you use NETKEY there is no <tt>ipsec0</tt>),
<tt>ppp0</tt> is
the
L2TP/PPP connection through the IPsec tunnel, and <tt>eth1</tt> is the
internal network. If your network devices are named or numbered
differently, change
accordingly.<br>
</p>
<p>If you use KLIPS you should not see any unencrypted packets (e.g.
pure L2TP) on the <tt>eth0</tt>
interface. If you do see unencrypted packets with KLIPS, you don't have
a secure
VPN (make sure that the <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Installation">automatic
L2TP/IPsec policy</a> has been activated on the Windows client). But if
you use NETKEY there is no <tt>ipsec0</tt> interface. If you use
NETKEY and do a tcpdump on the external interface <tt>eth0</tt>, you
might
see
unencrypted packets in one direction. The best
(and authoritative) solution is to check with a third system between
the
client and the
server. If you sniff the communication between these two with run
tcpdump /Ethereal/etc. you should see encrypted packets all around.<br>
</p>
<p>Use ping to test the flow of packets:<br>
</p>
<table width="100%" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td valign="top" bgcolor="#cccccc">
      <p><tt><br>
ping &lt;external IP&gt;</tt> <br>
      <tt>ping &lt;internal IP &gt;</tt> <br>
      <tt>ping &lt;local ip in l2tpd.conf&gt;</tt> <br>
      <tt>ping &lt;any IP address on internal network&gt;<br>
      <br>
      </tt> </p>
      </td>
    </tr>
  </tbody>
</table>
<br>
<b>22.2 IPsec logging on the Linux server</b><br>
<p class="tightenable">Openswan logs its error messages to <tt>/var/log/secure</tt>.
There can be various reasons why you don't get a working IPsec
connection:<br>
</p>
<ul>
  <li>a firewall might be blocking packets somewhere (L2TP/IPsec
requires only UDP 500 and IP protocol 50, and UDP 4500 when NAT-T is
involved).<br>
  </li>
  <li>the server is not running or you typed a wrong IP address /
hostname.</li>
  <li>there is an authentication failure.</li>
  <li>there is a policy mismatch (the IPsec parameters in ipsec.conf
differ from what the client expects)</li>
  <li>there are Path
MTU issues<br>
  </li>
</ul>
<p>This <a href="http://wiki.openswan.org/index.php/Openswan/DebuggingTcpdump">Openswan
troubleshooting guide</a> by Michael Richardson may be of help,
although it assumes that the Openswan system is the initiator of the
connection (in most L2TP/IPsec cases it is the responder because a
Windows or Mac client is the initiator).<br>
<br>
You might be tempted to enable full Pluto debugging by adding <tt>plutodebug=all</tt>
to <tt>ipsec.conf</tt>.
This will force Pluto (the IKE daemon) to log in much more detail. In
most cases this should not be necessary because your problem is likely
to be caused by some configuration error. Only when there are serious
issues you may need to enable Pluto debugging. For example, when a
brand new version of Openswan or the Linux kernel has been released and
a problem was introduced in this version. Or when you want to
interoperate with an IPsec product that has not yet been tested with
Openswan. When you have such advanced implementation or
interoperability
problems, you may even have to enable KLIPS (kernel) debugging with <tt>klipsdebug=all</tt>.
This will also show packets silently dropped by the kernel. To activate
these changes Pluto will have to be restarted. More information can be
find in the <a href="http://www.freeswan.org/freeswan_snaps/CURRENT-SNAP/doc/trouble.html">FreeS/WAN
Troubleshooting Guide</a>. Do not use these settings in production
setups because they make it very easy for the bad guys to perform a
Denial Of Service.<br>
</p>
<p>If
you have got IPsec working but still you cannot log in, you might want
to have a look at the L2TP and PPP error messages. If the L2TP and/or
PPP phase fails, the IPsec connection will be terminated, eventually.
The PPP and L2TP error messages are typically
logged to <tt>/var/log/messages</tt>.
But not all debug messages are logged there. Mandrake logs verbose
debug messages to <tt>/var/log/daemons/*</tt>. For Red Hat you might
have to increase the debug level by editing <tt>/etc/syslogd.conf</tt>
and adding <tt>*.debug;</tt> to the line containing <tt>/var/log/messages</tt>.
Then you'll have to restart syslogd with <tt>service syslog restart</tt>.
On Debian/Ubuntu etc. you have to look in <tt>/var/log/debug</tt> for
L2TP messages and <tt>/var/log/auth.log</tt> for IPsec messages<tt>.</tt>
</p>
<p><a name="Gateway_not_reachable"></a><b>22.3 Gateway not reachable<br>
</b></p>
<p>You are using KLIPS and you get the following error:<tt><br>
</tt></p>
<p><tt>route-host output: /usr/lib/ipsec/_updown: doroute `ip route add
x.x.x.x/32 via x.x.x.x dev ipsec0 ' failed<br>
(RTNETLINK answers: Network is unreachable)</tt><b><br>
</b><br>
This means that the packets are not routed to the proper ipsecN
interface so they are not processed<br>
by KLIPS. This may be a bug which should be solved in Openswan 2.3.1+.
You can work around this problem by adding an extra parameter to the
Openswan configuration file, e.g.:</p>
<p><tt>conn L2TP-CERT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=rsasig<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pfs=no<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=123.123.123.123<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>leftnexthop=&lt;IP_address_of_your_gateway&gt;<br>
</b></tt><tt>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
leftrsasigkey=%cert<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
leftcert=/etc/ipsec.d/ssl/localCERT.pem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; etc.<b><br>
</b></tt></p>
There are no ipsecN interfaces if you are using NETKEY instead of
KLIPS.
So in theory the leftnexthop parameter would not work but I noticed
that I did have to use this leftnexthop= parameter when the Openswan
server was
behind NAT.<br>
<p><a name="Mars"></a><b>22.4 Mars Attacks!</b><br>
</p>
<p>If a tcpdump shows that the Linux server does not seem
to respond to packets from the Windows/Mac client, then
you might not have disabled Reverse Path filtering. If you see lines
like this in <tt>/var/log/messages</tt>:<tt><br>
</tt></p>
<p><tt>martian destination 127.0.0.1 from 192.168.0.222, dev ipsec0<br>
martian source 192.168.0.200 from 192.168.0.222, on dev eth0<br>
ll header: 00:00:00:00:00:00:00:40:33:2c:70:c8:08:00</tt><br>
</p>
<p>... then you need to clear <tt>rp_filter</tt>. If you scroll back
in <tt>/var/log/messages</tt>, you will see that FreeS/WAN had
complained about it (Openswan by default clears this parameter):<br>
</p>
<p><tt>ipsec_setup: (/proc/sys/net/ipv4/conf/eth0/rp_filter = `1',
should be 0)<br>
</tt></p>
<p>A quick <tt>echo 0 &gt; </tt><tt>/proc/sys/net/ipv4/conf/eth0/rp_filter</tt>
fixes the problem, if <tt>eth0</tt> is the device. Alternatively, you
could add <tt>net.ipv4.conf.default.rp_filter = 0</tt> <tt>to
/etc/sysctl.conf</tt>. Openswan supports the parameter <tt>rp_filter</tt>
in the <tt>config setup </tt>section of <tt>ipsec.conf</tt>.
Possible values are <tt>%unchanged</tt> (to leave it alone) or 0, 1,
2. It defaults to 0, i.e. disable for all interfaces used by Openswan.</p>
<a name="Windowsdebug"></a><b>22.5 Troubleshooting on the client
(Windows/Mac)</b><br>
<br>
Additionally, you can examine the IPsec and L2TP/PPP logs on the client
side. Note that I'm not
terribly impressed with the error messages in Windows. I find the debug
messages on the Linux side (Openswan, l2tpd, pppd) much more
informative.
<ul>
  <li><a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Windows_logs">Windows 2000/XP</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/vista-openswan.html#Windows_logs">Windows Vista</a></li>
  <li><a href="http://www.jacco2.dds.nl/networking/msl2tp.html#MSL2TP_logs">Microsoft L2TP/IPSec VPN Client</a>
(Windows 9x/NT/Me)</li>
  <li><a href="http://www.jacco2.dds.nl/networking/openswan-macosx.html#Troubleshooting">Mac OS X</a><br>
  </li>
</ul>
DNS problems are pretty common on VPNs. Here is a <a href="http://www.tacteam.net/isaserverorg/vpnkitbeta2/dnsvpn.htm">webpage</a>
with tips on resolving such issues.<br>
<br>
<b><a name="kernelL2TP">22.6 "This binary does not support kernel L2TP"</a></b><br>
<br>
When you use l2tpd you will see the message "<tt>This binary does not
support kernel L2TP</tt>" in <tt>/var/log/messages</tt>. This does not
indicate an error. It is just an informational message.
The original creators of l2tpd intended to implement support for both
user
mode and kernel mode L2TP. But they never got around to do kernel mode
L2TP.<br>
<br>
<b>22.7 PPP troubleshooting on Linux</b><br>
<br>
This is a bit outside the scope of this document. You can find some
great tips on this <a href="http://pptpclient.sourceforge.net/howto-diagnosis.phtml#running_pppd_before_connection">PPTP
troubleshooting page</a>.<br>
<br>
<a href="#Contents">Back to Contents</a> <br>
<hr width="100%"> <br>
<a name="Certificates"></a><b>23.1 Certificates</b>
<p>X.509 certificates can be used as an alternative to Preshared Keys.
As mentioned <a href="#InstallationIPsec">above</a>, certificates
require Strongsec's certificate patch. You will need to set up some
kind
of Public Key Infrastructure (PKI) for creating the private keys and
X.509 certificates for the Openswan host and the Windows IPsec
clients. </p>
<p>Don't forget to disable the PSK configuration files once you start
using certificates. Openswan will get confused if there are PSK and
certificate configuration files for the same client / IP address. The
PSK configuration will get the upper hand. If you do need certificates
and PSKs working at the same time for Road Warriors, check out the <a href="http://www.nthdegree.com.au/sverre/publications/141004.html">instructions
by Sverre Gunnersen</a>.<br>
</p>
<p><a href="http://www.openssl.org/">OpenSSL</a> is a popular choice
for
generating certificates because it is Open Source and freely available.
This page is not a tutorial
on using OpenSSL or certificates in general. Excellent documentation
on generating certificates is available elsewhere: </p>
<ul>
  <li> <a href="http://www.strongsec.com/freeswan/install.htm">Strongsec's
documentation</a>. This is the manual accompanying the X.509
certificate patch included with Openswan and strongSwan. (Unfortunately
not all X.509 certificate parameters are discussed in <tt>man
ipsec.conf</tt>. The Strongsec documentation is simply the definitive
guide for that).<br>
  </li>
  <li> <a href="http://www.natecarlson.com/linux/ipsec-l2tp.php">Nate
Carlson's webpage</a>. Information on using Windows 2000/XP with
Openswan with L2TP. Includes instructions on manually generating
certificates.</li>
  <li> The "<a href="http://www.cyprotect.com/ssh/sentinel/SSH-Sentinel-1.4-FreeSWAN.pdf">FreeS/WAN
IPSec Interoperability Guide</a>" by SSH Communications Security Corp.
It is geared towards usage with the SSH Sentinel client, but chapters
1.3-1.6 ("Setting up an OpenSSL CA") can be used for L2TP/IPsec
connections as well.</li>
</ul>
The thing to remember is that the X.509 support in Openswan and
strongSwan is very flexible. <a href="http://c2.com/cgi/wiki?ThereIsMoreThanOneWayToDoIt">There Is
More Than One Way To Do</a> certificates. For instance, you can use one
configuration file per client where each file has a different <tt>rightcert=</tt>
line. Or you could define only one configuration file which is used for
all clients where you specify the name of the CA with <tt>rightca=</tt>
(don't forget to issue CRLs for those certificates that are stolen or
lost). Wildcards are supported, Check out the Strongsec documentation
for all options.<br>
<br>
It is probably wise to avoid special characters in the certificates,
as <a href="http://lists.openswan.org/pipermail/users/2004-August/001904.html">this
example</a> shows.
Software such as <a href="http://www.openca.org/">OpenCA</a>, <a href="http://idx-pki.idealx.org/features.en.html">IDX-PKI</a> and <a href="http://tinyca.sm-zone.net/">TinyCA</a> (included in <a href="http://www.intrusion-lab.net/roca/">roCA</a>, a secure off-line
CA based on Knoppix) could be
useful when setting up a Certificate Authority. For more Open Source
CAs, see this <a href="http://www.nyetwork.org/wiki/SSL">Nyetwork Wiki</a>.
Alternatively, you
could
buy software which generates certificates for you. Windows NT/2000/2003
ships with Certificate Authority software. SSH sells <a href="http://www.ssh.com/products/security/certifier/">Certifier</a>,
an "PKI platform product for issuing and managing digital certificates
in a managed service provider and enterprise environment". There are
probably lots of other vendors, including Verisign and Baltimore.
<p>Either way, you will have to end up with certificates in PKCS#12
form. PKCS#12 is a <a href="http://www.rsasecurity.com/rsalabs/pkcs/pkcs-12/">standard</a>
for distributing keys and certificates. A PKCS#12 file with extension <tt>.p12</tt>.
or <tt>.pfx</tt> contains the client's private key, its corresponding
certificate and the root CA's certificate (possibly even a chain of CA
certificates). Since it contains the client's private key, the PKCS#12
file is encrypted with a password. Note that client certificates have
to
be signed by the <i>same</i> Certificate Authority (CA) as Openswan's
certificate! </p>
<p>You import certificates for L2TP/IPsec into Windows 2000/XP/Vista
using
the Microsoft Management Console (see <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html">these
instructions</a>). Windows 95/98/Me do not ship with
MMC.
Instead, you import the PKCS#12 file into Internet Explorer,&nbsp; or
to be
more precise, the certificate store found under "Tools -&gt; Internet
Options" (see <a href="http://www.jacco2.dds.nl/networking/msl2tp.html">these instructions</a>).</p>
<p><a name="EKU"></a>The CA included with Windows 2000/2003 Server
supports Extended Key
Usages properties (in ASN.1 Object Identifier notation) for
certificates. These EKUs restrict certificates so that they can only be
used for IPsec connections. Other uses (say, for a webserver) are not
allowed. This adds a little bit of extra security to the server's PKI.
If you use OpenSSL, you can probably create certificates with these EKU
properties too, but I haven't looked into it.<br>
</p>
<p>There has been a report to the Bugtraq mailinglist by Thor Lancelot
Simon about a <a href="http://www.sandelman.ottawa.on.ca/ipsec/2003/12/msg00015.html">potential
Man-in-the-Middle vulnerability</a> (<a href="http://www.vpnc.org/ietf-ipsec/03.ipsec/msg02502.html">mirror</a>)
with certain IPsec implementations.
If one client certificate is compromised (which is not too difficult: a
laptop can get stolen, for instance), it could be used by an attacker
to
masquerade as a server certificate to a second client. After all, the
compromised certificate of the first client is a valid certificate
issued by the CA. The issue is only true for Windows clients if no EKUs
are used. If you do use EKUs (as described above) then the issue is
mitigated. Windows Vista and Mac clients are also not vulnerable to
this issue because
they require the server's hostname or IP address in the certificate's
ID (can be disabled on Vista as an option).<br>
</p>
<p><b>23.2 Troubleshooting: Windows 2000/XP/Vista picks the wrong
certificate<br>
</b></p>
<p>Some people reported the following problem. They have a Windows
2000, XP or Vista client that should connect to 2 or more Openswan
L2TP/IPsec
servers that each have their own CA. Different certificates were
installed on the client. But when the client connects to a server, it
always presents the same certificate to the server. So the client can
connect correctly to one server but not to the other VPN server(s).
This is not what you want. The client should be able to connect to all
servers.</p>
<p>The short story is that adding <tt>rightca=%same</tt> to the
configuration should solve the problem. The long story is described <a href="http://www.jacco2.dds.nl/networking/win2000xp-openswan.html#Wrong_certificate">here</a>.<br>
</p>
<p><b><a name="Smartcards"></a>23.3 Certificates on smartcards,
two-factor authentication</b> </p>
<p>Certificates can be stored on smartcards (including USB tokens) for
extra security. I have tested this with the MSL2TP client and it works.
When I started the connection, it asked for the PIN number of my IKey
2032 token and only then the connection was set up. SSH Sentinel should
work too (it comes with a separate smartcard application called
Accession Lite) but I had a bit of a fight with the IKey driver.<br>
</p>
<p>Using
smartcards with the built-in IPsec client of Windows 2000/XP/Vista may
be a
problem. Microsoft
distinguishes between 'machine certificates' and 'user
certificates'. A machine certificate is only used for IPsec and cannot
be installed on a smartcard or token (as mentioned above). A user
certificate on the other hand is used in the PPP phase when EAP
authentication is
selected. I could not find a way to store the 'machine certificate'
(also called 'local computer
certificate') on my USB token. Please correct me if I am wrong!
According
to the Microsoft documentation, it is possible to specify a different
CSP (Cryptographic Service Provider), such as the one supplied with
your
smartcard/USB token, but only when you apply for the certificate
through
the web interface ("web enrolment"). Not when you import your
certificate through a file in PKCS#12 format.<br>
</p>
<p>So if you want to users to authenticate with certificates using the
built-in Windows L2TP/IPsec client, you will need a Linux PPP server
with EAP support (or a PPP server
with a RADIUS plugin so that it can authenticate against a RADIUS
server through EAP-TLS). This is outside the scope of this webpage, but
<a href="http://www.freeradius.org/">FreeRADIUS</a> should be able to
do this. Check out the <a href="http://www.freeradius.org/doc/EAPTLS.pdf">EAP-TLS support</a> in
FreeRADIUS. An <a href="http://www.samba.org/cgi-bin/ppp-bugs/trashcan?id=1109;expression=heiart;user=guest">extension
for the pppd RADIUS plugin</a> by Michael Heiart may also be needed.
An alternative is to switch to a third-party Windows IPsec client with
smartcard support such as SSH Sentinel. </p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr size="2" width="100%"><b><br>
<a name="Wireless"></a>24. Protecting
wireless connections</b><br>
<br>
Here are some thoughts on using L2TP/IPsec over wireless connections.<br>
<br>
The WEP encryption algorithm, which is part of the wireless 802.11
standard (WiFi), is <a href="http://www.isaac.cs.berkeley.edu/isaac/wep-faq.html">completely
broken</a>. Any scriptkiddie can crack WEP passwords in a couple of
minutes with tools such as
<a href="http://www.remote-exploit.org/backtrack.html">Backtrack</a> or
<a href="http://airsnort.shmoo.com/">Airsnort</a>. Another problem is
that
distributing
WEP keys does not scale well if you have more than only a couple of
users.
Most wireless access points have additional security measure (such as
SSID authentication, disabling SSID broadcast and access controls based
on MAC addresses)
but these are also <a href="http://www.netcraftsmen.net/welcher/papers/wireless02.html">weak</a>.
They are easily circumvented with tools such as Airsnort or <a href="http://www.kismetwireless.net/">Kismet</a>. WPA and WPA2 are
alternatives but some people have
suggested to use VPN protocol such as IPsec or PPTP instead.
These protocols have been around for a while and their security is
well understood. It is clear that you should not rely on WEP alone.<br>
<br>
The problem with running a VPN over wireless links is that the bad guys
are not prevented from having access to your wireless network. They can
still do nasty things such as attacking your access points or your
wireless clients. If a user workstation has not been secured, it could
get exploited by a hacker or a virus through the wireless link. For
instance, the workstation might have open ports, File and Print Sharing
has not been disabled, no personal firewall has been installed or
security patches are missing. WEP and its stronger counterparts such as
WPA, 802.1x, EAP/PEAP and WAP2 / 802.11x prevent people from joining
your
wireless network if they do not have the proper credentials. Microsoft
is actively <a href="http://www.theregister.co.uk/content/4/26188.html">pushing
PEAP</a> for wireless networks in Windows XP/Vista/2003. So if you are
not
using a good wireless security protocol (WEP doesn't count), it is
probably wise to at least install a personal firewall and possibly
anti-virus software on the client workstations.<br>
<br>
IPsec supports both <a href="#PSKs">Preshared Keys</a> and <a href="#Certificates">certificates</a>. PSKs are easier to use if the
number of users is small but they have the disadvantage that users must
have fixed (static) IP addresses. Fortunately, fixed addresses from
the <a href="http://www.ietf.org/rfc/rfc1918.txt">RFC 1918 ranges</a>
(<tt>192.168.x.x</tt>, <tt>10.x.x.x</tt> etc) can often be assigned
to wireless users. With one exception: it will not work
under Windows 2000 when the 'New Connection Wizard' is used, because
this Wizard does not support PSKs.<br>
<br>
Another thing to watch out for is that if the VPN connection is down,
clients should obviously not be able to access your protected network.
This sounds silly but if you have IP forwarding set to on, packets from
the wireless net will be happily forwarded to your internal network. Be
sure to firewall the wireless network, or to configure IP forwarding
for
only the internal addresses.<br>
<br>
Roaming from one access point to another access point is currently a
problem with wireless networks based on the 802.11 standard. If I'm not
mistaken the wireless link gets disconnected. This means that the IPsec
connection will get disconnected as well, because the new access point
may hand out a new IP address. There are however provisions in the L2TP
standard that should help to reconnect fast, but I don't know if it
works
with Openswan and l2tpd.<br>
<br>
An initial test on a wireless network did not show more <a href="#MTUproblems">MTU size problems</a> than usual (i.e. with
Ethernet). A complication might be that the built-in L2TP/IPsec client
might
have trouble recovering from lost packets if the link quality is bad (I
have not tested this yet).<br>
<br>
Students from Stuttgart, Germany are using L2TP/IPsec on a wireless
network in their dorm using a Linksys WRT54g router and a central
FreeS/WAN server authenticating through FreeRADIUS: <a href="http://www.wh-netz.de/verein/projekte/WH-Funk">the WH-Funk
project</a>.<br>
<br>
<a href="#Contents">Back to Contents</a> <br>
<hr size="2" width="100%"><br>
<b>25. Other topics</b><br>
<br>
<a name="Client"></a><b><a name="L2TP_client"></a></b><b>25.1
Linux as an
L2TP/IPsec client</b><br>
<br>
This section has been moved to a <a href="http://www.jacco2.dds.nl/networking/linux-l2tp.html">separate
page</a>.<b><br>
</b><br>
<b><a name="DPD"></a>25.2 Dead Pear Detection</b><br>
<br>
Dead Peer Detection (DPD) is an IPsec feature described in <a href="http://tools.ietf.org/html/rfc3706">RFC 3706</a>. If client and
server agree on the use of DPD they send keep-alive packets through the
IPsec connection. This allows them to determine whether the remote peer
is still responding or not. Connections that are determined to be dead
(DPD speeds this up) will be deleted, allowing resources to be
reclaimed.<br>
<br>
DPD is mainly supported by Openswan, Strongswan, Mac OS X 10.5
"Leopard" and
Cisco. None of the
L2TP/IPsec clients for Windows support DPD, nor do Mac OS X 10.3 and
10.4, so normally it
would be useless to add to your Linux VPN server configuration.
However, if you also want to support Mac OS 10.5 and Linux clients DPD
may be of use.
On the Linux server you add the following parameters to your 'conn'
section:<br>
<blockquote><tt>conn L2TP-PSK<br>
&nbsp; dpddelay=40</tt><br>
  <tt>&nbsp; dpdtimeout=130</tt><br>
  <tt>&nbsp; dpdaction=clear</tt><br>
</blockquote>
The values 40 and 130 are provided as an example. On Linux clients you
add the following parameters (i.e. both peers must have them and it is
recommended to use slightly different values, as to avoid starting DPD
negotiations from both sides at the same time):<br>
<blockquote><tt>conn L2TP-PSK-CLIENT<br>
&nbsp; dpddelay=30</tt><br>
  <tt>&nbsp; dpdtimeout=120</tt><br>
  <tt>&nbsp; dpdaction=clear</tt><br>
</blockquote>
Both L2TP and PPP also have some form of keep-alive mechanism. L2TP
sends "Hello" control messages to keep the link alive (these show up as
"<tt>check_control: control, cid = 0, Ns = 4, Nr = 17</tt>" in the
l2tpd logs). The <a href="http://en.wikipedia.org/wiki/Link_Control_Protocol">Link Control
Protocol</a> in PPP also has a keep-alive mechanism (LCP EchoReq and
EchoRep). This option is enabled by default in pppd (see "man pppd"). I
suspect that Windows and Mac clients use these keep-alive mechanism to
their benefit but the Linux side does not, because there is no
interaction between the IPsec daemon and the L2TP/PPP daemons.<br>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"><br>
<a name="Speculation"></a><b>26. This is purely
speculation, but...</b>
<p>Could Microsoft also be trying to commoditise the IPsec protocol,
while extending/embracing the (Microsoft/Cisco co-developed) L2TP
protocol? Microsoft likes to write about L2TP as if it were a VPN
protocol. For instance <a href="http://www.microsoft.com/technet/itcommunity/chats/trans/isa/isa0129.asp">here</a>:
"<i><b>Q.</b> Do I want to use PPTP or L2TP? <b>A.</b> L2TP is
considered more secured than PPTP and will allow you interoperability
with 3rd parties</i>". What they mean with 'L2TP' is actually
'L2TP/IPsec'. It is IPsec that provides the confidentiality and
authentication in L2TP/IPsec connections. They seem to be shifting
public attention from IPsec (several implementations by multiple
vendors) to L2TP (not that many products available). Another thing is
that <a href="http://www.nwfusion.com/news/2000/0110vpn.html">not
everyone is happy with L2TP</a>. It results in 'double tunnelling'
(extra overhead) and might very well be only a vehicle for doing extra
authentication (of course, preferably against an NT SAM user database,
which means buying more Windows client access licences). <br>
</p>
<p>I am a bit puzzled why Microsoft released the MSL2TP client. They
have recently stopped support for 'old' Windows versions, and here they
are releasing software which runs even on Windows 95. Interesting also
is that SafeNet is eating into its own third-party Windows IPsec client
market, to some extent, by releasing the free MSL2TP client. Why would
they do this? An offer by Microsoft "<a href="http://imdb.com/Quotes?0068646">they could not not refuse</a>"?</p>
<p>I would also like to make the following observation. The MSL2TP
client was developed for Microsoft by SafeNet. The IKE/IPsec support in
Windows 2000/XP and Pocket PC was "jointly developed with Cisco".
It appears that IPsec is not a high enough priority for Microsoft to do
all development in-house...</p>
<p><a href="#Contents">Back to Contents</a> <br>
</p>
<hr width="100%"><br>
<b><a name="Links"></a>27. Related links</b><br>
<ul>
  <li>An '<a href="http://www.natecarlson.com/linux/ipsec-l2tp.php">executive
summary</a>' of this page has been made by Nate Carlson.</li>
  <li><a href="http://mia.ece.uic.edu/%7Epapers/volans/l2tpd.html">l2tpd
example configuration</a> (without IPsec) by Shashank Khanvilkar.</li>
  <li><a href="http://www.funknet.org/doc/tunnel/l2tp.xml">IPSec/L2TP
Tunnelling with Linux-2.6 and Racoon</a> by Chris Andrews.</li>
  <li>Howto for a <a href="http://www.wogri.at/linux/ipsec/">VPN
solution based on Linux 2.6 and Openswan/Racoon</a> by Wolfgang
Hennerbichler.</li>
  <li><a href="http://megaz.arbuz.com/2005/01/28/linux-vpn-guide">VPN
guide</a>
by Nasim Mansurov.</li>
  <li><a href="http://scope.dghartung.com/index.php/VPN">Howto for
Fedora</a> with Strongswan by Dale Hartung.</li>
</ul>
<a href="#Contents">Back to Contents</a><br>
<br>
<hr size="2" width="100%"><b><br>
<a name="Acknowledgements_and_disclaimer"></a>28.
Acknowledgements and disclaimer</b><br>
<br>
Here are some messages by my crack team of lawyers. Openswan is a
trademark by <a href="http://www.xelerance.com/">Xelerance</a>.
The Openswan logo was designed by Nana Manojlovic. Windows is a
registered trademark of Microsoft Corporation in the United States and
other countries. Apple Macintosh is a trademark of Apple Computer,
Inc., registered in the U.S. and other countries. All other trademarks
are the property of their respective owners. These pages do not express
or imply affiliation, sponsorship, endorsement, certification, or
approval by any company.<br>
<br>
<a href="#Contents">Back to Contents</a><br>
<br>
<hr size="2" width="100%"><br>
<a name="Revisionhistory"></a><b>29. Revision
history</b>
<p><i>Apr 7, 2008:</i> Openswan L2TP/IPsec setup available on OpenL2TP
website.<i><br>
Mar 12, 2008:</i> Added remarks about DHCP Inform.<br>
<i>Jun 27, 2007:</i> Apple iPhone ships with L2TP/IPsec client.<br>
<i>Jun 2, 2007:</i> Stinghorn no longer available?<br>
<i>Dec 27, 2006:</i> Added info on OpenL2TP, with thanks to James
Chapman.<br>
<i>Nov 22, 2006:</i> Moved Linux as an L2TP/IPsec client to a <a href="http://www.jacco2.dds.nl/networking/linux-l2tp.html">separate page</a>.<br>
<i>Nov 9, 2006:</i> Vista NAT-T issue resolved.<br>
<i>Nov 5, 2006:</i> Added page for Windows Vista.<br>
<i>Jan 7, 2006:</i> Added link to Xelerance's xl2tpd.<br>
<i>Dec 6, 2005:</i> Updated info on Linux as an L2TP/IPsec client.<br>
<i>Nov 15, 2005:</i> Updated sample Openswan configuration files (<tt>rekey=no</tt>
etc.)<br>
<i>Nov 15, 2005:</i> Openswan 2.4.2 partially supports NATed Mac
clients.<i><br>
Jul 6, 2005:</i> <a href="http://www.theregister.co.uk/2005/07/06/eu_bins_swpat/">EU
Parliament rejects software patents</a>! (For now, at least).<br>
<i>Jun 25, 2005:</i> Uploaded <a href="#download_l2tpd">l2tpd-0.69-12jdl</a>
(S)RPM that compiles and works on for FC4. Added ppp <a href="#ppp_unit">'unit' info</a>.<br>
<i>Jun 14, 2005:</i> Added reference to the <a href="http://www.securepoint.cc/en/products-vpn.html">Securepoint
Personal Firewall & VPN Client</a>.<br>
<i>Jun 2, 2005:</i> I consider removing support for ancient versions
such as Mandrake 9.1 and older.<br>
<i>May 31, 2005:</i> l2tpd is now in maintenance mode. The l2tpd.org
domain has been hijacked. Website has <a href="http://l2tpd.sourceforge.net/">moved</a>.<br>
<i>May 3, 2005:</i> Mac OS X v10.4 ("Tiger") Client and Server
support certificates for L2TP/IPsec but I have not read reports of
anyone using this method successfully.<i><br>
</i><i>Mar 17, 2005:</i> Uploaded <a href="#download_l2tpd">l2tpd-0.69-11jdl</a>
RPMS for FC2/3 and MDK10.1. These contain <a href="#Legacy_pty_problem">Unix98
pty support</a>.<br>
<i>Mar 17, 2005:</i> Uploaded experimental patch to fix <a href="#NAT-OA-bug">server-side NAT-OA bug</a>.<br>
<i>Mar 16, 2005:</i> Found out about another L2TP server, <a href="http://l2tpns.sourceforge.net/">l2tpns</a>.<br>
<i>Jan 21, 2005:</i> Nate Carlson has made an <a href="http://www.natecarlson.com/linux/ipsec-l2tp.php">L2TP/IPsec Howto</a>.<br>
<i>Jan 8, 2005:</i> NAT-T standard approved by the IETF as RFC 3947.<i><br>
</i><i>[<a href="http://www.jacco2.dds.nl/networking/oldhistory.html">Old revision history</a>]</i><br>
<i>July 20, 2002</i>: Added report of preliminary l2tpd success. <br>
<i>July 15, 2002</i>: Changed &lt;h4&gt; headings since Opera does not
display them. Added PSK remarks. </p>
<p><a href="http://www.jacco2.dds.nl/contact/index.html">Jacco de Leeuw</a>
<br>
</p>
</body>
</html>
